<script>


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        document.getElementById("myBtn").style.display = "block";
    } else {
        document.getElementById("myBtn").style.display = "none";
    }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}

$('#save_sheet_btn').on('click',function(e){
var id=$('#mysheet').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(stockCheck).QTYInport(id);

});

$('#save_sheet_btn2').on('click',function(e){
var id=$('#mysheet2').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).createRefferenceDB(id);

});


$('#save_sheet_btn3').on('click',function(e){
var id=$('#mysheet3').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importRecipesFromSheet(id);

});
$('#save_sheet_btn4').on('click',function(e){
var id=$('#mysheet4').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importBoxesFromSheet(id);

});
$('#save_sheet_btn5').on('click',function(e){
var id=$('#mysheet5').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importPackagesFromSheet(id);

});

$('#save_sheet_btn6').on('click',function(e){
var id=$('#mysheet6').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importCustomersFromSheet(id);

});

$('#save_sheet_btn7').on('click',function(e){
var id=$('#mysheet7').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importBrandsFromSheet(id);

});

$('#save_sheet_btn8').on('click',function(e){
var id=$('#mysheet8').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importFlavoursFromSheet(id);

});

$('#save_sheet_btn9').on('click',function(e){
var id=$('#mysheet9').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importBottlesFromSheet(id);

});

$('#save_sheet_btn10').on('click',function(e){
var id=$('#mysheet10').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importLidsFromSheet(id);

});

$('#save_sheet_btn11').on('click',function(e){
var id=$('#mysheet11').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importLabelsFromSheet(id);

});
$('#save_sheet_btn12').on('click',function(e){
var id=$('#mysheet12').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importColorsFromSheet(id);

});
$('#save_sheet_btn13').on('click',function(e){
var id=$('#mysheet13').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(checkProccessStatus).importBlankPCPC2(id);

});

$('#save_sheet_btn14').on('click',function(e){
var id=$('#mysheet14').val();
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).importInventoryData(id);

});
function save(msg){
msg=msg.replace(/<br\/?>/gi,'\n');
 $("#updating").css("display", "none");

  
alert(msg);
 
}

$('#savepoint').on('click',function(e){
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(save).savePoint();


});

$('#restorepoint').on('click',function(e){
   $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(restore).restorePoint();

});
function restore(){
alert('Restored. Please refresh the page.');
}
var thisData;
var thisPage;
function deleteAll(){
var ms="WARNING! You are about to delete all displayed orders. \n Are you sure?";
var r = confirm(ms);
if (r == true) {
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(exportSuccess).deleteAll(thisData,thisPage);

}

}



var SelAllOrders;
function selectAll(){
for(var i=0;i<SelAllOrders.length;i++){
    
    
     addToSelected(SelAllOrders[i].batch);
    
  }

}
var exportArr=[];
$('.form-check-input').change(function(e) {
var page=$(this).attr('page');
if(page=='ALLPAGES'){
     $(".form-check-input").prop('checked', $(this).prop('checked'));
}
});

$('#subExportForm').on('click',function(e) {
 var checkboxes = document.getElementsByName('expCheckbox');
  var checkboxesChecked = [];
  // loop over them all
  for (var i=0; i<checkboxes.length; i++) {
     // And stick the checked ones onto an array...
     if (checkboxes[i].checked) {
        checkboxesChecked.push(checkboxes[i].getAttribute("page"));
     }
  }
console.log(checkboxesChecked);
 google.script.run.withSuccessHandler(exportSuccess).export(checkboxesChecked);
});
function exportSuccess(msg){
 $("#updating").css("display", "none");
alert(msg);
$('#funcBody').html(msg);
}

//SUB TABS

$("#notRunDiv").click(function() {

$(".panelItem").css("background-color", "#f4f7f8");
$(".panelItem").css("color", "black");


$("#notRunDiv").css("background-color", "#195685");
$("#notRunDiv").css("color", "#FFF");

filterpage();
});


//THREE SUB TABS
var BASEPARAM={
orderBy : 'final_status',
equalTo: 'Not Run'

};


function getBaseSearchParam(event){

var param=$(event).attr('param');

BASEPARAM.equalTo=param;

}

 var ACTIVETABS=['Orders','FlavourMixOrders','Mixing','MixingTeam','FlavourMixMixingTeam','PremixColoring','Production','Printing','Labelling','Packaging'];
function hideDiv(){
if(selPage=='Orders'){
$("#wentNegative").show();
$("#ordersSubTab").show();

}else if(selPage=='FlavourMixOrders'){
$("#ordersSubTab").show();

}else{
$("#wentNegative").hide();
$("#ordersSubTab").hide();


}
console.log('selPage',selPage);
if(ACTIVETABS.indexOf(selPage)==-1){
$("#baseFilters").hide();
}else{
$("#baseFilters").show();
}

}
var SEARCHNUM = 0;
//Form
getSearchBoxData('Orders');
thisPage = 'Orders';
var qtySheet = "#Misc";
//Tabs
var subtabChange = false;
var app = 'Admin';
//   populateOrdersTab();
var selPage = 'Orders';
google.script.run.withSuccessHandler(logSuccess).logUser(selPage, app);
filterpage('xx', true);

$('.tabs .tab-links a').on('click', function(e) {
    $("#subTabFlavourMixOrders").removeClass('active');
    $('.content').html('');
    $('.modal-body').html('');
    var subtab = $(this).attr('sub');
    pagesSplit = false;
    $("#scheduleOptions").hide();
    console.log('h1');
    if (subtab == 'sub') {
        console.log('h2');
        $(this).parent('li').addClass('active').siblings().removeClass('active');
        if ($(this).attr('id') == 'scheduled') {
            console.log('h3');
            $("#scheduleOptions").show();
            google.script.run.withSuccessHandler(setScheduleDropdown).getScheduleDropdown();
        } else {
            console.log('h4');
            var param = $(this).attr('param');
            BASEPARAM.equalTo=param;
            filterpage('xx', true);
        }
    } else if (subtab == 'subOrder') {
        var page = $(this).attr('page');
        thisPage = page;
        selPage = page;
        filterpage('xx', true);
        $("#subTabFlavourMixOrders").addClass('active');
    } else {
        var currentAttrValue = $(this).attr('href');
        // Show/Hide Tabs
        $('.tabs ' + currentAttrValue).show().siblings().hide();
        $(this).parent('li').addClass('active').siblings().removeClass('active');
        populateSheet(currentAttrValue);
        // Change/remove current tab to active
    }
    hideDiv();
    e.preventDefault();
    e.stopPropagation();
});
    
    var activetab='#tab1';
    function populateSheet(current) {
    activetab=current;
    if (current == '#tab1') {
//    populateOrdersTab();
    getSearchBoxData('Orders');
    SELECTED=[];
    selPage='Orders';

    displaySelected(SELECTED);
    
    } else if (current == '#tab2') {
  //  populateMixingTab();
     selPage='Mixing';
    // getSearchBoxData('Mixing');
    } else if (current == '#tab3') {
   // populateProductionTab();
    SELECTED=[];
    selPage='Production';
    displaySelected(SELECTED);
    getSearchBoxData('Production');
    } else if (current == '#tab4') {
   // populatePrintingTab();
    selPage='Printing';
    getSearchBoxData('Printing');
    } else if (current == '#tab5') {
   // populateLabellingTab();
    selPage='Labelling';
    getSearchBoxData('Labelling');
    } else if (current == '#tab6') {
   // populatePackagingTab();
    SELECTED=[];
    selPage='Packaging';
    displaySelected(SELECTED);
    getSearchBoxData('Packaging');
    } else if (current == '#tab7') {
         selPage='Shipping';
    //populateShippingTab();
    getSearchBoxData('Shipping');
   
    } else if (current == '#tab8') {
    populateLocationsTab();
        selPage='Locations';
    } else if (current == '#tab9') {
    populateQTYTab(qtySheet.substr(1, qtySheet.length));
        selPage='QTY';
    //google.script.run.withSuccessHandler(splitPages).getQTY('Misc');
    } else if (current == '#tab10') {
    populateInventoryTab();
        selPage='Inventory';
    } else if (current == '#tab11') {
   
        selPage='Finctions';
    }
  hideDiv();
      google.script.run.withSuccessHandler(logSuccess).logUser(selPage,app);  
       filterpage('xx',true);
    
    
    }
    //Tabs2

    
     function logSuccess(){
 console.log('User Logged.');
 } 
    //Tabs
  
    $('.tabs2 .tab-links2 a').on('click', function(e) {
       
        var currentAttrValue2 = $(this).attr('href');
        qtySheet=currentAttrValue2;
        // Show/Hide Tabs
        //  $('.tabs2 ' + currentAttrValue).show().siblings().hide();
        $(this).parent('li').addClass('active').siblings().removeClass('active');
        e.preventDefault();
        
        e.stopPropagation();
        console.log(qtySheet);
        populateQTYTab(qtySheet.substr(1, qtySheet.length));
        // Change/remove current tab to active





    });

    //Tabs
    var MixSheet="#Mixing";
    $('.tabs3 .tab-links3 a').on('click', function(e) {
        console.log('BASEPARAM',BASEPARAM);
        var currentAttrValue3 = $(this).attr('href');
        MixSheet=currentAttrValue3;
        // Show/Hide Tabs
        //  $('.tabs2 ' + currentAttrValue).show().siblings().hide();
        $(this).parent('li').addClass('active').siblings().removeClass('active');
        e.preventDefault();
        e.stopPropagation();
        console.log(currentAttrValue3);
        if(currentAttrValue3=='#Mixing'){
        selPage='Mixing';
        filterpage('xx',true);
        //  populateMixingTab();
        
        }else if(currentAttrValue3=='#MixingTeam'){
          
        selPage='MixingTeam'; 
        filterpage('xx',true);
        
        
        }else if(currentAttrValue3=='#FlavourMixMixingTeam'){
        
        selPage='FlavourMixMixingTeam'; 
        filterpage('xx',true);
        //  populateMixingTeamTab();
        }else if(currentAttrValue3=='#PremixColoring'){
        
        selPage='PremixColoring'; 
        filterpage('xx',true);
        //  populateMixingTeamTab();
        }
   
        // Change/remove current tab to active




    });


    $('#neworder').on('click', function(e) {
       $('.modal-body').html('');
       $('#subModalForm').hide();
       $('#subflavourmixFormOrder').hide();
        $("#updating").hide();
        //google.script.run.withSuccessHandler(buildForm).getFormData();
    });
    $('#newOrder').on('click', function(e) {
    $('.modal-body').html('');
     $("#updating").show();
    google.script.run.withSuccessHandler(buildForm).getFormData();
    

    });
    $('#newflavourmixOrder').on('click', function(e) {
    $('.modal-body').html('');
     $("#updating").show();
   google.script.run.withSuccessHandler(buildFormFlavourMix).getFlavourMixes();

    });
    function clearLastPage(){
    var inmix=thisPage.match('Mixing');
      if(inmix!=-1){
        $('#Mixing').html('');
      }else if(thisPage=='Orders'){
        $('#pageBody').html('');
      }else{
        $('#'+thisPage).html('');
      }
      console.log('Cleared '+thisPage)
    
    }
function pcselect(){
var PC=$("#PCSelect").val();
console.log('changed');
console.log('PC');
google.script.run.withSuccessHandler(repopFORM).getPCSelect(PC);
}
function pdselect(){
var PD=$("#PDDSelect").val();
console.log(PD);
google.script.run.withSuccessHandler(repopFORM).getPDSelect(PD);
}
function repopFORM(data){
console.log(data);
$("#PCSelect").val(data.prod);
$("#PDDSelect").val(data.descr);
$("#recipeSelect").val(data.recipe.id);
$("#brandSelect").val(data.brandSKU);
$("#flavourSelect").val(data.flavour.sku);
$("#bottleType").val(data.botSKU);
$("#lidType").val(data.lidSKU);
$("#packagingType").val(data.packagingType.sku);


  $("#updating").hide();

}
var edit_flavour_mix_order=false;
function buildFormFlavourMix(data){
$('#subModalForm').hide();
$('#subflavourmixFormOrder').show();
var html='';
var flavourSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.length; i++) {
flavourSelect += '<option value="' + data[i].sku + '">' + data[i].name+ '<option>';
}
html+='<table class="table"><thead><tr><th>Order Date</th><th>Batch</th><th>Mix</th><th>Stocking Amount</th></tr></thead><tbody>'
html+='<tr>';
html += '<td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch" aria-describedby="sizing-addon2"></div></td>';
html += '<td><select class="form-control" id="flavourmixSelect">' + flavourSelect + '</select></td>';
html += '<td><div class="input-group"><input type="text" id="stocking" class="form-control" placeholder="Stocking Amount (litre)" aria-describedby="sizing-addon2"></div></td>';

html+='</tr></tbody></table>'
$('.modal-body').html(html);
 $("#updating").hide();
edit_flavour_mix_order=false;
}

function buildFormFlavourMixExisting(ret){
var data=ret[0];
var oldData=ret[1];
$('#subModalForm').hide();
$('#subflavourmixFormOrder').show();
var html='';
var flavourSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.length; i++) {
flavourSelect += '<option value="' + data[i].sku + '">' + data[i].name+ '<option>';
}
html+='<table class="table"><thead><tr><th>Order Date</th><th>Batch</th><th>Mix</th><th>Stocking Amount</th></tr></thead><tbody>'
html+='<tr>';
html += '<td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch" disabled aria-describedby="sizing-addon2"></div></td>';
html += '<td><select class="form-control" id="flavourmixSelect">' + flavourSelect + '</select></td>';
html += '<td><div class="input-group"><input type="text" id="stocking" class="form-control" placeholder="Stocking Amount (litre)" aria-describedby="sizing-addon2"></div></td>';

html+='</tr></tbody></table>'
$('.modal-body').html(html);

$('#orderDate').val(formatDateInput(oldData.orderdate));
$('#orderbatch').val(oldData.batch);
$('#flavourmixSelect').val(oldData.flavourmix.sku);
$('#stocking').val(oldData.stocking);
 $("#updating").hide();
edit_flavour_mix_order=true;

}

 $('#subflavourmixFormOrder').on('click', function(e) {
 var obj={
 batch:$('#orderbatch').val(),
 orderdate:$('#orderDate').val(),
 flavourmix:{
 name: $('#flavourmixSelect option:selected').text(),
 sku: $('#flavourmixSelect').val(),
 },
 stocking:parseInt($('#stocking').val(),10),
      
 };
   google.script.run.withSuccessHandler(newOrderSuccess).saveflavourmixOrder(obj,edit_flavour_mix_order);
 
 });

    function buildForm(data) {
        console.log(data);
        $('#subModalForm').show();
        $('#subflavourmixFormOrder').hide();
        var html = '';

        html += '<table class="form_table">';
        html += '<tr><td><h4>Order Date</h4></td><td><h4>Batch</h4></td><td><h4>Code</h4></td><td><h4>Description</h4></td><td><h4>OrderID</h4></td><td><h4>Priority</h4></td></tr>';
        html += '<tr><td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch" aria-describedby="sizing-addon2"></div></td>';
        var codeSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.PC.length; i++) {
            codeSelect += '<option value="' + data.PC[i].prod + '" id="' + data.PC[i].prod + '">' + data.PC[i].productcode + '<option>';
        }
        html+='<td><select class="form-control" onchange="pcselect();" id="PCSelect">' + codeSelect + '</select></td>';
        
        var descSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.PD.length; i++) {
            descSelect += '<option value="' + data.PD[i].descr + '" id="' + data.PD[i].descr + '">' + data.PD[i].productdescription + '<option>';
        }
         html+='<td><select class="form-control" onchange="pdselect();" id="PDDSelect">' + descSelect + '</select></td>';
        
        
        html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderID"  class="form-control" placeholder="OrderID" aria-describedby="sizing-addon2"></div></td>';
        var customerSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.customers.length; i++) {
            customerSelect += '<option value="' + data.customers[i].sku + '" id="' + data.customers[i].name + '">' + data.customers[i].name + '<option>';
        }

        var brandSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.brands.length; i++) {
            brandSelect += '<option value="' + data.brands[i].sku + '" id="' + data.brands[i].name + '">' + data.brands[i].name + '<option>';
        }
        html += '<td><div class="input-group"><input type="text" id="priority" class="form-control" placeholder="Priority" aria-describedby="sizing-addon2"></div></td></tr>';
        
        
        
        
        html += '<tr><td><h4>Customer</h4></td><td><h4>Brand</h4></td><td><h4>Check Uncolored(Premix Stock)</h4></td><td><h4>Recipe</h4></td><td><h4>Flavour</h4></td><td><h4>Bottles</h4></td></tr>';
        html += '<tr><td><select class="form-control" id="customerSelect">' + customerSelect + '</select></td><td><select class="form-control"  id="brandSelect">' + brandSelect + '</select></td><td>	<div class="form-check"><input type="checkbox"  id="checkUncolored"/></div></td>';
        var recipeSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.recipes.length; i++) {
        recipeSelect += '<option id="' + data.recipes[i][1] + '" value="' + data.recipes[i][0] + '" key="' + data.recipes[i][1] + '">' + data.recipes[i][0] + '<option>';
        }
        html += '<td><select class="form-control" id="recipeSelect">' + recipeSelect + '</select></td>';
        var flavourSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.flavours.length; i++) {
        flavourSelect += '<option value="' + data.flavours[i].sku + '">' + data.flavours[i].name+ '<option>';
        }
        html += '<td><select class="form-control" id="flavourSelect">' + flavourSelect + '</select></td>';
        
        html += '<td><div class="input-group"><input type="text" id="numBottles" class="form-control" placeholder="Bottles" aria-describedby="sizing-addon2"></div></td></tr>';
        
        
        
        
        html += '<tr><td><h4>Stocking Amount (litre)</h4></td><td><h4>Bottle Type</h4></td><td><h4>Lid Type</h4></td>';
        html += '<td><h4>Pack Type</h4></td><td><h4>Pre Printed Bottle Labels</h4></td><td><h4>Pre Printed Pack Labels</h4></td></tr>';
        html += '<tr><td><div class="input-group"><input type="text" id="stocking" class="form-control" placeholder="Stocking Amount (litre)" aria-describedby="sizing-addon2"></div></td>';
        var bottleSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.bottletypes.length; i++) {
            bottleSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].name + '">' + data.bottletypes[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="bottleType">' + bottleSelect + '</select></td>';

        var lidSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.lids.length; i++) {
            lidSelect += '<option value="' + data.lids[i].sku + '" >' + data.lids[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="lidType">' + lidSelect + '</select></td>';



        var packagingSelect = '<option id="blank" value=""><option>';
        for (var i = 0; i < data.packagings.length; i++) {
            packagingSelect += '<option value="' + data.packagings[i].sku + '" id="' + data.packagings[i].sku + '">' + data.packagings[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="packagingType">' + packagingSelect + '</select></td>';
        html += '<td>	<div class="form-check"><input type="checkbox"  id="prePrintedBottleLabels"/></div></td><td>	<div class="form-check"><input type="checkbox"  id="prePrintedPackLabels"/></div></td></tr></table>';
          $("#updating").hide();
        $('.modal-body').html(html);
             EDITORDER=false;
    }



    $('#subModalForm').on('click', function(e) {
    var productcode=$('#PCSelect').val();
    console.log('selected Code: '+productcode);
    var productdescription=$('#PDDSelect').val();
      console.log('selected desc: '+productdescription);
      
      if(productcode.length>20){
      var t=productcode;
      productcode=productdescription;
      productdescription=t;
      }
    var orderID = $('#orderID').val();
        var date = $('#orderDate').val();
        var batch = $('#orderbatch').val();
        console.log(batch);
        var priority = $('#priority').val();
        var customerSKU = $('#customerSelect').val();
        var customerSelect= $('#customerSelect option:selected').text();
        
        var brandSKU = $('#brandSelect').val();
        var brandSelect= $('#brandSelect option:selected').text();
        
        var recipekey = $('option:selected', '#recipeSelect').attr('key');
        
        
        var recipeName = $('#recipeSelect').val();
        var batch = $('#batch').val();
        var priority = $('#priority').val();
        var flavourSelect = $('#flavourSelect').val();
        var flavourName= $('#flavourSelect option:selected').text();
        
        var numBottles = $('#numBottles').val();
        numBottles = parseInt(numBottles, 10);
        var stocking = $('#stocking').val();
        stocking = parseInt(stocking, 10);
        var botSKU = $('#bottleType').val();
        var bottleType= $('#bottleType option:selected').text();
        
        var lidSKU = $('#lidType').val();
        var lidType= $('#lidType option:selected').text();
        
        var packagingTypesku = $('#packagingType').val();
        var packagingTypename= $('#packagingType option:selected').text();
         
        var object = {
              batch: $('#orderbatch').val(),
            productcode:productcode,
            productdescription:productdescription,
            orderdate: date,
          
            priority: priority,
            customer: customerSelect,
            recipe: {
                id: '',
                name: '',
               
            },
            brand: brandSelect,
            brandSKU:brandSKU,
            flavour: {
            name:'',
            sku:'',
            },
            bottles: numBottles,
            stocking: stocking,
            btype: bottleType,
            lid: lidType,
             lidSKU: lidSKU,
            botSKU: botSKU,
             customerSKU: customerSKU,
             brandSKU: brandSKU,
            
            packagingType:{
                sku: '',
                name: '',
               
            },
            orderID:orderID,
            ppp:$('#prePrintedPackLabels').is(":checked"),
            ppb:$('#prePrintedBottleLabels').is(":checked"),
            checkUncolored:$('#checkUncolored').is(":checked"),
        };
        
        object.recipe.id = recipekey;
        object.recipe.name = recipeName;
        
        object.packagingType.sku = packagingTypesku;
        object.packagingType.name = packagingTypename;
        
        object.flavour.sku = flavourSelect;
        object.flavour.name = flavourName;
        
        console.log(object);
         google.script.run.withSuccessHandler(newOrderSuccess).saveOrder(object,EDITORDER);



    });

    function newOrderSuccess(e) {
    filterpage('xx',true);
     //   google.script.run.withSuccessHandler(buildOrders).getOrdersData();
        alert(e);

    }

    function populateOrdersTab() {
      filterpage('xx',true);
      //  google.script.run.withSuccessHandler(buildOrders).getOrdersData();


    }
    
      function formatDateDisplay(datems){
     try{
     if(datems&&datems!=""){
       var num = parseInt(datems,10);
       if(num<5000){
       var now=new Date(datems);
       }else{
       var now=new Date(num);
       }
      
      var day = ("0" + now.getDate()).slice(-2);
      var month = ("0" + (now.getMonth() + 1)).slice(-2);
      
      var today = (day)+"-"+(month)+"-"+now.getFullYear() ;
     
      return today;
      }else{
       return '';
      }
      }catch(e){
      console.log('Unable to format date: ',datems);
      return '';
      }
    }
    
        function formatDateDisplay2(datems){
    try{
    if(datems&&datems!=""){
    var num = parseInt(datems,10);
    if(num<5000){
     var now=new Date(datems);
    }else{
    var now=new Date(num);
    }
    var now1 = now.toISOString().replace('T',' ').replace('Z','').split('.');
  
    var now2=now1[0].split(' ');
    
    var now3=now2[0].split('-');
    var now4=now3[2]+'-'+now3[1]+'-'+now3[0]+' '+now2[1];
    
    return now4;

    }else{
    return '';
    }
    }catch(e){
    console.log('Unable to format date: ',datems);
    return '';
    }
    }
    function formatDateInput(datems){
    try{
    var now=new Date(datems);
    
    
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    
    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
      return today;
      }catch(e){
      console.log('Unable to format date: ',datems);
      var now=new Date();
      
      
      var day = ("0" + now.getDate()).slice(-2);
      var month = ("0" + (now.getMonth() + 1)).slice(-2);
      
      var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
      return today;
      
      }
    }
    
    function buildFlavourMixOrdersTable(data){
    
        SelAllOrders=data;
        thisData=data;
        thisPage='FlavourMixOrders';
        console.log(data);
        var html = '';
        var heads=['Row','Menu','Order Date','Started','Batch','Stocking','Mix','Status'];
        var keys=['row','menu','orderdate','started','batch','stocking','flavourmix.name','final_status']
        html += '<table class="table"><thead><tr>';
        for(var i=0;i<heads.length;i++){
          html+= '<th>'+heads[i]+'</th>';
        }
        html += '</tr>';
        
        var drpdowns='';
        html += '<tr><th></th><th></th>';
        console.log(keys);
        for(var l=2;l<keys.length;l++){
        drpdowns+='<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';
        }
     
        html+=drpdowns;
        html+='</tr>';
        html+='</thead><tbody>';
        for(var i=0;i<data.length;i++){
            if(data[i].wentNegative){
            html +='<tr bgcolor="#FFC200" >';
            }else if(data[i].final_status=='Completed'){
            html +='<tr bgcolor="#1BEF5B">';
            }else if(data[i].final_status=='Busy'){
            html +='<tr bgcolor="#1BCFEF">';
            }else{
            html +='<tr>';
            }
            for(var j=0;j<keys.length;j++){
            
              if(keys[j]=='menu'){
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal" href="#editOrder' + data[i].batch + '">Edit</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#run' + data[i].batch + '">Run Order</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select'+data[i].batch+'" href="#select' + data[i].batch + '">Select</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect'+data[i].batch+'" href="#select' + data[i].batch + '">Deselect</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteFlavourMixOrder' + data[i].batch + '">Delete Batch</a>';
                html += '</div></div></td>';  
                }else if(keys[j]=='flavourmix.name'){
                html+= '<td>'+data[i].flavourmix.name+'</td>';
                }else if(keys[j]=='row'){
                html+= '<td>'+i+'</td>';
                }else if(keys[j]=='orderdate'){
                html+= '<td>'+formatDateDisplay(data[i][keys[j]])+'</td>';
                }else{
                html+= '<td>'+data[i][keys[j]]+'</td>';
                }
              
            }
           html +='</tr>';
          }
      
          
         html+='</tbody></table>';
          $('#pagebody').html(html);
    }

    function buildOrders(data) {
    
    var machinesHTML='<option></option>';
    google.script.run.withSuccessHandler(buildMachinesOptions).getMachines();
    function buildMachinesOptions(rett){
      var machines=rett[0];
      
      
      for(var i=0;i<machines.length;i++){
      machinesHTML+='<option sku="'+machines[i].sku+'" value="'+machines[i].sku+'">'+machines[i].name+'</option>';
      }
      
    
    var takefrom=0;
        console.log(data);
        SelAllOrders=data;
        thisData=data;
        thisPage='Orders';
        var html = '';
        html += '<table class="table"><thead><tr><th>Row</th><th>Menu</th><th>Move</th><th>Order Date</th><th>Started</th><th>Production Machine</th><th>Labelling Machine</th><th>Batch</th><th>Order ID</th><th>Code</th><th>Description</th><th>Priority</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th><th>Bottles</th><th>Stocking Amount (litre)</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th>';
        html += '<th>QTY</th><th>Flavour Value</th><th>VG Value</th><th>AG Value</th><th>PG Value</th><th>Nicotine Value</th><th>Nicotine Salts Value</th><th>CBD Value</th><th>MCT Value</th><th>Backed by Mixing</th>';
        html+='<th>Backed by Premixed</th><th>Backed by Unbranded</th><th>Backed by Branded</th><th>Backed By Branded Packaged</th><th>Mixing Status</th><th>Production Status</th><th>Printing Status</th><th>Labelling Status</th>';
        html += '<th>Packaging Status</th><th>FINAL STATUS</th><th>Partial Production</th><th>Partial Packaging</th></tr>';
        
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th><div>STOCKING TOTAL</div><div id="stockingTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th><div>QTY TOTAL</div><div id="qtyTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th>';
        html += '<th></th><th></th><th></th><th></th><th><div>MIXING TOTAL</div><div id="mixingTotal'+thisPage+'"></div></th><th><div>PREMIX TOTAL</div><div id="premixTotal'+thisPage+'"></div></th><th><div>UNBRANDED TOTAL</div><div id="unbrandedTotal'+thisPage+'"></div></th><th><div>BRANDED TOTAL</div><div id="brandedTotal'+thisPage+'"></div></th><th><div>TUBES TOTAL</div><div id="tubesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><tr>';
      if(data){
        var keys=['orderdate','starttime','machineP','machineL','batch','orderID','productcode','productdescription','priority','customer','brand','recipe.name','flavour.name','bottles','stocking','btype','lid','packagingType.name','QTY','flavvalue','VGval','AGval','PGval','Nico','Nicosalts','CBDvalue','MCTval','mixing','premixed',
            'unbranded','branded','backtubed','mixing_status','production_status','printing_status','labeling_status','packaging_status','final_status','partialProduction','partialPackaging'];
       var drpdowns='';
        html += '<tr><th></th><th></th><th></th>';
        console.log(keys);
       for(var l=0;l<keys.length;l++){
       drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
       }
       }
       html+=drpdowns;
       html+='</tr>';
     html += ' </thead>';
        html += '<tbody>';
        if(data!=''){
        var bottlesTotal=0;
        var stockingTotal=0;
        var qtyTotal=0;
        var mixingTotal=0;
        var premixTotal=0;
        var unbrandedTotal=0;
        var brandedTotal=0;
        var tubesTotal=0;
        var rowsTotal=0;
        for (var i = 0; i < data.length; i++) {
        if(data[i].recipe){
        
         if(data[i].wentNegative){
         html +='<tr bgcolor="#FFC200" >';
        }else if(data[i].final_status=='Completed'){
         html +='<tr bgcolor="#1BEF5B">';
        }else if(data[i].final_status=='Busy'){
         html +='<tr bgcolor="#1BCFEF">';
        }else{
         html +='<tr>';
        }
        
       
            html += '<td>'+i+'</td><td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
           // if (data[i].final_status == 'Busy' || data[i].final_status == 'Completed') {
              //  html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteOrder' + data[i].batch + '">Delete Batch</a>';
          //  } else {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal" href="#editOrder' + data[i].batch + '">Edit</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#run' + data[i].batch + '">Run Order</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select'+data[i].batch+'" href="#select' + data[i].batch + '">Select</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect'+data[i].batch+'" href="#select' + data[i].batch + '">Deselect</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteOrder' + data[i].batch + '">Delete Batch</a>';
                html += '<a class="dropdown-item" onclick="return deleteandreverseSingle(this);" batch="' + data[i].batch + '">Delete and Reverse Batch</a>';
               html += '<a class="dropdown-item" onclick="return reverseSingle(this);" batch="' + data[i].batch + '">Reverse Batch</a>';


         //   }

            html += ' </div></div></td>';  
            html += '<td><button page="Orders" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
          
            html += '<td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + formatDateDisplay2(data[i].starttime) + '</td>';
                  if(data[i].machineP){
            var selectedDropdown=machinesHTML;    
            selectedDropdown=selectedDropdown.replace('sku="'+data[i].machineP+'"','sku="'+data[i].machineP+'" selected');

            html += '<td><select class="form-control"  style="width:200px;" id=machinesProduction batch="'+data[i].batch+'"  onChange=changeProdMachine(this); >'+selectedDropdown;
            }else{
             html += '<td><select class="form-control" style="width:200px;" id=machinesProduction batch="'+data[i].batch+'"  onChange=changeProdMachine(this);>'+machinesHTML;
            }

            html += '</select></td>';
              if(data[i].machineL){
             html += '<td><select class="form-control" style="width:200px;" id=machinesLabelling onChange=changeLabelMachine(this); batch="'+data[i].batch+'" ><option factory="' + data[i].factory + '" value="' + data[i].machineL + '">' + data[i].machineL + '</option>';
            }else{
             html += '<td><select class="form-control" style="width:200px;" id=machinesLabelling batch="'+data[i].batch+'"  onChange=changeLabelMachine(this);><option ></option>';
            }
           
            html += '<option factory="Manchester" value="Manchester - AD Labeller 1">Manchester - AD Labeller 1</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 1">Manchester - Semi-auto Labeller 1</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 2">Manchester - Semi-auto Labeller 2</option>';
            html += '<option factory="Manchester" value="Manchester - Auto Machine 1 - Labelling only">Manchester - Auto Machine 1 - Labelling only</option>';
            html += '<option factory="Manchester" value="Manchester - Auto Machine 2 - Labelling only">Manchester - Auto Machine 2 - Labelling only</option>';
            html += '<option factory="Halifax" value="Halifax - AD Labeller 1">Halifax - AD Labeller 1</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 1">Manchester - Semi-auto Labeller 1</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 2">Manchester - Semi-auto Labeller 2</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 3">Manchester - Semi-auto Labeller 3</option>';
            html += '<option factory="Manchester" value="Manchester - Semi-auto Labeller 4">Manchester - Semi-auto Labeller 4</option>';
            html += '<option factory="Halifax" value="Halifax - Auto Machine 1 - Labelling only">Halifax - Auto Machine 1 - Labelling only</option>';
            html += '<option factory="Halifax" value="Halifax - Auto Machine 2 - Labelling only">Halifax - Auto Machine 2 - Labelling only</option>';
            html += '</select></td>';
            data[i].priority=data[i].priority == 0 ? data[i].priority: ' ';
            data[i].flavvalue=data[i].flavvalue ? data[i].flavvalue: ' ';
            data[i].VGval=data[i].VGval ? data[i].VGval: ' ';
            data[i].AGval=data[i].AGval ? data[i].AGval: ' ';
            data[i].PGval=data[i].PGval ? data[i].PGval: ' ';
            data[i].Nico=data[i].Nico ? data[i].Nico: ' ';
            data[i].Nicosalts=data[i].Nicosalts ? data[i].Nicosalts: ' ';
            data[i].CBDvalue=data[i].CBDvalue ? data[i].CBDvalue: ' ';
            data[i].MCTval=data[i].MCTval ? data[i].MCTval: ' ';
            
            html += '<td>' + data[i].batch + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].priority + '</td><td>' + data[i].customer + '</td><td>' + data[i].brand + '</td>';
            html += '<td>' + data[i].recipe.name + '</td><td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].stocking + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td>';
            html += '<td>' + data[i].packagingType.name + '</td><td>' + data[i].QTY + '</td><td>' + data[i].flavvalue + '</td><td>' + data[i].VGval + '</td><td>' + data[i].AGval + '</td><td>' + data[i].PGval + '</td><td>' + data[i].Nico + '</td><td>' + data[i].Nicosalts + '</td><td>' + data[i].CBDvalue + '</td><td>' + data[i].MCTval + '</td>';
            html += '<td>' + data[i].mixing + '</td><td>' + data[i].premixed + '</td><td>' + data[i].unbranded + '</td><td>' + data[i].branded + '</td><td>' + data[i].backtubed + '</td><td>' + data[i].mixing_status + '</td>';
            html += '<td>' + data[i].production_status + '</td><td>' + data[i].printing_status + '</td><td>' + data[i].labeling_status + '</td><td>' + data[i].packaging_status + '</td><td>' + data[i].final_status + '</td>';
            html += '<td>' + data[i].partialProduction + '</td><td>' + data[i].partialPackaging + '</td>';

            html += '</tr>';
        
        bottlesTotal+=parseInt(data[i].bottles,10);
        stockingTotal+=parseInt(data[i].stocking,10);
        if(data[i].QTY){
        qtyTotal+=data[i].QTY;
        }
        mixingTotal+=parseInt(data[i].mixing,10);
        premixTotal+=parseInt(data[i].premixed,10);
        unbrandedTotal+=parseInt(data[i].unbranded,10);
        brandedTotal+=parseInt(data[i].branded,10);
        tubesTotal+=parseInt(data[i].backtubed,10);
        

        }else{
        takefrom++;
        console.log(data[i]);}
       
        }
        rowsTotal=i-takefrom;
        
        }
        html += '</tbody></table>';

        
        $('#pagebody').html(html);
        
         $('#bottlesTotal'+thisPage).html(bottlesTotal);
         $('#stockingTotal'+thisPage).html(stockingTotal);
         $('#qtyTotal'+thisPage).html(qtyTotal);
         $('#mixingTotal'+thisPage).html(mixingTotal);
         $('#premixTotal'+thisPage).html(premixTotal);
         $('#unbrandedTotal'+thisPage).html(unbrandedTotal);
         $('#brandedTotal'+thisPage).html(brandedTotal);
         $('#tubesTotal'+thisPage).html(tubesTotal);
          $('#rowsTotal'+thisPage).html(rowsTotal);
      }
    }





    $('#subModalForm2').on('click', function(e) {
        var orderdate = $('#orderDate1').val();
        var delivdate = $('#deliveryDate').val();
        var paiddate = $('#paiddate').val();
        var eta = $('#eta').val();
        var desc = $('#description').val();
        var sku = $("#descriptionsku").val();
        var page = $("#descriptionpage").val();
        var key = $("#description2").val();
        var quantity = parseInt($('#quantity').val(), 10);
        var note = $('#note').val();
        
        var obj = {
        paiddate:paiddate,
            orderdate: orderdate,
            delivdate: delivdate,
            eta: eta,
            desc: desc,
            key: key,
            quantity: quantity,
            note: note,
            page: page,
            sku:sku
        };
        console.log(obj);
        google.script.run.withSuccessHandler(newItemSuccess).saveItem(obj);
   
       $('#orderDate1').val('');
       $('#deliveryDate').val('');
       $('#paiddate').val('');
       $('#eta').val('');
       $('#description').val('');
       $("#descriptionsku").val('');
       $("#descriptionpage").val('');
       $("#description2").val('');
       $('#quantity').val('');
       $('#note').val('');

    });



    function newItemSuccess(e) {
        google.script.run.withSuccessHandler(buildInventory).getInventoryData();
        alert(e);

    }

    function populateInventoryTab() {
        google.script.run.withSuccessHandler(buildInventory).getInventoryData();
    }

    function buildInventory(data) {
        var html = '';
        
        html += '<table class="table table-striped"><thead><tr><th>Menu</th><th>Row</th><th>Description</th><th>Order Date</th><th>Delivery Date</th><th>Paid Date</th><th>ETA / Days</th><th>Order Quantity</th>';
        html += '<th>Note</th></tr></thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
            html += '<tr><td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
           if(data[i].quantity){
      var quant=data[i].quantity;
      }else{var quant='null';} 
                html += '<a class="dropdown-item" onclick="return menuClick(this);" page="' + data[i].page + '" data-toggle="modal" data-target="#myModal2" href="#editItem' + data[i].key +  '">Edit</a>';
          
    
            html += '<a class="dropdown-item" onclick="return menuClick(this);" page="' + data[i].page + '" href="#deleteInv' + data[i].key +  '">Delete Item</a>';
            html += ' </div></div></td>';
            html += '<td>'+data[i].row+'</td>';
            html += '<td>' + data[i].desc + '</td><td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + formatDateDisplay(data[i].delivdate) + '</td><td>' + formatDateDisplay(data[i].paiddate) + '</td><td>' + data[i].eta + '</td><td>' + quant + '</td><td>' + data[i].note + '</td></tr>';

        }}
        html += '</tbody></table>';

        $('#invbody').html(html);




    }
      function sortClick(event){
     
      var href = event.getAttribute('href');
      href=href.slice(1, href.length);
      var sorttype = event.getAttribute('sorttype');
  
        $("#updating").css("display", "block");
     google.script.run.withSuccessHandler(filterResult).sortBY(largeData,sorttype,href,thisPage);
      return false;
      }
      
      
    function menuClick(event) {
        var href = event.getAttribute('href');
        var extra = event.getAttribute('page');
        console.log(href);
        if (href.substr(0, 4) == '#run') {
            runItem(href.substr(4, href.length));
        }else if (href.substr(0, 10) == '#deleteInv') {
            removeFromInventory(href.substr(10, href.length), extra);
        } else if (href.substr(0, 12) == '#deleteOrder') {
            deleteItem(href.substr(12, href.length), 'Orders');
        } else if (href.substr(0, 22) == '#deleteFlavourMixOrder') {
            deleteItem(href.substr(22, href.length), 'FlavourMixOrders');
        } else if (href.substr(0, 27) == '#deleteFlavourMixMixingTeam') {
            deleteItem(href.substr(27, href.length), 'FlavourMixMixingTeam');
        } else if (href.substr(0, 21) == '#deletePremixColoring') {
            deleteItem(href.substr(21, href.length), 'PremixColoring');
        }else if (href.substr(0, 9) == '#editItem') {
            editItem(href.substr(9, href.length), extra);
        } else if (href.substr(0, 10) == '#editOrder') {
            editOrder(href.substr(10, href.length));
        } else if (href.substr(0, 7) == '#select') {
            addToSelected(href.substr(7, href.length));
        } else if (href.substr(0, 15) == '#MixingMoveNext') {
            lineItemMove(href.substr(15, href.length), 'MixingTeam');
        } else if (href.substr(0, 17) == '#deleteMixingTeam') {
            deleteItem(href.substr(17, href.length), 'MixingTeam');
        } else if (href.substr(0, 10) == '#deleteMix') {
            deleteItem(href.substr(10, href.length), 'Mixing');
        } else if (href.substr(0, 19) == '#ProductionMoveNext') {
            lineItemMove(href.substr(19, href.length), 'Production');
        } else if (href.substr(0, 17) == '#deleteProduction') {
            deleteItem(href.substr(17, href.length), 'Production');
        } else if (href.substr(0, 17) == '#PrintingMoveNext') {
            lineItemMove(href.substr(17, href.length), 'Printing');
        } else if (href.substr(0, 15) == '#deletePrinting') {
            deleteItem(href.substr(15, href.length), 'Printing');
        } else if (href.substr(0, 18) == '#LabellingMoveNext') {
            lineItemMove(href.substr(18, href.length), 'Labelling');
        } else if (href.substr(0, 16) == '#deleteLabelling') {
            deleteItem(href.substr(16, href.length), 'Labelling');
        } else if (href.substr(0, 18) == '#PackagingMoveNext') {
            lineItemMove(href.substr(18, href.length), 'Packaging');
        } else if (href.substr(0, 16) == '#deletePackaging') {
            deleteItem(href.substr(16, href.length), 'Packaging');
        } else if (href.substr(0, 13) == '#editShipping') {
            editShipping(href.substr(13, href.length));
        } else if (href.substr(0, 15) == '#deleteShipping') {
            deleteItem(href.substr(15, href.length), 'Shipping');
        } else if (href.substr(0, 8) == '#editQTY') {
        console.log(extra);
            editQTY(href.substr(8, href.length),extra);
        }

        return false;
    }
  function deselect(event){
  
  var batch=event.getAttribute('page');
  addToSelected(batch);
  }
    var SELECTED=[];
    function addToSelected(batch){
    console.log(SELECTED);
    var check=SELECTED.indexOf(batch);
     console.log(check);
     
    if(check==-1){
      SELECTED.push(batch);
        $('#deselect'+batch).css('display','block');
        $('#select'+batch).css('display','none');
      
       
      displaySelected(SELECTED);
      }else{
     $('#deselect'+batch).css('display','none');
        $('#select'+batch).css('display','block');
      SELECTED.splice(check, 1);
      displaySelected(SELECTED);
      }
    }
    function displaySelected(SELECTED){
    var html='<p>Selected:</p>';
    html+='<p>';
    for(var i=0;i<SELECTED.length;i++){
    html+='<button class="selVal" page="'+SELECTED[i]+'" onclick="deselect(this)" >'+SELECTED[i]+'<span class="glyphicon glyphicon-remove"></span></button>';
    
    }
    html+='</p>';
    console.log(selPage);
    if(selPage=='Orders'||selPage=='FlavourMixOrders'){
    $('#selection').html(html);
    }else if(selPage=='Production'){
    $('#selectionProduction').html(html);
    }else if(selPage=='Packaging'){
    $('#selectionPackaging').html(html);
    }
    }
    function runmulti(){
          $("#updating").css("display", "block");
     google.script.run.withSuccessHandler(multRun).bulkrun(SELECTED,selPage);
    
    }
    
    function multRun(msg){
    
       alert(msg);
     filterpage('xx',true);
   //buildOrders(SelAllOrders);
     $("#updating").css("display", "none");
    }
    function checkstock(){
      $("#updating").css("display", "block");
     google.script.run.withSuccessHandler(stockCheck).checkStockValues(SELECTED);
    }
     function printProduction(){
     google.script.run.withSuccessHandler(stockCheck).printProductionBatches(SELECTED);
    }
    
    function printOrders(){
         google.script.run.withSuccessHandler(stockCheck).printOrdersBatches(SELECTED);

    }
//      function printPackaging(){
//     google.script.run.withSuccessHandler(stockCheck).printPackagingBatches(SELECTED);
//    }
          function printPackaging(){
     google.script.run.withSuccessHandler(buildhtmlmodal).checkPackagePrinting(SELECTED);
    }
    function printSuccess(msg){
    alert(msg);
    }
     function stockCheck(msg){
      $("#updating").css("display", "none");
     $('#checkBatches').modal('show');
     var html='<p >'+msg+'</p>';
      $('#checkBatchesBody').html(html); 
    // alert(msg);
    }

    function runItem(batch) {
        console.log(batch +" " + selPage);
        if(selPage=='Orders'){
        google.script.run.withSuccessHandler(OrderItemSuccess).runItem(batch,false);
        }else{
         google.script.run.withSuccessHandler(OrderItemSuccess).runflavourmixItem(batch);
        }
        
    }



    function OrderItemSuccess(rett) {
        console.log('rett',rett);
          //buildOrders(SelAllOrders);
        alert(rett);
        
          filterpage('xx',true);

    }

    function removeFromOrders(batch) {
        console.log(batch);
       
        google.script.run.withSuccessHandler(OrderItemSuccess).removefromOrders(batch);
  
    }


    function editOrder(batch) {
    console.log(batch);
    if(selPage=='Orders'){
    google.script.run.withSuccessHandler(buildOrderFormFromExisting).getOrderData(batch);
    }else{
    google.script.run.withSuccessHandler(buildFormFlavourMixExisting).getFlavourMixOrderData(batch);
    }
    }

    function buildOrderFormFromExisting(retval) {
      $('#subModalForm').show();
      $('#subflavourmixFormOrder').hide();
        console.log(retval);
        var data = retval[0];
        var dataold = retval[1];
        console.log(data);

        var html = '';

        var customerSelect = '<option value="'+ dataold.customerSKU +'" selected id="' + dataold.customer + '">' + dataold.customer + '<option>';
        var brandSelect = '<option value="'+ dataold.brandSKU +'"  selected id="' + dataold.brand + '">' + dataold.brand + '<option>';
        var recipeSelect = '<option selected id="' + dataold.recipe.id +'" value="' + dataold.recipe.name + '" key="' + dataold.recipe.id + '">' + dataold.recipe.name + '<option>';
        var flavourSelect = '<option value="'+ dataold.flavour.sku +'"  selected >' + dataold.flavour.name + '<option>';
        var bottleSelect = '<option value="'+ dataold.botSKU +'"  selected id="' + dataold.btype + '">' + dataold.btype + '<option>';
        var lidSelect = '<option value="'+ dataold.lidSKU +'"  selected id="' + dataold.lid + '">' + dataold.lid + '<option>';
        
        if (dataold.packagingType) {
            var packagingSelect = '<option value="'+ dataold.packagingType.sku +'"  id="' + dataold.packagingType.sku + '">' + dataold.packagingType.name  + '<option>';
        } else {
            var packagingSelect = '<option value=""></option>';
        }
         html += '<table class="form_table">';
        html += '<tr><td><h4>Order Date</h4></td><td><h4>Batch</h4></td><td><h4>Code</h4></td><td><h4>Description</h4></td><td><h4>OrderID</h4></td><td><h4>Priority</h4></td></tr>';
        
        
       
        html += '<tr><td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch" aria-describedby="sizing-addon2"></div></td>';
        var codeSelect = '<option id="blank" value="'+dataold.productcode+'">'+dataold.productcode+'<option>';
        for (var i = 0; i < data.PC.length; i++) {
            codeSelect += '<option value="' + data.PC[i].prod + '" >' + data.PC[i].productcode + '<option>';
        }
        html+='<td><select class="form-control" onchange="pcselect();" id="PCSelect">' + codeSelect + '</select></td>';
        
        var descSelect = '<option id="blank"  value="'+dataold.productdescription+'">'+dataold.productdescription+'<option>';
        console.log(data.PD);
        
        for (var i = 0; i < data.PD.length; i++) {
        try{
            descSelect += '<option value="' + data.PD[i].descr + '" >' + data.PD[i].productdescription + '<option>';
            }catch(e){console.log(PD[i])}
        }
         html+='<td><select class="form-control" onchange="pdselect();" id="PDDSelect">' + descSelect + '</select></td>';
        
        
        html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderID"  class="form-control" placeholder="OrderID" aria-describedby="sizing-addon2"></div></td>';
      
        for (var i = 0; i < data.customers.length; i++) {
            customerSelect += '<option value="' + data.customers[i].sku + '" id="' + data.customers[i].sku + '">' + data.customers[i].name + '<option>';
        }

       
         for (var i = 0; i < data.brands.length; i++) {
         brandSelect += '<option value="' + data.brands[i].sku + '" id="' + data.brands[i].sku + '">' + data.brands[i].name + '<option>';
         }
         html += '<td><div class="input-group"><input type="text" id="priority" class="form-control" placeholder="Priority" aria-describedby="sizing-addon2"></div></td></tr>';
         
         html += '<tr><td><h4>Customer</h4></td><td><h4>Brand</h4></td><td><h4>Check Uncolored (Premix Stock)</h4></td><td><h4>Recipe</h4></td><td><h4>Flavour</h4></td><td><h4>Bottles</h4></td></tr>';
         html += '<td><select class="form-control" id="customerSelect">' + customerSelect + '</select></td><td><select class="form-control"  id="brandSelect">' + brandSelect + '</select></td><td><div class="form-check"><input type="checkbox"  id="checkUncolored"/></div></td>';
         
         for (var i = 0; i < data.recipes.length; i++) {
         recipeSelect += '<option id="' + data.recipes[i][1]  + '" value="' + data.recipes[i][0] + '" key="' + data.recipes[i][1] + '">' + data.recipes[i][0] + '<option>';
         }
         
         html += '<td><select class="form-control" id="recipeSelect">' + recipeSelect + '</select></td>';
         
             
        for (var i = 0; i < data.flavours.length; i++) {
            flavourSelect += '<option value="' + data.flavours[i].sku + '" id="' + data.flavours[i].sku + '">' + data.flavours[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="flavourSelect">' + flavourSelect + '</select></td>';

        html += '<td><div class="input-group"><input type="text" id="numBottles" class="form-control" placeholder="Bottles" aria-describedby="sizing-addon2"></div></td></tr>';


        html += '<tr><td><h4>Stocking Amount (litre)</h4></td><td><h4>Bottle Type</h4></td><td><h4>Lid Type</h4></td>';
        html += '<td><h4>Pack Type</h4></td><td><h4>Pre Printed Bottle Labels</h4></td><td><h4>Pre Printed Pack Labels</h4></td></tr>';
        
        
        html += '<td><div class="input-group"><input type="text" id="stocking" class="form-control" placeholder="Stocking Amount (litre)" aria-describedby="sizing-addon2"></div></td>';
        
        for (var i = 0; i < data.bottletypes.length; i++) {
        bottleSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="bottleType">' + bottleSelect + '</select></td>';
        
        
        for (var i = 0; i < data.lids.length; i++) {
        lidSelect += '<option value="' + data.lids[i].sku + '" id="' + data.lids[i].sku + '">' + data.lids[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="lidType">' + lidSelect + '</select></td>';
        
        
        
        for (var i = 0; i < data.packagings.length; i++) {
        packagingSelect += '<option value="' + data.packagings[i].sku + '" id="' + data.packagings[i].sku + '">' + data.packagings[i].name + '<option>';
        }
        html += '<td><select class="form-control" id="packagingType">' + packagingSelect + '</select></td>';
        html += '<td><div class="form-check"><input type="checkbox"  id="prePrintedBottleLabels"/></div></td><td><div class="form-check"><input type="checkbox"  id="prePrintedPackLabels"/></div></td></tr></table>';
        
         $('.modal-body').html(html);
          $("#updating").hide();

    $('#orderID').val(dataold.orderID);  
   
   $('#orderDate').val(formatDateInput(dataold.orderdate));
        var batch = $('#orderbatch').val(dataold.batch);
        var priority = $('#priority').val(dataold.priority);
        if(dataold.ppp){
        $('#prePrintedPackLabels').prop('checked', true);
        }
        if(dataold.ppb){
        $('#prePrintedBottleLabels').prop('checked', true);
        }
        if (dataold.bottles) {
            $('#numBottles').val(dataold.bottles);
        } else {
            $('#numBottles').val(0);
        }
        if (dataold.stocking) {
            $('#stocking').val(dataold.stocking);
        } else {
            $('#stocking').val(0);
        }



EDITORDER=true;
    }
var EDITORDER=false;


        function populateMixingTab(){
        google.script.run.withSuccessHandler(buildMixingTable).getSheetData('Mixing');
        
        }
        function buildMixingTable(data){
        $(".searchBoxMixing").show();
        $(".searchBoxMixingTeam").hide();
                   getSearchBoxData('Mixing');

        console.log(data);
        thisData=data;
        thisPage='Mixing';
      
        var stockingTotal=0;
        var qtyTotal=0;
        var mixingTotal=0;
        var premixTotal=0;
        var unbrandedTotal=0;
        var brandedTotal=0;
     var tubesTotal=0;
        var rowsTotal=0;

        var html='';
        html+='<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Completed</th><th>Priority</th><th>Batch</th><th>Order ID</th><th>Brand</th><th>Code</th><th>Description</th><th>Recipe</th><th>Flavour</th><th>Order Date</th><th>QTY(Litres)</th><th>VG (MG)</th><th>AG (MG)</th><th>PG (MG)</th><th>Nicotine (MG)</th><th>Nicotine Salts (MG)</th><th>CBD (MG)</th><th>MCT (MG)</th>';
        html+='<th>Flavour (MG)</th>';
        html+='<th>Backed By Mixing</th><th>Backed By Premix</th><th>Backed By Unbranded</th><th>Backed By Branded</th><th>Backed By Branded Packaged</th>';
        html+='</tr>';
    html+='<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>QTY TOTAL</div><div id="qtyTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>';
    html+='<th><div>MIXING TOTAL</div><div id="mixingTotal'+thisPage+'"></div></th><th><div>PREMIX TOTAL</div><div id="premixTotal'+thisPage+'"></div></th><th><div>UNBRANDED TOTAL</div><div id="unbrandedTotal'+thisPage+'"></div></th><th><div>BRANDED TOTAL</div><div id="brandedTotal'+thisPage+'"></div></th><th><div>TUBES TOTAL</div><div id="tubesTotal'+thisPage+'"></div></th></tr>';
    if(data){
    var keys=['final_status','priority','batch','orderID','brand','productcode','productdescription','recipe.name','flavour.name','orderdate','QTY','VGval','AGval','PGval','Nico','Nicosalts','CBDvalue','MCTval','flavvalue','mixing','premixed','unbranded','branded','backtubed'];
    var drpdowns='';
    html += '<tr><th></th><th></th>';
    console.log(keys);
    for(var l=0;l<keys.length;l++){
    drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
    }
    }
    html+=drpdowns;
    html+='</tr>';
    html += ' </thead>';
        html+='<tbody>';
        for(var i=0;i<data.length;i++){
        if(!data[i].recipe){continue;}
          if (data[i].final_status == 'Not Run') {
                 html+='<tr>'
                 }else if (data[i].final_status == 'Busy') {
                  html+='<tr bgcolor="#1BCFEF">'
                 }else{
                  html+='<tr bgcolor="#1BEF5B">'
                 }
                
                    html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
          data[i].brand=data[i].brand ? data[i].brand: ' ';
        html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteMix' + data[i].batch + '">Delete</a>';
        html+=' </div></div></td>';
        data[i].priority=data[i].priority == 0 ? data[i].priority: ' '; 
        html += '<td><button page="Mixing" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Mixing" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
        html+='<td>'+data[i].final_status+'</td><td>'+data[i].priority+'</td><td>'+data[i].batch+'</td><td>' + data[i].orderID + '</td><td>' + data[i].brand + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>'+data[i].recipe.name+'</td>';
      
        data[i].flavvalue=data[i].flavvalue ? data[i].flavvalue: ' ';
        data[i].VGval=data[i].VGval ? data[i].VGval: ' ';
        data[i].AGval=data[i].AGval ? data[i].AGval: ' ';
        data[i].PGval=data[i].PGval ? data[i].PGval: ' ';
        data[i].Nico=data[i].Nico ? data[i].Nico: ' ';
        data[i].Nicosalts=data[i].Nicosalts ? data[i].Nicosalts: ' ';
        data[i].CBDvalue=data[i].CBDvalue ? data[i].CBDvalue: ' ';
        data[i].MCTval=data[i].MCTval ? data[i].MCTval: ' ';
        
        html+='<td>'+data[i].flavour.name+'</td><td>'+ formatDateDisplay(data[i].orderdate)+'</td><td>'+data[i].QTY+'</td><td>'+data[i].VGval+'</td><td>'+data[i].AGval+'</td><td>'+data[i].PGval+'</td><td>'+data[i].Nico+'</td><td>'+data[i].Nicosalts+'</td><td>'+data[i].CBDvalue+'</td><td>'+data[i].MCTval+'</td>';
        html+='<td>'+data[i].flavvalue+'</td>';
        html+='<td>'+data[i].mixing+'</td><td>'+data[i].premixed+'</td><td>'+data[i].unbranded+'</td><td>'+data[i].branded+'</td><td>'+data[i].backtubed+'</td></tr>';
         stockingTotal+=parseInt(data[i].stocking,10);
              if(data[i].QTY){
        qtyTotal+=data[i].QTY;
        }
        mixingTotal+=parseInt(data[i].mixing,10);
        premixTotal+=parseInt(data[i].premixed,10);
        unbrandedTotal+=parseInt(data[i].unbranded,10);
        brandedTotal+=parseInt(data[i].branded,10);
      tubesTotal+=parseInt(data[i].backtubed,10);

       
       
       }
       
        rowsTotal=i;

        html+='</tbody></table>';
        $('#Mixing').html(html);
        
                 
         $('#qtyTotal'+thisPage).html(qtyTotal);
         $('#mixingTotal'+thisPage).html(mixingTotal);
         $('#premixTotal'+thisPage).html(premixTotal);
         $('#unbrandedTotal'+thisPage).html(unbrandedTotal);
         $('#brandedTotal'+thisPage).html(brandedTotal);
        $('#tubesTotal'+thisPage).html(tubesTotal);
          $('#rowsTotal'+thisPage).html(rowsTotal);

        
        
        
        
        
        
        
        }


    function populateFlavourMixMixingTeamTab() {
        google.script.run.withSuccessHandler(buildFlavourMixMixingTeamTable).getSheetData('FlavourMixMixingTeam');


    }

   function buildFlavourMixMixingTeamTable(data){
         $(".searchBoxMixing").hide();
         $(".searchBoxMixingTeam").show();
         getSearchBoxData('FlavourMixMixingTeam');
        SelAllOrders=data;
        thisData=data;
        thisPage='FlavourMixMixingTeam';
        console.log(data);
        var html = '';
        var heads=['Row','Menu','Order Date','Started','Batch','Stocking','Mix','Status','Completion Date','Notes','Location'];
        var keys=['row','menu','orderdate','started','batch','stocking','flavourmix.name','final_status','CompletionDate','Notes','Location'];
        html += '<table class="table"><thead><tr>';
        for(var i=0;i<heads.length;i++){
          html+= '<th>'+heads[i]+'</th>';
        }
        html += '</tr>';
        
        var drpdowns='';
        html += '<tr><th></th><th></th>';
        console.log(keys);
        for(var l=2;l<keys.length;l++){
        drpdowns+='<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';
        }
     
        html+=drpdowns;
        html+='</tr>';
        html+='</thead><tbody>';
        for(var i=0;i<data.length;i++){
            if(data[i].wentNegative){
            html +='<tr bgcolor="#FFC200" >';
            }else if(data[i].final_status=='Completed'){
            html +='<tr bgcolor="#1BEF5B">';
            }else if(data[i].final_status=='Busy'){
            html +='<tr bgcolor="#1BCFEF">';
            }else{
            html +='<tr>';
            }
            for(var j=0;j<keys.length;j++){
            
              if(keys[j]=='menu'){
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteFlavourMixMixingTeam' + data[i].batch + '">Delete</a>';
                html += '</div></div></td>';  
                }else if(keys[j]=='flavourmix.name'){
                html+= '<td>'+data[i].flavourmix.name+'</td>';
                }else if(keys[j]=='row'){
                html+= '<td>'+i+'</td>';
                }else if(keys[j]=='orderdate'){
                html+= '<td>'+formatDateDisplay(data[i][keys[j]])+'</td>';
                }else if(keys[j]=='CompletionDate' || keys[j]=='starttime'){
                html+= '<td>'+formatDateDisplay2(data[i][keys[j]])+'</td>';
                }else{
                html+= '<td>'+data[i][keys[j]]+'</td>';
                }
              
            }
           html +='</tr>';
          }
      
          
         html+='</tbody></table>';
             $('#Mixing').html(html);

   
   
   }


   function buildPremixColoringTable(data){
         $(".searchBoxMixing").hide();
         $(".searchBoxMixingTeam").show();
         getSearchBoxData('PremixColoring');
        SelAllOrders=data;
        thisData=data;
        thisPage='PremixColoring';
        console.log(data);
        var html = '';
        var heads=['Row','Menu','Batch','Order Date','Started','QTY','Color','Color SKU','Color %','Mix Batch Code','Uncolored Premix Description','Uncolored Premix SKU','Colored Premix Description','Colored Premix SKU','Status','Completion Date','Notes','Location'];
        var keys=['row','menu','batch','orderdate','starttime','QTY','Color.name','Color.sku','Color.val','mixbatch','premixdescr','premixSKU','premixdescrColored','premixSKUColored','final_status','CompletionDate','Notes','Location']
        html += '<table class="table"><thead><tr>';
        for(var i=0;i<heads.length;i++){
          html+= '<th>'+heads[i]+'</th>';
        }
        html += '</tr>';
        
        var drpdowns='';
        html += '<tr><th></th><th></th>';
        console.log(keys);
        for(var l=2;l<keys.length;l++){
        drpdowns+='<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';
        }
     
        html+=drpdowns;
        html+='</tr>';
        html+='</thead><tbody>';
        for(var i=0;i<data.length;i++){
          if(data[i].final_status=='Completed'){
            html +='<tr bgcolor="#1BEF5B">';
            }else if(data[i].final_status=='Busy'){
            html +='<tr bgcolor="#1BCFEF">';
            }else{
            html +='<tr>';
            }
            for(var j=0;j<keys.length;j++){
            
              if(keys[j]=='menu'){
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deletePremixColoring' + data[i].batch + '">Delete</a>';
                html += '</div></div></td>';  
                }else if(keys[j]=='row'){
                html+= '<td>'+i+'</td>';
                }else if(keys[j]=='Color.name'){
                html+= '<td>'+data[i].Color.name+'</td>';
                }else if(keys[j]=='Color.sku'){
                html+= '<td>'+data[i].Color.sku+'</td>';
                }else if(keys[j]=='Color.val'){
                html+= '<td>'+data[i].Color.val+'</td>';
                }else if(keys[j]=='orderdate'){
                html+= '<td>'+formatDateDisplay(data[i][keys[j]])+'</td>';
                }else if(keys[j]=='starttime' || keys[j]=='CompletionDate'){
                html+= '<td>'+formatDateDisplay2(data[i][keys[j]])+'</td>';
                }else{
                html+= '<td>'+data[i][keys[j]]+'</td>';
                }
              
            }
           html +='</tr>';
          }
      
          
         html+='</tbody></table>';
             $('#Mixing').html(html);

   
   
   }

    function populateMixingTeamTab() {
        google.script.run.withSuccessHandler(buildMixingTeamTable).getSheetData('MixingTeam');


    }
    


    function buildMixingTeamTable(data) {
    $(".searchBoxMixing").hide();
     $(".searchBoxMixingTeam").show();
      getSearchBoxData('MixingTeam');

    console.log(data);
  
        var html = '';
        thisData=data;
        thisPage='MixingTeam';
        var qtyTotal=0;
        var rowsTotal=0;

        html += '<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Completed</th><th>Priority</th><th>Date of Production</th><th>Batch</th><th>Customers</th><th>Order Ids</th><th>Brands</th><th>Mix Batch Code</th><th>Recipe</th><th>Flavour</th><th>Order Date</th><th>QTY(Litres)</th><th>VG (MG)</th><th>AG (MG)</th>';
        html += '<th>PG (MG)</th><th>Nicotine (MG)</th><th>Nicotine Salts (MG)</th><th>CBD (MG)</th><th>MCT (MG)</th><th>Flavour (MG)</th><th>Notes - Mixing Dept</th><th>Location</th><th>Factory</th><th>Start Date</th><th>Completion Date</th><th>VG supplier batch </th><th>PG supplier batch </th><th>Nicotine supplier batch </th><th>Flavour supplier batch </th>';
        html += '</tr>';
         html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>QTY TOTAL</div><div id="qtyTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
         if(data){
         var keys=['Completed','priority','prodDate','batches','customer','orderID','brands','MIXNAME','RECIPE','FLAVOUR','orderDates','QTYTOTAL','VGval','AGval','PGval','Nico','Nicosalts','CBDvalue','MCTval','flavvalue','Notes','Location','factory','starttime','CompletionDate','vgSupplier','pgSupplier','nicSupplier','flavSupplier'];
         var drpdowns='';
         html += '<tr><th></th><th></th>';
         console.log(keys);
         for(var l=0;l<keys.length;l++){
         drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
         }
         }
         html+=drpdowns;
         html+='</tr>';
         html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
     if (data[i].final_status == 'Not Run') {
         html+='<tr>'
         }else if (data[i].final_status == 'Busy') {
          html+='<tr bgcolor="#1BCFEF">'
         }else{
          html+='<tr bgcolor="#1BEF5B">'
         }
        
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].final_status == 'Not Run') {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#MixingMoveNext' + data[i].MIXNAME + '">Line Item Move</a>';
            }
            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteMixingTeam' + data[i].MIXNAME + '">Delete</a>';
            html += ' </div></div></td>';
            var batches=[];
            var orderDates=[];
            var priorities=[];
            var mixARR=[];
             var customers=[];
            var orderIDs=[];
            var brands = [];
               var result = data[i].Batches? Object.keys(data[i].Batches).map(function(key) {return [Number(key), data[i].Batches[key]]; }) : [];

                  for(var j=0;j<result.length;j++){
                    mixARR.push(result[j][1]);
                    
                  }
                  
            for(var j=0;j<mixARR.length;j++){
            try{
            mixARR[j].brand = mixARR[j].brand ? mixARR[j].brand : "";
            brands.push(mixARR[j].brand);
            batches.push(mixARR[j].batch);
            orderDates.push(formatDateDisplay(mixARR[j].orderdate));
            priorities.push(mixARR[j].priority);
            customers.push(mixARR[j].customer);
            orderIDs.push(mixARR[j].orderID);
            }catch(e){console.log('failed to push');}
            }
            
                    
        data[i].flavvalue=data[i].flavvalue ? data[i].flavvalue: ' ';
        data[i].VGval=data[i].VGval ? data[i].VGval: ' ';
        data[i].AGval=data[i].AGval ? data[i].AGval: ' ';
        data[i].PGval=data[i].PGval ? data[i].PGval: ' ';
        data[i].Nico=data[i].Nico ? data[i].Nico: ' ';
        data[i].Nicosalts=data[i].Nicosalts ? data[i].Nicosalts: ' ';
        data[i].CBDvalue=data[i].CBDvalue ? data[i].CBDvalue: ' ';
        data[i].MCTval=data[i].MCTval ? data[i].MCTval: ' ';
      
            
            html += '<td><button page="MixingTeam" batch="'+data[i].MIXNAME+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="MixingTeam" batch="'+data[i].MIXNAME+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
            html += '<td>' + data[i].Completed + '</td><td>' + priorities.join() + '</td><td>' + formatDateDisplay2(data[i].prodDate) + '</td><td>' + batches.join() + '</td><td>' + customers.join() + '</td><td>' + orderIDs.join() + '</td><td>' + brands.join() + '</td><td>' + data[i].MIXNAME + '</td><td>' + data[i].RECIPE + '</td>';
            html += '<td>' + data[i].FLAVOUR + '</td><td>' + orderDates.join() + '</td><td>' + data[i].QTYTOTAL + '</td><td>' + data[i].VGval + '</td><td>' + data[i].AGval + '</td><td>' + data[i].PGval + '</td><td>' + data[i].Nico + '</td><td>' + data[i].Nicosalts + '</td><td>' + data[i].CBDvalue + '</td><td>' + data[i].MCTval + '</td>';
            html += '<td>' + data[i].flavvalue + '</td><td>' + data[i].Notes + '</td>';
            html += '<td>' + data[i].Location + '</td>';
             if(data[i].factory){
             html += '<td><select class="form-control" onChange=changefactory(this); batch="'+data[i].MIXNAME+'" ><option factory="' + data[i].factory + '" value="' + data[i].factory + '">' + data[i].factory + '</option>';
            }else{
             html += '<td><select class="form-control" batch="'+data[i].MIXNAME+'"  onChange=changefactory(this);><option ></option>';
            }
           
            html += '<option factory="Manchester" value="Manchester">Manchester</option>';
            html += '<option factory="Halifax" value="Halifax">Halifax</option>';
        
            html += '</select></td>';
            html += '<td>'+formatDateDisplay2(data[i].starttime)+'</td><td>'+formatDateDisplay2(data[i].CompletionDate)+'</td><td>'+data[i].vgSupplier+'</td><td>'+data[i].pgSupplier+'</td><td>'+data[i].nicSupplier+'</td><td>'+data[i].flavSupplier+'</td></tr>';
        
    
       if(data[i].QTYTOTAL){
        qtyTotal+=data[i].QTYTOTAL;
        }
        }
        rowsTotal=i;
        }
        html += '</tbody></table>';


        $('#Mixing').html(html);
        $('#qtyTotal'+thisPage).html(qtyTotal);
        $('#rowsTotal'+thisPage).html(rowsTotal);

    }


function changefactory(event){
var factory=$(event).val();
var mixbatch=$(event).attr('batch');
google.script.run.withSuccessHandler(updateMachine).changeFactory(mixbatch,factory);

}







    function populateProductionTab() {
        google.script.run.withSuccessHandler(buildProductionTable).getSheetData('Production');

    }

    function buildProductionTable(data) {
     google.script.run.withSuccessHandler(buildMachinesOptions2).getMachines();
    function buildMachinesOptions2(rett){
    var machines=rett[0];
    
        var html = '';
        thisData=data;
        thisPage='Production';
        var bottlesTotal=0;
        var rowsTotal=0;

        html += '<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Mixing Completed</th><th>Order Date</th><th>Batch</th><th>Order ID</th><th>Code</th><th>Description</th><th>Mix Batch Code</th><th>Priority</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th>';
        html += '<th>Bottles</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th><th>Start Date</th><th>Completion Date</th><th>Production Completed</th><th>Location</th><th>Machine</th>';
        html += '</tr>';
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
        if(data){
         var keys=['mixing_status','orderdate','batch','orderID','productcode','productdescription','mixbatch','priority','customer','brand','recipe.name','flavour.name','bottles','btype','lid','packagingType.name','starttime','CompletionDate','Completed','Location','machineP'];
         var drpdowns='';
         html += '<tr><th></th><th></th>';
         console.log(keys);
         for(var l=0;l<keys.length;l++){
         
         drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
         }
         }
         html+=drpdowns;
         html+='</tr>';
         html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
          if(!data[i].recipe){continue;}
      if (data[i].final_status == 'Not Run') {
         html+='<tr>'
         }else if (data[i].final_status == 'Busy') {
          html+='<tr bgcolor="#1BCFEF">'
         }else{
          html+='<tr bgcolor="#1BEF5B">'
         }
       
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].final_status == 'Not Run') {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#ProductionMoveNext' + data[i].batch + '">Line Item Move</a>';
            }
            
            html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select'+data[i].batch+'" href="#select' + data[i].batch + '">Select</a>';
            html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect'+data[i].batch+'" href="#select' + data[i].batch + '">Deselect</a>';
            
            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteProduction' + data[i].batch + '">Delete</a>';
            html += ' </div></div></td>';
            html += '<td><button page="Production" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Production" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
             data[i].priority=data[i].priority == 0 ? data[i].priority: ' ';
            html += '<td>' + data[i].mixing_status + '</td><td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + data[i].batch + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].mixbatch + '</td><td>' + data[i].priority + '</td><td>' + data[i].customer + '</td><td>' + data[i].brand + '</td><td>' + data[i].recipe.name + '</td>';
            html += '<td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td><td>' + data[i].packagingType.name + '</td><td>'+formatDateDisplay2(data[i].starttime)+'</td><td>' + formatDateDisplay2(data[i].CompletionDate) + '</td>';
             html += '<td>' + data[i].Completed + '</td><td>' + data[i].Location + '</td>';
             var machinePDisp='';
             if(data[i].machineP){
             
             
             for(var m=0;m<machines.length;m++){
             if(data[i].machineP==machines[m].sku){
             machinePDisp=machines[m].name;
             break;
             }
             }
             
             }
            html += ' <td>' + machinePDisp + '</td></tr>';
            bottlesTotal+=parseInt(data[i].bottles,10);
            
            }
            rowsTotal=i;
        }
        html += '</tbody></table>';


        $('#Productionbody').html(html);
 $('#bottlesTotal'+thisPage).html(bottlesTotal);
 $('#rowsTotal'+thisPage).html(rowsTotal);
    }

}








    function populatePrintingTab() {
        google.script.run.withSuccessHandler(buildPrintingTable).getSheetData('Printing');

    }
    
    function buildPrintingTable(data) {
  
    var html = '';
    thisData=data;
    thisPage='Printing';
    var bottlesTotal=0;
    var rowsTotal=0;
     var botlabels=0;
    var tubelabels=0;
        html += '<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Production Status</th><th>Order Date</th><th>Batch</th><th>Bottle Labels QTY</th><th>Cylinder Labels QTY</th><th>Exp. Date</th><th>Order ID</th><th>Code</th><th>Description</th><th>Priority</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th>';
        html += '<th>Bottles</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th><th>Label</th><th>Outer Box</th><th>Start Date</th><th>Completion Date</th><th>Production Completed</th><th>Location</th>';
        html += '</tr>';
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th><div>BOTTLE LABELS TOTAL</div><div id="numLabelsBottlesTotal'+thisPage+'"></div></th><th><div>PACK LABELS TOTAL</div><div id="numLabelsTubesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
        if(data){
         var keys=['production_status','orderdate','batch','numLabelsBottles','numLabelsTubes','expDate','orderID','productcode','productdescription','priority','customer','brand','recipe.name','flavour.name','bottles','btype','lid','packagingType.name','botlabel','boxname.name','starttime','CompletionDate','Completed','Location'];
         var drpdowns='';
         html += '<tr><th></th><th></th>';
         console.log(keys);
         for(var l=0;l<keys.length;l++){
         drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
         }
         }
         html+=drpdowns;
         html+='</tr>';
         html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
          if(!data[i].recipe){continue;}
     if (data[i].final_status == 'Not Run') {
     
         html+='<tr>'
         }else if (data[i].final_status == 'Busy') {
          html+='<tr bgcolor="#1BCFEF">'
         }else{
          html+='<tr bgcolor="#1BEF5B">'
         }
     
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].final_status == 'Not Run') {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#PrintingMoveNext' + data[i].batch + '">Line Item Move</a>';
            }
            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deletePrinting' + data[i].batch + '">Delete</a>';
            html += ' </div></div></td>';
            html += '<td><button page="Printing" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button>';
            html += '<button onclick="moveDown(this)" page="Printing" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
        
            html += '<td>' + data[i].production_status + '</td><td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + data[i].batch + '</td><td>' + data[i].numLabelsBottles + '</td><td>' + data[i].numLabelsTubes + '</td><td>' + data[i].expDate + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].priority + '</td><td>' + data[i].customer + '</td><td>' + data[i].brand + '</td><td>' + data[i].recipe.name + '</td>';
            html += '<td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td><td>' + data[i].packagingType.name + '</td><td>' + data[i].botlabel + '</td><td>' + data[i].boxname.name + '</td><td>'+formatDateDisplay2(data[i].starttime)+'</td><td>' + formatDateDisplay2(data[i].CompletionDate) + '</td>';
            html += '<td>' + data[i].Completed + '</td><td>' + data[i].Location + '</td></tr>';
            bottlesTotal+=parseInt(data[i].bottles,10);
            botlabels+=parseInt(data[i].numLabelsBottles,10);
            tubelabels+=parseInt(data[i].numLabelsTubes,10);
            }
            rowsTotal=i;
            
            
            }
            html += '</tbody></table>';
            
            
            $('#Printingbody').html(html);
            $('#bottlesTotal'+thisPage).html(bottlesTotal);
            $('#rowsTotal'+thisPage).html(rowsTotal);
            $('#numLabelsBottlesTotal'+thisPage).html(botlabels);
            $('#numLabelsTubesTotal'+thisPage).html(tubelabels);
    }












    function populateLabellingTab() {
        google.script.run.withSuccessHandler(buildLabellingTable).getSheetData('Labelling');

    }

    function buildLabellingTable(data) {
   
    var html = '';
    thisData=data;
    thisPage='Labelling';
    var bottlesTotal=0;
    var rowsTotal=0;
        html += '<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Production Status</th><th>Order Date</th><th>Batch</th><th>Order ID</th><th>Code</th><th>Description</th><th>Priority</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th>';
        html += '<th>Bottles</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th><th>Start Date</th><th>Completion Date</th><th>Production Completed</th><th>Location</th><th>Machine</th>';
        html += '</tr>';
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
        
         if(data){
         var keys=['production_status','orderdate','batch','orderID','productcode','productdescription','priority','customer','brand','recipe.name','flavour.name','bottles','btype','lid','packagingType.name','starttime','CompletionDate','Completed','Location','machineL'];
         var drpdowns='';
         html += '<tr><th></th><th></th>';
         console.log(keys);
         for(var l=0;l<keys.length;l++){
         drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
         }
         }
         html+=drpdowns;
         html+='</tr>';
         html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
          if(!data[i].recipe){continue;}
      if (data[i].final_status == 'Not Run') {
         html+='<tr>'
         }else if (data[i].final_status == 'Busy') {
          html+='<tr bgcolor="#1BCFEF">'
         }else{
          html+='<tr bgcolor="#1BEF5B">'
         }
  
       
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].final_status == 'Not Run') {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#LabellingMoveNext' + data[i].batch + '">Line Item Move</a>';
            }
            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteLabelling' + data[i].batch + '">Delete</a>';
            html += ' </div></div></td>';
            
             html += '<td><button page="Labelling" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button>';
            html += '<button onclick="moveDown(this)" page="Labelling" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
             data[i].priority=data[i].priority == 0 ? data[i].priority: ' ';
            html += '<td>' + data[i].production_status + '</td><td>' +formatDateDisplay( data[i].orderdate) + '</td><td>' + data[i].batch + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].priority + '</td><td>' + data[i].customer + '</td><td>' + data[i].brand + '</td><td>' + data[i].recipe.name + '</td>';
            html += '<td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td><td>' + data[i].packagingType.name + '</td><td>'+formatDateDisplay2(data[i].starttime)+'</td><td>' + formatDateDisplay2(data[i].CompletionDate) + '</td>';
            html += '<td>' + data[i].Completed + '</td><td>' + data[i].Location + '</td><td>' + data[i].machineL + '</td></tr>';
            bottlesTotal+=parseInt(data[i].bottles,10);
            
            }
            rowsTotal=i;
            
            
            }
        html += '</tbody></table>';


        $('#Labellingbody').html(html);
        $('#bottlesTotal'+thisPage).html(bottlesTotal);
        $('#rowsTotal'+thisPage).html(rowsTotal);
    }
    
    
    
    
    
    
    
    
    
    
    

    function populatePackagingTab() {
        google.script.run.withSuccessHandler(buildPackagingTable).getSheetData('Packaging');

    }

    function buildPackagingTable(data) {
  console.log(data);
    var html = '';
    thisData=data;
    thisPage='Packaging';
    var bottlesTotal=0;
    var rowsTotal=0;
        html += '<table class="table"><thead><tr><th>Menu</th><th>Move</th><th>Production Status</th><th>Printing Status</th><th>Order Date</th><th>Batch</th><th>Order ID</th><th>Code</th><th>Description</th><th>Packaging Code</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th>';
        html += '<th>Bottles</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th><th>Start Date</th><th>Completion Date</th><th>Packaging Completed</th><th>Location</th>';
        html += '</tr>';
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
         if(data){
         var keys=['production_status','printing_status','orderdate','batch','orderID','productcode','productdescription','PRINTCODE','customer','brand','recipe.name','flavour.name','bottles','btype','lid','packagingType.name','starttime','CompletionDate','Completed','Location'];
         var drpdowns='';
         html += '<tr><th></th><th></th>';
         console.log(keys);
         for(var l=0;l<keys.length;l++){
         drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
         }
         }
         html+=drpdowns;
         html+='</tr>';
         html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
          if(!data[i].recipe){continue;}
         if (data[i].final_status == 'Not Run') {
         html+='<tr>'
         }else if (data[i].final_status == 'Busy') {
          html+='<tr bgcolor="#1BCFEF">'
         }else{
          html+='<tr bgcolor="#1BEF5B">'
         }
  
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].final_status == 'Not Run') {
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#PackagingMoveNext' + data[i].batch + '">Line Item Move</a>';
            }
            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deletePackaging' + data[i].batch + '">Delete</a>';
            
                html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select'+data[i].batch+'" href="#select' + data[i].batch + '">Select</a>';
            html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect'+data[i].batch+'" href="#select' + data[i].batch + '">Deselect</a>';
            
            html += ' </div></div></td>';
            
           
            
            html += '<td><button page="Packaging" batch="'+data[i].batch+'" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button>';
            html += '<button onclick="moveDown(this)" page="Packaging" batch="'+data[i].batch+'" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
           
            html += '<td>' + data[i].production_status + '</td><td>' + data[i].printing_status + '</td><td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + data[i].batch + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].PRINTCODE + '</td>';
              html += '<td>' + data[i].customer + '</td><td>' + data[i].brand + '</td><td>' + data[i].recipe.name + '</td>';
            html += '<td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td><td>' + data[i].packagingType.name + '</td><td>'+formatDateDisplay2(data[i].starttime)+'</td><td>' + formatDateDisplay2(data[i].CompletionDate) + '</td>';
            html += '<td>' + data[i].Completed + '</td><td>' + data[i].Location + '</td></tr>';
        bottlesTotal+=parseInt(data[i].bottles,10);
       }
         rowsTotal=i;
        }
        html += '</tbody></table>';


    $('#Packagingbody').html(html);
    $('#bottlesTotal'+thisPage).html(bottlesTotal);
    $('#rowsTotal'+thisPage).html(rowsTotal);

    }

    function populateShippingTab() {
        google.script.run.withSuccessHandler(buildShippingTable).getShippingData();


    }

    function buildShippingTable(data) {
 
    var html = '';
    thisData=data;
    thisPage='Shipping';
    var bottlesTotal=0;
    var rowsTotal=0;

        html += '<table class="table table-striped"><thead><tr><th>Menu</th><th>Order Date</th><th>Batch</th><th>Order ID</th><th>Code</th><th>Description</th><th>Priority</th><th>Packaging Code</th><th>Customer</th><th>Brand</th><th>Recipe</th><th>Flavour</th><th>Bottles</th><th>Bottle Type</th><th>Lid Type</th><th>Pack Type</th>';
        html += '<th>Status</th><th>Shipping Status</th><th>Shipping Code</th><th>Date Shipped</th><th>Tracking No.</th><th>Date Delivered</th><th>Location</th></tr>';
        html += '<tr><th><div>ROWS TOTAL</div><div id="rowsTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th><div>BOTTLES TOTAL</div><div id="bottlesTotal'+thisPage+'"></div></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr>';
        if(data){
        var keys=['orderdate','batch','orderID','productcode','productdescription','priority','PRINTCODE','customer','brand','recipe.name','flavour.name','bottles','btype','lid','packagingType.name','final_status','shipping_status','SHIPPINGCODE',
        'dateshipped','trackingNo','datedelivered', 'Location'];
        var drpdowns='';
        html += '<tr><th></th>';
        console.log(keys);
        for(var l=0;l<keys.length;l++){
        
        drpdowns+=('<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#'+keys[l]+'" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#'+keys[l]+'" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>');
        }
        }
        html+=drpdowns;
        html+='</tr>';
        html += '</thead>';
        html += '<tbody>';
        if(data!=''){
        for (var i = 0; i < data.length; i++) {
  if(!data[i].recipe){continue;}
 
         
          data[i].priority=data[i].priority == 0 ? data[i].priority: ' ';
            html += '<tr><td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';


            html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteShipping' + data[i].batch + '">Delete Batch</a>';
            html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal3" href="#editShipping' + data[i].batch + '">Edit</a>';

            html += ' </div></div></td>';
            html += '<td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + data[i].batch + '</td><td>' + data[i].orderID + '</td><td>' + data[i].productcode + '</td><td>' + data[i].productdescription + '</td><td>' + data[i].priority + '</td><td>' + data[i].PRINTCODE + '</td><td>' + data[i].customer + '</td><td>' + data[i].brand + '</td>';
            html += '<td>' + data[i].recipe.name + '</td><td>' + data[i].flavour.name + '</td><td>' + data[i].bottles + '</td><td>' + data[i].btype + '</td><td>' + data[i].lid + '</td>';
            html += '<td>' + data[i].packagingType.name + '</td><td>' + data[i].final_status + '</td><td>' + data[i].shipping_status + '</td><td>' + data[i].SHIPPINGCODE + '</td><td>' + data[i].dateshipped + '</td><td>' + data[i].trackingNo + '</td>';
            html += '<td>' + data[i].datedelivered + '</td><td>' + data[i].Location + '</td></tr>';
        
        bottlesTotal+=parseInt(data[i].bottles,10);
        }
          rowsTotal=i;

        }
        html += '</tbody></table>';


$('#Shippingbody').html(html);
$('#bottlesTotal'+thisPage).html(bottlesTotal);
$('#rowsTotal'+thisPage).html(rowsTotal);


    }

    function editShipping(batch) {
    console.log(batch);
        google.script.run.withSuccessHandler(buildShippingFormFromExisting).getSingleShippingData(batch);
    }

    function buildShippingFormFromExisting(data) {
        console.log(data);
        var html = '';

        html += '<table class="form_table">';
        html += '<tr><td><h4>Batch</h4></td><td><h4>Order ID</h4></td><td><h4>Shipping Status</h4></td><td><h4>Date Shipped</h4></td><td><h4>Tracking No.</h4></td><td><h4>Date Delivered</h4></td><td><h4>Location</h4></td></tr>';
        html += '<tr><td><div class="input-group"><input type="text" id="shippingbatch" class="form-control" value="'+data.batch+'" placeholder="' + data.batch + '" disabled aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="orderID" class="form-control" placeholder="Order ID" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="shipping_status" class="form-control" placeholder="Shipping Status" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="date" id="dateshipped" class="form-control" placeholder="Date Shipped" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="trackingNo" class="form-control" placeholder="Tracking No." aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="date" id="datedelivered" class="form-control" placeholder="Date Delivered" aria-describedby="sizing-addon2"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="shippinglocation" class="form-control" placeholder="Location" aria-describedby="sizing-addon2"></div></td>';
        html += '</tr></table>'

        $('.modal-body3').html(html);

        $('#orderID').val(data.orderID);
        $('#shipping_status').val(data.shipping_status);
        $('#dateshipped').val(data.dateshipped);
        $('#trackingNo').val(data.trackingNo);
        $('#datedelivered').val(data.datedelivered);
        $('#shippinglocation').val(data.Location);


    }


    $('#subModalForm3').on('click', function(e) {
        var batch = $('#shippingbatch').val();
        var orderID = $('#orderID').val();
        var shipping_status = $('#shipping_status').val();
        var dateshipped = $('#dateshipped').val();
        var trackingNo = $('#trackingNo').val();
        var datedelivered = $('#datedelivered').val();
        var Location = $('#shippinglocation').val();
        var obj = {
            orderID: orderID,
            shipping_status: shipping_status,
            dateshipped: dateshipped,
            trackingNo: trackingNo,
            datedelivered: datedelivered,
            Location: Location
        };
        console.log(batch);
        console.log(obj);
        google.script.run.withSuccessHandler(refreshShipping).updateShippingItem(batch, obj);

    });

    function refreshShipping() {
        populateShippingTab();
    }


    function populateQTYTab(page) {
        $("#updating").css("display", "block");
        console.log('started');
        console.log('page',page);
        google.script.run.withSuccessHandler(splitPages).getQTY(page);
    }

    function populateQTYTable(data,page) {
  
       
        var html = '';
    
        html += '<table class="table"><thead><tr><th>Row</th><th>SKU</th><th>Menu</th><th>Name</th><th>Running</th><th>Reserved</th><th>Completed</th><th>Stock on Order</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < data.length; i++) {
        try{
   
            if (data[i] == null) {
                continue;
            }
             if (!data[i].sku) {
                continue;
            }
            if(isNaN(data[i].Running)){
            data[i].Running=0;
            }
            if(isNaN(data[i].Reserved)){
            data[i].Reserved=0;
            }
            if(isNaN(data[i].Completed)){
            data[i].Completed=0;
            }
            html += '<tr>';
            html += '<td>' + i + '</td>';
            html += '<td>' + data[i].sku + '</td>';
         
            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';

            if(page=='BrandedTypes'||page=='UnbrandedTypes'||page=='PremixesTypes'||page=='Packages'||page=='Labels'||page=='Boxes'||page=='Flavours'||page=='BottleTypes'||page=='Lids'||page=='Color'){
            html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal4" page="'+page+'" href="#editQTY' + data[i].sku + '">Edit</a></div></div></td>';
            
            }else{
            html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal4" page="'+page+'" href="#editQTY' + data[i].name + '">Edit</a></div></div></td>';
            
            }
            if(page=='Flavours'||page=='PremixesTypes'){
            html += '<td>' + data[i].name + '</td><td>' + parseFloat(data[i].Running).toFixed(2) + '</td><td>' + parseFloat(data[i].Reserved).toFixed(2) + '</td><td>' + parseFloat(data[i].Completed).toFixed(2) + '</td>';
            }else{
            html += '<td>' + data[i].name + '</td><td>' + data[i].Running + '</td><td>' + data[i].Reserved + '</td><td>' + data[i].Completed + '</td>';

            }
            if(data[i].Stock){
            html+='<td>' + data[i].Stock + '</td></tr>';
            }else{html+='<td>0</td></tr>';}
            
        }catch(e){console.log(data[i],e);}
        }
        html += '</tbody></table>';
        $("#updating").css("display", "none");
        console.log('done');
        $('#QTYbody').html(html);
        



    }
   
var editpage;
function editQTY(id,page) {
editpage=page;

google.script.run.withSuccessHandler(buildQTYFormFromExisting).getSingleQTYData(id,page);

}

    function buildQTYFormFromExisting(dat) {
    var data=dat.data;
    var page=dat.page;
  //  console.log(data);
        var html = '';
        html += '<table class="form_table">';
      
      html += '<tr><td><h4>' + data.name + '</h4></td><td><tr>';
      if(page=='BrandedTypes'||page=='UnbrandedTypes'||page=='PremixesTypes'||page=='Packages'||page=='Labels'||page=='Boxes'||page=='Flavours'||page=='BottleTypes'||page=='Lids'||page=='Color'){
      html += '<tr><td><div class="input-group"><input type="text" id="qtyID" value ="' + data.sku + '" class="form-control" placeholder="' + data.sku + '" disabled aria-describedby="sizing-addon1"></div></td></tr>';
      html += '<tr><td><div class="input-group"><input type="text" id="qtyname" value ="' + data.name + '" class="form-control" placeholder="' + data.name + '"  aria-describedby="sizing-addon1"></div></td></tr>';
      }else{
      
      html += '<tr><td><div class="input-group"><input type="text" id="qtyID" value ="' + data.name + '" class="form-control" placeholder="' + data.name + '" disabled aria-describedby="sizing-addon1"></div></td></tr>';
      html += '<tr><td><div class="input-group"  style="display:none;" ><input type="text" id="qtyname" value ="' + data.name + '" class="form-control" placeholder="' + data.name + '" aria-describedby="sizing-addon1"></div></td></tr>';
      
      }
      html +='</table><table class="form_table">'
       html += '<tr><td><h4>Running</h4></td><td><h4>Reserved</h4></td><td><h4>Completed</h4></td></tr>';

   html += '<tr><td><div class="input-group"><input type="text" id="Running" class="form-control" aria-describedby="sizing-addon1"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="Reserved" class="form-control"  aria-describedby="sizing-addon1"></div></td>';
        html += '<td><div class="input-group"><input type="text" id="Completed" class="form-control" aria-describedby="sizing-addon1"></div></td></tr>';

    html+='</table>';
        $('.modal-body4').html(html);
        $('#Completed').val(data.Completed);
        $('#Running').val(data.Running);
        $('#Reserved').val(data.Reserved);
        $('#qtyname').val(data.name);


    }


    $('#subModalForm4').on('click', function(e) {
        var dataname = $('#qtyID').val();
        if(editpage=='Flavours' ||editpage=='PremixesTypes'){
        var Running = parseFloat($('#Running').val());
        var Reserved = parseFloat($('#Reserved').val());
        var Completed = parseFloat($('#Completed').val());
        }else{
        var Running = parseInt($('#Running').val(), 10);
        var Reserved = parseInt($('#Reserved').val(), 10);
        var Completed = parseInt($('#Completed').val(), 10);
        }
        var name =  $('#qtyname').val();
        var obj = {
            Completed: Completed,
            Reserved: Reserved,
            Running: Running,
            name:name,

        };
        console.log(obj);
        google.script.run.withSuccessHandler(populateQTYTab).updatesingleQTY(dataname,editpage, obj);

    });

    function refreshQTY(page) {
        populateQTYTab(page);
    }

    function populateLocationsTab() {
        google.script.run.withSuccessHandler(refreshLocations).getLocations();

    }


    function refreshLocations(fulldata) {
        var mixingSheet = fulldata[5];
        var Production = fulldata[4];
        var Printing = fulldata[3];
        var Labelling = fulldata[2];
        var Packaging = fulldata[1];
        var shipping = fulldata[0];
      console.log(fulldata);
      
        var html = '';
        html += '<table class="table table-striped"><thead><tr><th>Mixing Team</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Shipping</th></tr></thead>';
        html += '<tr><td><table class="table table-striped">';

        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < mixingSheet.length; i++) {
            html += '<tr><th>' + mixingSheet[i].MIXNAME + '</th><th>' + mixingSheet[i].RECIPE + '</th><th>' + mixingSheet[i].FLAVOUR + '</th><th>' + mixingSheet[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td>';


        html += '<td><table class="table table-striped">';
        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < Production.length; i++) {
          if(!Production[i].recipe){continue;}
            html += '<tr><th>' + Production[i].batch + '</th><th>' + Production[i].recipe.name + '</th><th>' + Production[i].flavour.name + '</th><th>' + Production[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td>';



        html += '<td><table class="table table-striped">';
        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < Printing.length; i++) {
                  if(!Printing[i].recipe){continue;}
            html += '<tr><th>' + Printing[i].batch + '</th><th>' + Printing[i].recipe.name + '</th><th>' + Printing[i].flavour.name + '</th><th>' + Printing[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td>';


        html += '<td><table class="table table-striped">';
        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < Labelling.length; i++) {
                  if(!Labelling[i].recipe){continue;}
            html += '<tr><th>' + Labelling[i].batch + '</th><th>' + Labelling[i].recipe.name + '</th><th>' + Labelling[i].flavour.name + '</th><th>' + Labelling[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td>';


        html += '<td><table class="table table-striped">';
        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < Packaging.length; i++) {
             if(!Packaging[i].recipe){continue;}
            html += '<tr><th>' + Packaging[i].batch + '</th><th>' + Packaging[i].recipe.name + '</th><th>' + Packaging[i].flavour.name + '</th><th>' + Packaging[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td>';

        html += '<td><table class="table table-striped">';
        html += '<thead><tr><th>Batch</th><th>Recipe</th><th>Flavour</th><th>Location</th></tr></thead>';
        html += '<tbody>';
        for (var i = 0; i < shipping.length; i++) {
             if(!shipping[i].recipe){continue;}
            html += '<tr><th>' + shipping[i].batch + '</th><th>' + shipping[i].recipe.name + '</th><th>' + shipping[i].flavour.name + '</th><th>' + shipping[i].Location + '</th></tr>'

        }
        html += '</tbody></table></td></tr></tbody></table>';

        $('#Locationbody').html(html);




    }

   


    function deleteItem(batch, tab) {
        google.script.run.withSuccessHandler(lineItemResult).removeItem(batch, tab,'Admin');
    }

    function lineItemMove(batch, tab) {
        google.script.run.withSuccessHandler(lineItemResult).MoveItem(batch, tab,'Admin');


    }

    function lineItemResult(e) {
        alert(e[0]);
        console.log(LASTSEARCH);
        var current = e[1];
        selPage=current;
         google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);

    }



    $('#subflavourForm').on('click', function(e) {
        var name = $('#flavName').val();
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Flavours');
    });
    
    $('#subflavourmixForm').on('click', function(e) {
    var special='';
    var newFLAVOURSARR=[];
    if(EDIT_FLAVMIX_CONST){
    
    special='.editflavourmixBody #e';
    }else{
    special='.newflavourmixBody #';
    }
    
    var obj = {
    sku:$(special+'flavourmixSKU').val(),
    name: $(special+'flavourmixName').val(),
    flavours: {},
    
    
    };
    if(obj.sku==''){
    alert('No SKU.');
    return 0;
    }  
    for(var i=1;i<=flavournum;i++){
    console.log('i',i,'flavournum',flavournum);
    if(NEWFLAVOURSINFLAVOURMIX.indexOf(i.toString())>=0){
    var flavoursku = $(special+'flavourSelectSKU'+i).val();
    var name= $(special+'flavourSelectNAME'+i).val();
    var val=$(special+'flavourAmount'+i).val()
    var BASEflavour={
    sku:flavoursku,
    name:name,
    };
    newFLAVOURSARR.push(BASEflavour);
    //google.script.run.withSuccessHandler(newflavourSuccess).newBasicItem(BASEflavour, 'Flavours');
    obj.flavours[flavoursku]={
    sku:flavoursku,
    val:parseFloat(val),
    name:name,
    };
    }else{
    var flavoursku = $(special+'flavourSelect'+i).val();
    var name= $(special+'flavourSelect'+i+' option:selected').text();
    var val=$(special+'flavourAmount'+i).val()
    obj.flavours[flavoursku]={
    sku:flavoursku,
    val:parseFloat(val),
    name:name,
    };
    

    }
    }
    

    
    
    if(EDIT_FLAVMIX_CONST){
    
    
    if(OLDITEM){
    if(obj.sku!=OLDITEM.sku){
    alert('The unique ID can not be edited. \n Other Changes will be saved.');
    obj.sku=OLDITEM.sku;
    }
    OLDITEM={};
    }
    }
    
    
    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'FlavourMixes');
    $(special+'flavourmixSKU').val('');
    $(special+'flavourmixName').val('');
    $(special+'flavourDropdowns').html('');
    if(newFLAVOURSARR.length>0){
    google.script.run.withSuccessHandler(newbasicitemsuccess).newFlavoursArray(newFLAVOURSARR);
    }
    });
    
    
    $('#subCustomerForm').on('click', function(e) {
    var obj={
    name:$('#custName').val(),
    address:$('#custAddress').val(),
    }
     
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Customers');
    });


    $('#subBottleForm').on('click', function(e) {
        var name = $('#bottletypeinput').val();
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'BottleTypes');
    });
    $('#subBrandForm').on('click', function(e) {
        var name = $('#brandid').val();
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Brands');
    });

    $('#subLidForm').on('click', function(e) {
        var name = $('#lidid').val();
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Lids');
    });
    $('#subMiscForm').on('click', function(e) {
        var name = $('#miscid').val();
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Misc');
    });



 $('#subBoxForm').on('click', function(e) {

         var special='';
        if(EDIT_BOX_CONST){
        
        special='.editBoxBody #e';
        }else{
        special='.newBoxBody #';
        }

        var obj = {
            sku:$(special+'boxSKU').val(),
            name: $(special+'boxName').val(),
            divTubesForBox: parseInt($(special+'divTubesForBox').val(), 10),


        };
        
    if(obj.sku==''){
    alert('No SKU.');
    return 0;
    }    


    if(EDIT_BOX_CONST){
      
        
         if(OLDITEM){
         if(obj.sku!=OLDITEM.sku){
         alert('The unique ID can not be edited. \n Other Changes will be saved.');
         obj.sku=OLDITEM.sku;
         }
         OLDITEM={};
         }
        }
     
       
        console.log(obj);
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Boxes');
        $(special+'boxSKU').val('');
        $(special+'boxName').val('');
        $(special+'divTubesForBox').val('');



    });
  
      $('#subLabelForm').on('click', function(e) {
      
      var special='';
      if(EDIT_LABEL_CONST){
      
      special='.editLabelBody #e';
      }else{
      special='.newLabelBody #';
      }
      
      var obj = {
      sku:$(special+'LabelSKU').val(),
      name: $(special+'LabelName').val(),
      
      
      
      };
      
      if(obj.sku==''){
      alert('No SKU.');
      return 0;
      }    
      
      
      if(EDIT_LABEL_CONST){
      
      
      if(OLDITEM){
      if(obj.sku!=OLDITEM.sku){
      alert('The unique ID can not be edited. \n Other Changes will be saved.');
      obj.sku=OLDITEM.sku;
      }
      OLDITEM={};
      }
      }
      
      
      console.log(obj);
      google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Labels');
      $(special+'LabelSKU').val('');
      $(special+'LabelName').val('');
      
      
      
      
      });
      
      
      $('#subColorForm').on('click', function(e) {
      
      var special='';
      if(EDIT_COLOR_CONST){
      
      special='.editColorBody #e';
      }else{
      special='.newColorBody #';
      }
      
      var obj = {
      sku:$(special+'ColorSKU').val(),
      name: $(special+'ColorName').val(),
      
      
      
      };
      
      if(obj.sku==''){
      alert('No SKU.');
      return 0;
      }    
      
      
      if(EDIT_COLOR_CONST){
      
      
      if(OLDITEM){
      if(obj.sku!=OLDITEM.sku){
      alert('The unique ID can not be edited. \n Other Changes will be saved.');
      obj.sku=OLDITEM.sku;
      }
      OLDITEM={};
      }
      }
      
      
      console.log(obj);
      google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Color');
      $(special+'ColorSKU').val('');
      $(special+'ColorName').val('');
      
      
      
      
      });
    $('#subPackagingForm').on('click', function(e) {

         var special='';
        if(EDIT_PACKAGING_CONST){
        
        special='.editPackagingBody #e';
        }else{
        special='.newPackagingBody #';
        }

 var tubetext=$(special+'tubelabel option:selected').text();
 var tubesku=$(special+'tubelabel').val();
        var obj = {
            sku:$(special+'packagingSKU').val(),
            name: $(special+'packagingName').val(),
            botperPack: parseInt($(special+'botperPack').val(), 10),

            tubelabel:{
              name:'',
              sku:'',
            },
            ink: parseFloat($(special+'ink').val()),


        };
        
    if(obj.sku==''){
    alert('No SKU.');
    return 0;
    }    

     obj.tubelabel.sku=tubesku;
     obj.tubelabel.name=tubetext;
    if(EDIT_PACKAGING_CONST){
      
        
         if(OLDITEM){
         if(obj.sku!=OLDITEM.sku){
         alert('The unique ID can not be edited. \n Other Changes will be saved.');
         obj.sku=OLDITEM.sku;
         }
         OLDITEM={};
         }
        }
     
       
        console.log(obj);
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Packages');
        $(special+'packagingSKU').val('');
        $(special+'packagingName').val('');
        $(special+'botperPack').val('');

      
        $(special+'ink').val('');

        $(special+"tubelabel select").val('');
        

    });
    
    
  
   $('#subRecipeForm').on('click', function(e) {
        var special='';
        if(EDIT_RECIPE_CONST){
        
        special='.editRecipeBody #e';
        }else{
        special='.newRecipeBody #';
        }

        var obj = {
            
            vgrec: parseInt($(special+'recipeVG').val(), 10),
            pgrec: parseInt($(special+'recipePG').val(), 10),
            agrec: parseInt($(special+'recipeAG').val(), 10),
            cbdrec:parseInt($(special+'recipeCBD').val(), 10),
            MCTrecipe:parseInt($(special+'recipeMCT').val(), 10),
            nicorec:parseInt($(special+'recipeNicotine').val(), 10),
            nicorecsalts:parseInt($(special+'recipeNicotineSalts').val(), 10),
            Flavrec: parseInt($(special+'recipeFlavour').val(), 10),
            vg:$(special+'recipevgval').val(),
            pg:$(special+'recipepgval').val(),
            strength:$(special+'recipestrength').val(),
            Color:{
            val:'',
            name:'',
            sku:'',
            },
        };
        
        var keys=Object.keys(obj);
        for(var i=0;i<keys.length;i++){
        if(keys[i]=='Color'){continue;}
        if(isNaN(obj[keys[i]])){
          obj[keys[i]]=0;
        }
        }
        if(!isNaN(parseInt($(special+'colorpercentage').val(),10)) &&$(special+'colorSelect').val()){
      
        obj.Color.val=parseInt($(special+'colorpercentage').val(),10);
        obj.Color.name= $(special+'colorSelect option:selected').text();
        obj.Color.sku=$(special+'colorSelect').val();
        }else{
        delete obj.Color;
        }
         obj.id=$(special+'recipeCODE').val();
        obj.name=$(special+'recipeName').val();
        if(obj.id==''){
        alert('No SKU.');
        return 0;
        } 
        if(EDIT_RECIPE_CONST){
      
        
         if(OLDITEM){
         if(obj.id!=OLDITEM.id){
         alert('The unique ID can not be edited. \n Other Changes will be saved.');
         obj.id=OLDITEM.id;
         }
         OLDITEM={};
         }
        }
       // var checked=$('#CBD').val();
       
        console.log(obj);
        google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Recipes');
        $(special+'recipeName').val('');
        $(special+'recipeVG').val('');
        $(special+'recipePG').val('');
           $(special+'recipeAG').val('');
        
        $(special+'recipevgval').val('');
        $(special+'recipepgval').val('');
        $(special+'recipestrength').val('');
        
        $(special+'recipeCBD').val('');
         $(special+'recipeMCT').val('');
        $(special+'recipeNicotine').val('');
        $(special+'recipeNicotineSalts').val('');
        $(special+'recipeFlavour').val('');
        $(special+'recipeCODE').val('');
        $(special+'colorpercentage').val('');
        $(special+'colorSelect').val('');
    });

    function newbasicitemsuccess(resp) {
        alert(resp);
    }





  //  var file, reader = new FileReader();

    $('#subCSVForm').on('click', function(e) {
        var file = $('#CSVID')[0].files[0];
        google.script.run.withSuccessHandler(newbasicitem).serverFunc(file);
    });
    
    var reader = new FileReader();
    var files;
    var fileCounter = 0;
    reader.onloadend = function() {
        console.log('Load ended',reader.result, files[fileCounter].name);
          google.script.run.withSuccessHandler(filesuccess)
        .saveFileCsv(reader.result, files[fileCounter].name);
         $("#updating").css("display", "block");
        return false;
    };
   
   $('#save_btn').on('click', function() {
    SaveFiles();
   });
   function filesuccess(resp){
    $("#updating").css("display", "none");
        $('#checkBatches').modal('show');
     var html='<p >'+resp+'</p>';
      $('#checkBatchesBody').html(html); 
  // alert(resp);
   }
    function SaveFiles() {
    if ($('#myFiles').val() == "") {
        showToast('Please Upload your template!');
        return 0;
    }
     
    var folderSelect = document.getElementById("folderSelectId");
    files = document.getElementById("myFiles").files;
    postNextFile();
}

function postNextFile() {
    if (fileCounter < files.length) {
        reader.readAsDataURL(files[fileCounter]);
    } else {
        fileCounter = 0;
        $('#myFiles').val('');
    }
}


function getSearchDates(data){
console.log('data',data);
var page=selPage;
if(page=='Mixing'){
console.log('page');
console.log(page);
$('#searchDates'+page).show();
$('#searchDatesMixingTeam').hide();
}else if(page=='MixingTeam'||page=='FlavourMixMixingTeam'||page=='PremixColoring'){
console.log('page');
console.log(page);
page='MixingTeam';
$('#searchDatesMixing').hide();
$('#searchDatesMixingTeam').show();

}else if(page=='FlavourMixOrders'){
page='Orders';

}
var dates={

'startDate':$('#searchDates'+page+' #startSearch').val(),
'endDate':$('#searchDates'+page+' #endSearch').val(),
'search':$('#searchDates'+page+' #filterdates').val(),
};

  if(dates.startDate){
    var start=new Date(dates.startDate);
  }else{
    
      var start=new Date('01-01-1970');
  }
  if(dates.endDate){
    var end=new Date(dates.endDate);
  }else{
    
    var end=new Date('01-01-2040');
  }
  var ret=[];
 for(var i=0;i<data.length;i++){
 if(!data[i][dates.search]){
  ret.push(data[i]);
  continue;
 }
 var logitem=new Date(data[i][dates.search]);
 if(logitem.getTime()){}else{

 var from=data[i][dates.search].replace(/\//g,'-').split("-");
    logitem= new Date(from[2], from[1] , from[0]);

 
 }
if(!logitem.getTime()){
console.log(logitem.getTime(),start.getTime(),end.getTime(),dates.search,data[i].batch);
}
    if(start.getTime()<=logitem.getTime() && end.getTime()>=logitem.getTime()){
          ret.push(data[i]);
      
    }
    
 }
  
return ret;
}

var pagesSplit=false;
var lastPage='';
 
var largeData;
function filterResult(rett){
 
console.log('rett',rett);
var page=rett[0];
var data=rett[1];
largeData=data;
  
data=getSearchDates(data);
if(pagesSplit==false){
 data=splitPages([data,page]);

}


lastPage=page;

if(page=='Orders'){
buildOrders(data);
}else if (page == 'FlavourMixOrders') {
buildFlavourMixOrdersTable(data);
}else if (page == 'Mixing') {
buildMixingTable(data);
}else if (page == 'MixingTeam') {
buildMixingTeamTable(data);
}else if (page == 'FlavourMixMixingTeam') {
buildFlavourMixMixingTeamTable(data);
}else if (page == 'PremixColoring') {
buildPremixColoringTable(data);
} else if (page == 'Production') {
buildProductionTable(data);
} else if (page == 'Printing') {
buildPrintingTable(data);
} else if (page == 'Labelling') {
buildLabellingTable(data);
} else if (page == 'Packaging') {
buildPackagingTable(data);
}else if (page == 'Shipping') {
buildShippingTable(data);
}
$("#updating").css("display", "none");
}

function changeSplit(){
pagesSplit=false;
filterResult([selPage,largeData])
//filterpage('xx',true);
}
 var splitPAGES;
    var currPage;
    function splitPages(rett){
  
    var data=rett[0];
    var page=rett[1];
 
    currPage=page;
    
    if(data.length==0){
    $("#updating").css("display", "none");
    console.log('done');
     $('#Pagination').html('');
    $(activetab+' #Pagination2').html('');
    return false;}
    var pages=[]; 
    if(selPage=='QTY'){
    var chunk = 500;
    }else{
    var splitcount=$(activetab+' #splitcountselect').val();
    if(splitcount!='all'){
    var chunk = parseInt(splitcount,10);
     }else{
     var chunk = data.length;
     }
   }
    var i,j,temparray;
 
    for (i=0,j=data.length; i<j; i+=chunk) {
    temparray = data.slice(i,i+chunk);
    // do whatever
    
    pages.push(temparray);
    }
    splitPAGES=pages;
    var toreturn=false;
    if(selPage=='QTY'){
    populateQTYTable(pages[0],page);
    }else{
    toreturn=true;
     // pages[0];filterResult(selPage,pages[0])
    }
    var html2='';
    
    for(var k=0;k<pages.length;k++){
    html2+='<button class="paginationButton" id="getPage'+k+'" onclick="switchPage(this)">'+k+'</button>';
    }
  
   //  $('#Paginationtop').html(html2);
    $('#Pagination').html(html2);
    $(activetab+' #Pagination2').html(html2);
    if(toreturn){
     
    return pages[0];
    }

    }



function switchPage(e){
$(".paginationButton").css("background-color", "#f4f7f8");
$(".paginationButton").css("color", "black");


$(e).css("background-color", "#195685");
$(e).css("color", "#FFF");
 
var id=e.getAttribute('id');
var index=id.substr(7,id.length);
console.log(index);
 pagesSplit=true;
  if(selPage=='QTY'){
   populateQTYTable(splitPAGES[index],currPage);
    }else{
  
    filterResult([selPage ,splitPAGES[index]]);
  
    } 
}

$('#searchQTY').on('click', function(e) {
var page=qtySheet.substr(1,qtySheet.length);
var word=$('#searchword').val();

 google.script.run.withSuccessHandler(splitPages).searchforWord(page,word);


});
  
$('#searchMixingTabs').on('click', function(e) {
var page=MixSheet.substr(1,MixSheet.length);
var word=$('#searchwordMixing').val();

 google.script.run.withSuccessHandler(populateMixingTabs).searchforWordMixing(page,word);


});

function populateMixingTabs(data){
var page=MixSheet.substr(1,MixSheet.length);
if(page=='Mixing'){
buildMixingTable(data);

}else if (page=='MixingTeam'){
buildMixingTeamTable(data);

}else if (page=='FlavourMixMixingTeam'){
buildFlavourMixMixingTeamTable(data);


}else if(page=='PremixColoring'){
buildPremixColoringTable(data);
}
}

function changeProdMachine(event){
var batch=$(event).attr('batch');
//$(event).attr('batch');
var val=$('#machinesProduction').val();

        var factory = event.options[event.selectedIndex].getAttribute('factory')

//var factory = $('option:selected', event).attr('factory');
console.log(batch,val,factory);
google.script.run.withSuccessHandler(updateMachine).updateMachineProduction(batch,val,factory);
}

function changeLabelMachine(event){
var batch=$(event).attr('batch');
//$(event).attr('batch');
var val=$('#machinesLabelling').val();
        var factory = event.options[event.selectedIndex].getAttribute('factory')
//var factory = $('option:selected', event).attr('factory');
console.log(batch,val,factory);
google.script.run.withSuccessHandler(updateMachine).updateMachineLabelling(batch,val,factory);
}
function updateMachine(msg){
alert(msg)

}

//NEW PCD

function newPDC(){
$("#updating").css("display", "block");
console.log('form data for building new pcd');
 google.script.run.withSuccessHandler(buildnewPCD).getFormData();
}
function buildnewPCD(data){
console.log('building new pcd');
var html='';
var recipeSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.recipes.length; i++) {
recipeSelect += '<option id="' + data.recipes[i][1]+ '" value="' + data.recipes[i][0] + '" key="' + data.recipes[i][1] + '" >' + data.recipes[i][0] + '<option>';
}
$("#newPCDrecipe").html(recipeSelect);


var flavourSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.flavours.length; i++) {
flavourSelect += '<option value"' + data.flavours[i].sku + '">' + data.flavours[i].name + '<option>';
}
$("#newPCDflavour").html(flavourSelect);   


var brandSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.brands.length; i++) {
brandSelect += '<option value="' + data.brands[i].sku + '">' + data.brands[i].name + '<option>';
}
$("#newPCDbrand").html(brandSelect); 


var bottleSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.bottletypes.length; i++) {
bottleSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
}
$("#newPCDbottle").html(bottleSelect);


var LidSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.lids.length; i++) {
LidSelect += '<option value="' + data.lids[i].sku + '">' + data.lids[i].name + '<option>';
}
$("#newPCDcap").html(LidSelect);


var packagingSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.packagings.length; i++) {
packagingSelect += '<option id="' + data.packagings[i].sku + '"  value="' + data.packagings[i].sku + '"  >' + data.packagings[i].name + '<option>';
}
$("#newPCDpackaging").html(packagingSelect);  

var boxSelect = '<option id="blank" value=""><option>';
for (var i = 0; i < data.boxes.length; i++) {
boxSelect += '<option id="' + data.boxes[i].sku + '"  value="' + data.boxes[i].sku + '"  >' + data.boxes[i].name + '<option>';
}
$("#newboxname").html(boxSelect);  


var labelsSelect= '<option id="blank" value=""><option>';
for (var i = 0; i < data.labels.length; i++) {
labelsSelect += '<option id="' + data.labels[i].sku + '" value="'+data.labels[i].sku+'">' + data.labels[i].name + '<option>';
}


$("#newbotlabel").html(labelsSelect);  
$("#newppbotlabel").html(labelsSelect);  
$("#newpacklabel").html(labelsSelect);  
$("#newpppacklabel").html(labelsSelect);  



$("#updating").css("display", "none");

}
$('#save_new_PCD').on('click',function(){
var productcode=$('#NPC').val();
var productdescription=$('#NPD').val();
var linkedBB=$('#NlinkedBB').val();
var brandSKU = $('#newPCDbrand').val();
var brandSelect= $('#newPCDbrand option:selected').text();

var recipeID = $('option:selected', '#newPCDrecipe').attr('key');

var recipeName = $('#newPCDrecipe').val();
var flavourSelect = $('#newPCDflavour').val();
var flavourName= $('#newPCDflavour option:selected').text();

var botSKU = $('#newPCDbottle').val();
var bottleType= $('#newPCDbottle option:selected').text();

var lidSKU = $('#newPCDcap').val();
var lidType= $('#newPCDcap option:selected').text();

var packagingTypesku = $('#newPCDpackaging').val();
var packagingTypename= $('#newPCDpackaging option:selected').text();


if(productcode.length>20){
var t=productcode;
productcode=productdescription;
productdescription=t;
}

var object = {
botlabel:$('#newbotlabel option:selected').text(),
botlabelsku:$('#newbotlabel').val(),
ppbotlabel:$('#newppbotlabel option:selected').text(),
ppbotlabelsku:$('#editppbotlabel').val(),

packlabel:$('#newpacklabel option:selected').text(),
packlabelsku:$('#newpacklabel').val(),
pppacklabel:$('#newpppacklabel option:selected').text(),
pppacklabelsku:$('#newpppacklabel').val(),

fill:parseInt($('#newPCDfill').val(),10),
boxname:{
sku:$('#newboxname').val(),
name:$('#newboxname option:selected').text(),
},
premixSKU:$('#newpremixSKU').val(),
premixdescr:$('#newpremixdescr').val(),
premixSKUColored:$('#newpremixSKUColored').val(),
premixdescrColored:$('#newpremixdescrColored').val(),
unbrandSKU:$('#newunbrandSKU').val(),
unbranddescr:$('#newunbranddescr').val(),
productcode:productcode,
productdescription:productdescription,
recipe: {

  name: '',
  id:''
},
brand: brandSelect,
brandSKU: brandSKU,

flavour: {
sku:'',
name:'',
},
btype: bottleType,
botSKU: botSKU,
lidSKU: lidSKU,
lid: lidType,

packagingType:{
sku:'',
name:'',
},
linkedBB:linkedBB,
};
object.recipe.id = recipeID;
object.recipe.name = recipeName;

object.packagingType.sku = packagingTypesku;
object.packagingType.name = packagingTypename;

object.flavour.sku = flavourSelect;
object.flavour.name = flavourName;

google.script.run.withSuccessHandler(updateMachine).save_PCD(object,'',false);
});



//EDIT PCD
var oldPCD;
var input1 = document.getElementById('EPC');
var optionsVal1 = document.getElementById('list1');

input1.addEventListener('keyup', show);
optionsVal1.onclick = function () {
    setVal(this);
};
RegExp.escape = function (s) {
    return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
};
function show() {
  if (this.keyCode == 13) {return false;}
//document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById('dropdown');
    dropdown.style.display = 'none';

    optionsVal1.options.length = 0;

    if (input1.value) {
        dropdown.style.display = 'block';
        optionsVal1.size = 3;
        var textCountry = input1.value;

        for (var i = 0; i < PCArr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (PCArr[i].prod.match(testableRegExp)) {
                addValue(PCArr[i].prod, PCArr[i].prod);

            }
        }
        
        var size = dropdown.children[0].children;
        if (size.length > 0)
        {
           var defaultSize = 16;
           if (size.length < 10)
           {
              defaultSize *= size.length;
           }
           else
           {
              defaultSize *= 10;
           }
           dropdown.children[0].style.height = defaultSize + "px";
        }
        
    }
}

function addValue(text, val) {
    var createOptions = document.createElement('option');
    optionsVal1.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
}

//Settin the value in the box by firing the click event
function setVal(selectedVal) {
    input1.value = selectedVal.value;
    document.getElementById('dropdown').style.display = 'none';
}

var input2 = document.getElementById('EPD');
var optionsVal2 = document.getElementById('list2');

input2.addEventListener('keyup', show2);
optionsVal2.onclick = function () {
    setVal2(this);
};

function show2() {
  if (this.keyCode == 13) {return false;}
//document.getElementById('list2').style.display = 'block';
    var dropdown = document.getElementById('dropdown2');
    dropdown.style.display = 'none';

    optionsVal2.options.length = 0;

    if (input2.value) {
        dropdown.style.display = 'block';
        optionsVal2.size = 3;
        var textCountry = input2.value;

        for (var i = 0; i < PDArr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (PDArr[i].descr.match(testableRegExp)) {
                addValue2(PDArr[i].descr, PCArr[i].descr);

            }
        }
        
        var size = dropdown.children[0].children;
        if (size.length > 0)
        {
           var defaultSize = 16;
           if (size.length < 10)
           {
              defaultSize *= size.length;
           }
           else
           {
              defaultSize *= 10;
           }
           dropdown.children[0].style.height = defaultSize + "px";
        }
        
    }
}

function addValue2(text, val) {
    var createOptions = document.createElement('option');
    optionsVal2.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
}

//Settin the value in the box by firing the click event
function setVal2(selectedVal) {
    input2.value = selectedVal.value;
    document.getElementById('dropdown2').style.display = 'none';
}
function editPCD(){
 google.script.run.withSuccessHandler(buildeditPCD).getPCDDropdown();
}
$('#EPC').on('keypress',function(event){

   if (event.keyCode == 13) {
var PC=$('#EPC').val();
console.log('PC',PC);
$("#updating").css("display", "block");
console.log('form data for building edit pcd prcode');
try{
 google.script.run.withSuccessHandler(buildeditPCD).getEPCandFormdata(PC);
 }catch(e){
 $("#updating").css("display", "none");
 }
 
 }
});

$('#EPD').on('keypress',function(event){
console.log('in');
  if (event.keyCode == 13) {

var PD=$('#EPD').val();
console.log('form data for building edit pcd descr');
$("#updating").css("display", "block");
try{
 google.script.run.withSuccessHandler(buildeditPCD).getEPDandFormdata(PD);
  }catch(e){
 $("#updating").css("display", "none");
 }
 }
});


function getdatalists(){
google.script.run.withSuccessHandler(buildPCPD).createDatalistPCPD();
}
var PCArr=[];
var PDArr=[];
function buildPCPD(data){
PCArr=data[0];
PDArr=data[1];

}
function buildeditPCD(arr){


console.log('building edit pcd',arr);
var data=arr[0];
var EPC=arr[1];
var EPD=arr[2];
var which=arr[3];

if(which=='EPC'){
  if(EPD){
  oldPCD=EPC;
  $("#EPD").val(EPD);
  
  }else{alert("Product Match not found!");
  $("#updating").css("display", "none");

  }
}else{
  if(EPC){
  oldPCD=EPD;

  $("#EPC").val(EPC);
  
  }else{alert("Product Match not found!");
  $("#updating").css("display", "none");
  return;
  }
}


var recipeSelect = '<option selected id="1" value="' + oldPCD.recipe.id + '" key="' + oldPCD.recipe.id + '">' + oldPCD.recipe.name + '<option>';
var flavourSelect = '<option selected value="' + oldPCD.flavour.sku + '">' + oldPCD.flavour.name + '<option>';
var brandSelect = '<option selected value="' + oldPCD.brandSKU + '">' + oldPCD.brand + '<option>';
var bottleSelect = '<option selected value="' + oldPCD.botSKU + '">' + oldPCD.btype + '<option>';
var LidSelect = '<option selected value="' + oldPCD.lidSKU+ '">' + oldPCD.lid + '<option>';
var packagingSelect = '<option selected id="' + oldPCD.packagingType.sku + '" value="'+oldPCD.packagingType.sku+'">' + oldPCD.packagingType.name+ '<option>';
var boxSelect = '<option selected id="' + oldPCD.boxname.sku + '" value="'+oldPCD.boxname.sku+'">' + oldPCD.boxname.name+ '<option>';

var botlabelSelect = '<option selected  value="'+oldPCD.botlabelsku +'">' + oldPCD.botlabel + '<option>';
var ppbotlabelSelect = '<option selected value="' + oldPCD.ppbotlabelsku + '">' + oldPCD.ppbotlabel + '<option>';

var packlabelSelect = '<option selected value="' + oldPCD.packlabelsku + '">' + oldPCD.packlabel + '<option>';
var pppacklabelSelect = '<option selected value="' + oldPCD.pppacklabelsku + '">' + oldPCD.pppacklabel + '<option>';


for (var i = 0; i < data.recipes.length; i++) {
recipeSelect += '<option id="' + data.recipes[i][1] + '" value="' + data.recipes[i][0] + '" key="' + data.recipes[i][1] + '">' + data.recipes[i][0] + '<option>';
}
$("#editPCDrecipe").html(recipeSelect);

for (var i = 0; i < data.flavours.length; i++) {
flavourSelect += '<option value="' + data.flavours[i].sku + '">' + data.flavours[i].name + '<option>';
}
$("#editPCDflavour").html(flavourSelect);   

for (var i = 0; i < data.brands.length; i++) {
brandSelect += '<option value="' + data.brands[i].sku + '">' + data.brands[i].name + '<option>';
}
$("#editPCDbrand").html(brandSelect); 

for (var i = 0; i < data.bottletypes.length; i++) {
bottleSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
}
$("#editPCDbottle").html(bottleSelect);

for (var i = 0; i < data.lids.length; i++) {
LidSelect += '<option value="' + data.lids[i].sku + '">' + data.lids[i].name + '<option>';
}
$("#editPCDcap").html(LidSelect);

for (var i = 0; i < data.packagings.length; i++) {
packagingSelect += '<option id="' + data.packagings[i].sku + '" value="'+data.packagings[i].sku+'">' + data.packagings[i].name + '<option>';
}
$("#editPCDpackaging").html(packagingSelect);  

for (var i = 0; i < data.boxes.length; i++) {
boxSelect += '<option id="' + data.boxes[i].sku + '" value="'+data.boxes[i].sku+'">' + data.boxes[i].name + '<option>';
}
$("#editboxname").html(boxSelect);  

var labelsSelect='';
for (var i = 0; i < data.labels.length; i++) {
labelsSelect += '<option id="' + data.labels[i].sku + '" value="'+data.labels[i].sku+'">' + data.labels[i].name + '<option>';
}


$("#editbotlabel").html(botlabelSelect+labelsSelect);  
$("#editppbotlabel").html(ppbotlabelSelect+labelsSelect);  
$("#editpacklabel").html(packlabelSelect+labelsSelect);  
$("#editpppacklabel").html(pppacklabelSelect+labelsSelect);  


$("#editfill").val(oldPCD.fill);  

$("#editpremixSKU").val(oldPCD.premixSKU);  
$("#editpremixdescr").val(oldPCD.premixdescr); 
$("#editpremixSKUColored").val(oldPCD.premixSKUColored);  
$("#editpremixdescrColored").val(oldPCD.premixdescrColored); 
$("#editunbrandSKU").val(oldPCD.unbrandSKU);  
 $("#editunbranddescr").val(oldPCD.unbranddescr);  
 
$("#ElinkedBB").val(oldPCD.linkedBB);
$("#updating").css("display", "none");



}
$('#delete_edit_PCD').on('click',function(){
if(confirm('Are you sure you want to delete this product code from the database?')){
var productcode=$('#EPC').val();
var productdescription=$('#EPD').val();

google.script.run.withSuccessHandler(updateMachine).delete_PCD(productcode,productdescription);
$('#editPCDmodal').hide();
}
});
$('#save_edit_PCD').on('click',function(){
var productcode=$('#EPC').val();
var productdescription=$('#EPD').val();
var linkedBB=$("#ElinkedBB").val();
var brandSKU = $('#editPCDbrand').val();
var brandSelect= $('#editPCDbrand option:selected').text();

var recipeKey = $('option:selected', '#editPCDrecipe').attr('key');
var recipeName = $('#editPCDrecipe').val();

var flavourSelect = $('#editPCDflavour').val();
var flavourName= $('#editPCDflavour option:selected').text();

var botSKU = $('#editPCDbottle').val();
var bottleType= $('#editPCDbottle option:selected').text();

var lidSKU = $('#editPCDcap').val();
var lidType= $('#editPCDcap option:selected').text();

var packagingTypesku = $('#editPCDpackaging').val();
var packagingTypename= $('#editPCDpackaging option:selected').text();


var object = {
botlabel:$('#editbotlabel option:selected').text(),
botlabelsku:$('#editbotlabel').val(),
ppbotlabel:$('#editppbotlabel option:selected').text(),
ppbotlabelsku:$('#editppbotlabel').val(),

packlabel:$('#editpacklabel option:selected').text(),
packlabelsku:$('#editpacklabel').val(),
pppacklabel:$('#editpppacklabel option:selected').text(),
pppacklabelsku:$('#editpppacklabel').val(),

fill:parseInt($('#editfill').val(),10),
boxname:{
sku:$('#editboxname').val(),
name:$('#editboxname option:selected').text(),
},
premixSKU:$('#editpremixSKU').val(),
premixdescr:$('#editpremixdescr').val(),
premixSKUColored:$('#editpremixSKUColored').val(),
premixdescrColored:$('#editpremixdescrColored').val(),
unbrandSKU:$('#editunbrandSKU').val(),
unbranddescr:$('#editunbranddescr').val(),
productcode:productcode,
productdescription:productdescription,
recipe: {
  id: '',
  
  name: '',
 
},
brand: brandSelect,
brandSKU: brandSKU,
flavour: {
sku:'',
name:'',
},
btype: bottleType,
botSKU: botSKU,
lidSKU: lidSKU,
lid: lidType,

packagingType:{
sku:'',
name:'',
}, 
linkedBB:linkedBB,
};
object.recipe.id = recipeKey;

object.recipe.name = recipeName;

object.packagingType.sku = packagingTypesku;

object.packagingType.name = packagingTypename;

object.flavour.sku = flavourSelect;

object.flavour.name = flavourName;
console.log('EPC',object);
google.script.run.withSuccessHandler(updateMachine).save_PCD(object,oldPCD,true);
});


//INVENTORY


    $('#newitem').on('click', function(e) {

        google.script.run.withSuccessHandler(buildItemForm).getInventoryDescription();
    });
    
var INPDATA;
  function buildItemForm(data) {
  INPDATA=data;

    }
    
        
    function removeFromInventory(item, page) {
        console.log(item);
        google.script.run.withSuccessHandler(InventoryItemSuccess).removefromInventory(item, page);

    }


    function insertToQTY(item, page) {

        google.script.run.withSuccessHandler(InventoryItemSuccess).addtoQTY(item, page);


    }

    function InventoryItemSuccess(msg) {
        alert(msg);
        google.script.run.withSuccessHandler(buildInventory).getInventoryData();

    }
    function editItem(item, page) {
        google.script.run.withSuccessHandler(buildItemFormFromExisting).getItemData(item, page);
    }

   function buildItemFormFromExisting(retval) {
        console.log(retval);
       INPDATA = retval[0];
        var dataold = retval[1];
    
       $('#description').val(dataold.desc);
       $('#description2').val(dataold.key);
        $('#orderDate1').val(formatDateInput(dataold.orderdate));
        $('#paiddate').val(formatDateInput(dataold.paiddate));
        $('#deliveryDate').val(formatDateInput(dataold.delivdate));
        $('#eta').val(dataold.eta);
        $('#quantity').val(dataold.quantity);
        $('#note').val(dataold.note);
       $("#descriptionsku").val(dataold.sku);
       $("#descriptionpage").val(dataold.page);

    }

//EDIT PCD

var input3 = document.getElementById('description');

var optionsVal3 = document.getElementById('list4');

input3.addEventListener('keyup', show4);

RegExp.escape = function (s) {
    return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
};
function show4() {
  if (this.keyCode == 13) {return false;}
//document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById('dropdown4');
    dropdown.style.display = 'none';

    optionsVal3.options.length = 0;

    if (input3.value) {
        dropdown.style.display = 'block';
        optionsVal3.size = 3;
        var textCountry = input3.value;

        for (var i = 0; i < INPDATA.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
             if(INPDATA[i].name){
            if (INPDATA[i].name.match(testableRegExp)) {
           
                addValue4(INPDATA[i].name, INPDATA[i].name, INPDATA[i].sku, INPDATA[i].page, INPDATA[i].key);

            }
            }
        }
        
        var size = dropdown.children[0].children;
        if (size.length > 0)
        {
           var defaultSize = 16;
           if (size.length < 10)
           {
              defaultSize *= size.length;
           }
           else
           {
              defaultSize *= 10;
           }
           dropdown.children[0].style.height = defaultSize + "px";
        }
        
    }
}

function addValue4(text, val,sku,page,key) {
//console.log('here');
    var createOptions = document.createElement('option');
    optionsVal3.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
    createOptions.setAttribute('sku',sku);
    createOptions.setAttribute('key',key);
     createOptions.setAttribute('page',page);
}

//Settin the value in the box by firing the click event
function setVal4(selectedVal) {
$('#description').val($(selectedVal).val());

console.log(selectedVal.options[selectedVal.selectedIndex].getAttribute('page'),selectedVal.options[selectedVal.selectedIndex].getAttribute('sku'))
$('#descriptionsku').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('sku'));
$('#descriptionpage').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('page'));
$('#description2').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('key'));

    document.getElementById('dropdown4').style.display = 'none';
}


$("#custManage").on('click',function(){

$("#managePage").html("");
google.script.run.withSuccessHandler(populateCustomers).getCustomerList();



});


function populateCustomers(list){
var html='';
html='<table class="table"><thead>';
html+='<tr><th>SKU</th><th>Name</th><th>Address</th><th>Action</th></tr></thead><tbody>';
for(var i=0;i<list.length;i++){

html+="<tr><td>"+list[i].sku+"</td><td>"+list[i].name+"</td><td>"+list[i].address+"</td><td><button  class='btn btn-primary'  id='"+list[i].sku+"' onclick='editCustomer(this)' >Edit</button></td></tr>"
}
html+='</tbody></table>'

$("#managePage").html(html);
}

function editCustomer(event){
var name=$(event).attr('id');
google.script.run.withSuccessHandler(getSingleCustomer).getCust(name);

}
var oldCUST={};
function getSingleCustomer(data){
oldCUST=data;
$("#editCustomerDiv").show();
$("#editSKU").val(data.sku);
$("#editName").val(data.name);
$("#addressEdit").val(data.address);
$("#addressEdit").focus();

}

$("#saveCustEdit").on('click',function(){
var obj={
name:$("#editName").val(),
address:$("#addressEdit").val(),
sku:oldCUST.sku,
}
console.log(obj);
 google.script.run.withSuccessHandler(editCustSuccess).newBasicItem(obj, 'Customers');
 oldCUST={};
});

function editCustSuccess(msg){
$("#editCustomerDiv").hide();
alert(msg);
google.script.run.withSuccessHandler(populateCustomers).getCustomerList();

}


 function moveItems(origin, dest) {
var child=$(origin).find(':selected');
    $(origin).find(':selected').appendTo(dest);
//    if(xero_NOTE){
//    if(child.length){
//   var  childs=child;
//   for(var i=0;i<childs.length;i++){
//   if(origin=='#xrOne'){
//   orderIDsDATABottom.push([$(childs[i]).attr('date'),$(childs[i]).val()]);
//   orderIDsDATATop.splice(getIndex2($(childs[i]).val(),orderIDsDATATop), 1)
//   
//   }else{
//   orderIDsDATATop.push([$(childs[i]).attr('date'),$(childs[i]).val()]);
//   orderIDsDATABottom.splice(getIndex2($(childs[i]).val(),orderIDsDATABottom), 1)
//   
//   }
//   }
//    }else{
//    if(origin=='#xrOne'){
//    orderIDsDATABottom.push([$(child).attr('date'),$(child).val()]);
//    orderIDsDATATop.splice(getIndex2($(child).val(),orderIDsDATATop), 1)
//    
//    }else{
//    orderIDsDATATop.push([$(child).attr('date'),$(child).val()]);
//    orderIDsDATABottom.splice(getIndex2($(child).val(),orderIDsDATABottom), 1)
//    
//    }
//    }
//        console.log('top',orderIDsDATATop)
//     console.log('bottom',orderIDsDATABottom)
//    }

}
 
function moveAllItems(origin, dest) {
   var childs=$(origin).children();
    $(origin).children().appendTo(dest);
    console.log(childs);
//    if(xero_NOTE){
//    
//     for(var i=0;i<childs.length;i++){
//     if(origin=='#xrOne'){
//     orderIDsDATABottom.push([$(childs[i]).attr('date'),$(childs[i]).val()]);
//     orderIDsDATATop.splice(getIndex2($(childs[i]).val(),orderIDsDATATop), 1)
//     
//     }else{
//     orderIDsDATATop.push([$(childs[i]).attr('date'),$(childs[i]).val()]);
//     orderIDsDATABottom.splice(getIndex2($(childs[i]).val(),orderIDsDATABottom), 1)
//     
//     }
//     }
//         console.log('top',orderIDsDATATop)
//     console.log('bottom',orderIDsDATABottom)
//    }
}

var SHIPPING_NOTE=false;
var xero_NOTE=false;
var statusCheck=false;
$('#getShippingCodes').click(function () {
SHIPPING_NOTE=true;
xero_NOTE=false;
statusCheck=false;
    google.script.run.withSuccessHandler(populatePackCodes).getPackCodes();

});

$('#getOrderIDs').click(function () {
SHIPPING_NOTE=false;
statusCheck=false;
xero_NOTE=true;
    google.script.run.withSuccessHandler(populateOrderIDs).getOrderIDs('xero');

});
$('#getOrderIDs2').click(function () {
statusCheck=true;
SHIPPING_NOTE=false;
xero_NOTE=false;
    google.script.run.withSuccessHandler(populateOrderIDs).getOrderIDs('xero');

});
function populatePackCodes(list){
//console.log(list);
var html='';
for(var i=0;i<list.length;i++){
html+='<option value="'+list[i]+'">'+list[i]+'</option>';
}
//console.log(html);
$('#sbOne').html(html);
}


function populateOrderIDs(list){

//console.log(list);
var html='';
for(var i=0;i<list.length;i++){
html+='<option  date="'+list[i][0]+'" value="'+list[i][1]+'">'+formatDateDisplay(list[i][0])+' '+list[i][1]+' '+list[i][3]+'</option>';
}
//console.log(html);
if(statusCheck){

$('#statusOne').html(html);
}else{
$('#xrOne').html(html);
}
//console.log('orderIDsDATATop',orderIDsDATATop)
}

$('#printShipping').click(function () {
var arr=[];
var myOpts = document.getElementById('sbTwo').options;
for(var i=0;i<myOpts.length;i++){
arr.push(myOpts[i].value);
}
if(arr.length>0){
google.script.run.withSuccessHandler(stockCheck).printShippingNote(arr, 1);
}else{
alert('No codes selected.');
}
$('#sbTwo').html('');
});
$('#printShipping2').click(function () {
var arr=[];
var myOpts = document.getElementById('sbTwo').options;
for(var i=0;i<myOpts.length;i++){
arr.push(myOpts[i].value);
}
if(arr.length>0){
google.script.run.withSuccessHandler(stockCheck).printShippingNote(arr, 2);
}else{
alert('No codes selected.');
}
$('#sbTwo').html('');
});

$('#printxero').click(function () {
var arr=[];
var myOpts = document.getElementById('xrTwo').options;
for(var i=0;i<myOpts.length;i++){
arr.push(myOpts[i].value);
}
if(arr.length>0){
google.script.run.withSuccessHandler(stockCheck).printxero(arr);
}else{
alert('No codes selected.');
}
$('#xrTwo').html('');
});
$('#statuscheck').click(function () {
var arr=[];
var myOpts = document.getElementById('statusTwo').options;
for(var i=0;i<myOpts.length;i++){
arr.push(myOpts[i].value);
}
if(arr.length>0){
$("#updating").css("display", "block");
console.log(arr);
google.script.run.withSuccessHandler(buildhtmlmodal).checkStatus(arr);

}else{
alert('No codes selected.');
}
$("statusTwo").html('');
});
$('.left').click(function () {
if(SHIPPING_NOTE){
moveItems('#sbTwo', '#sbOne');
}else if(xero_NOTE){
moveItems('#xrTwo', '#xrOne');
}else{
moveItems('#statusTwo', '#statusOne');
}
});
 
$('.right').on('click', function () {
 
    if(SHIPPING_NOTE){
moveItems('#sbOne', '#sbTwo');
}else if(xero_NOTE){
moveItems('#xrOne', '#xrTwo');
}else{
moveItems('#statusOne', '#statusTwo');
}
});
 
$('.leftall').on('click', function () {
  
    if(SHIPPING_NOTE){
moveAllItems('#sbTwo', '#sbOne');
}else if(xero_NOTE){
moveAllItems('#xrTwo', '#xrOne');
}else{
moveAllItems('#statusTwo', '#statusOne');
}
});
 
$('.rightall').on('click', function () {

    if(SHIPPING_NOTE){
moveAllItems('#sbOne', '#sbTwo');
}else if(xero_NOTE){

moveAllItems('#xrOne', '#xrTwo');
}else{
moveAllItems('#statusOne', '#statusTwo');
}   
});


function getIndex2 (searchValue, array) {
    for (var i = 0; i < array.length; i++) {
        if (array[i][1] == searchValue) {
            return i
            break;
        }

    }
    return -1;

}

function getOrderIDsTop(){
var childs=$('#xrOne').children();
var ret=[];
for(var i=0;i<childs.length;i++){
 ret.push([$(childs[i]).attr('date'),$(childs[i]).val()])
}
console.log('ret',ret);
return ret;
}
function getOrderIDsPrioriies(){
var childs=$('.priorityBody').children();
var ret=[];
for(var i=0;i<childs.length;i++){
console.log(childs[i]);
 ret.push([$(childs[i]).attr('date'),$(childs[i]).attr('orderID'),$(childs[i]).attr('priority')])
}
console.log('ret',ret);
return ret;
}
function filterxero(event){
var modal=$(event).attr('page');

var dates={

'startDate':$('#'+modal+' #startSearchOrderIDs').val(),
'endDate':$('#'+modal+' #endSearchOrderIDs').val(),
'keyword':$('#'+modal+' #keyword').val(),
};
if(modal=='xeroModal'){
var data=getOrderIDsTop();
}else if(modal=='statusModal'){
var data=getOrderIDsTop();
}else{
var data=getOrderIDsPrioriies();
}
  if(dates.startDate){
    var start=new Date(dates.startDate);
  }else{
    
      var start=new Date('01-01-1970');
  }
  if(dates.endDate){
    var end=new Date(dates.endDate);
  }else{
    
    var end=new Date('01-01-2040');
  }
  var ret=[];
  console.log('start',start);
 for(var i=0;i<data.length;i++){

 var arrtime=parseInt(data[i][0],10);


    if(start.getTime()<=arrtime && end.getTime()>=arrtime){
      if(dates.keyword==''){
          ret.push(data[i]);
      }else{
       if(JSON.stringify(data[i]).toLowerCase().match(dates.keyword.toLowerCase())){
       ret.push(data[i]);
       }
      }
      
    }else{
  //  console.log('logitem',arrtime);
  //   console.log('start',start);
    }
    
 }
 if(modal=='xeroModal'){
   var childs=$('#xrOne').children();
     for(var i=0;i<childs.length;i++){
       $(childs[i]).hide();
     }
     for(var i=0;i<childs.length;i++){
       for(var j=0;j<ret.length;j++){
         if($(childs[i]).val()==ret[j][1]){
           $(childs[i]).show();
         break;
       }
     }
   }
 }else if(modal=='statusModal'){
   var childs=$('#statusOne').children();
     for(var i=0;i<childs.length;i++){
       $(childs[i]).hide();
     }
     for(var i=0;i<childs.length;i++){
       for(var j=0;j<ret.length;j++){
         if($(childs[i]).val()==ret[j][1]){
           $(childs[i]).show();
         break;
       }
     }
   }
 }else{
 
  var childs=$('.priorityBody').children();
     for(var i=0;i<childs.length;i++){
       $(childs[i]).hide();
     }
     for(var i=0;i<childs.length;i++){
       for(var j=0;j<ret.length;j++){
         if($(childs[i]).attr('id')==ret[j][1]){
           $(childs[i]).show();
         break;
       }
     }
   }
 
 
 }
//return ret;
}







var MAXSEARCHNUM=5;

function getSearchBoxData(page){
SEARCHNUM=0;
   $('.searchBox'+page).html('');
      google.script.run.withSuccessHandler(populateSearchBox).getSearchBoxKeys(page);

}
function addSearchOption(event){
var page=$(event).attr('page');
	
$(event).remove();

console.log('here');
console.log(page);
if(SEARCHNUM<MAXSEARCHNUM){
$('#pageSearch'+page).remove();
SEARCHNUM++;
 google.script.run.withSuccessHandler(populateSearchBox).getSearchBoxKeys(page);

 }else{
 
 }
}

function populateSearchBox(rett){
//console.log(rett);
var data=rett[0];
var page=rett[1];
var html = '<div class="searchItem" id="searchItem'+SEARCHNUM+page+'"';

    
    html += '<table class="form_table">';
    html+='<thead><tr><th>Search By:</th><tr></thead><tbody>';
    html += '<tr><td><select class="form-control"  page="'+page+'" id="sarchKey'+page+SEARCHNUM+'" num="'+SEARCHNUM+'" onchange="getSearchValues(this);">';
    
    var keySELECT = '<option value=""><option>';
    for (var i = 0; i < data.length; i++) {
    keySELECT += '<option key="'+data[i][2]+'" value="' + data[i][0] + '">' + data[i][1] + '<option>';
    }
    html+=keySELECT;
    html += ' </select></td></tr></tbody></table>';
      html +='</div>';
    
    $('.searchBox'+page).append(html);
}


function getSearchValues(event){
console.log('here');
var page=$(event).attr('page');
var num=$(event).attr('num');
var DBpage= $('#sarchKey'+page+num).val();
var key = $('option:selected', event).attr('key');
  console.log(page,DBpage,key);
if(DBpage){

  google.script.run.withSuccessHandler(populateSearchValues).getSearchValues(page,DBpage,key,num);
}
}

function populateSearchValues(data){
console.log(data);
var page=data[0];
var list=data[1];
var key=data[2];
var num=data[3];
$('#searchVALDIV'+page+num).remove();

if(key=='word'||key=='priority'){
var html='<input class="form-control" id="searchVAL'+page+num+'" num="'+num+'" type="text"/>';


}else{
var html='<select  class="form-control" id="searchVAL'+page+num+'" num="'+num+'">';
for(var i=0;i<list.length;i++){
if(list[i].name){
html+='<option value="'+list[i].name+'">'+list[i].name+'</option>';
}
}
html+='</select>';


}
if(num==SEARCHNUM){
    var button = '<button class="btn btn-primary" id="pageSearch'+page+'" page="'+page+'" onclick="filterpage(this);">Search</button>';
    var button2 = '<button class="btn btn-default" id="addSearchOption" page="'+page+'" onclick="addSearchOption(this);">+</button>';
    }else{
    var button='';
    var button2='';
    }


var table='<table><thead><tr><th>Value</th><th></th><th></th></tr></thead>';
table+='<tbody><tr><td>'+html+'</td><td>'+button2+'</td><td>'+button+'</td></tr></tbody>';
var div="<div id='searchVALDIV"+page+num+"'>"+table+"</div>";
  $('#searchItem'+num+page).append(div);
}



var LASTSEARCH;
function filterpage(event,skip){
var searchItems=[];
if(!skip){
for(var i=0;i<=SEARCHNUM;i++){
var page=event.getAttribute('page');
var val=$('#searchVAL'+page+i).val();
var key=$('option:selected', '#sarchKey'+page+i).attr('key');
var params={
orderBy : key,
equalTo: val

};

searchItems.push([page,params]);

}
}

searchItems.push([selPage,BASEPARAM]);
LASTSEARCH=searchItems;
console.log('searching for',searchItems);

 google.script.run.withSuccessHandler(filterResult).searchFor(searchItems);



}

function moveUp(e){

   var currentBatch = $(e).attr('batch');
   var currentPage = $(e).attr('page');

   google.script.run.withSuccessHandler(movefunc).moveUp(currentPage,currentBatch);
}
function movefunc(data){

filterpage('xx',true);
}
function moveDown(e){
   var currentBatch = $(e).attr('batch');
   var currentPage = $(e).attr('page');

   google.script.run.withSuccessHandler(movefunc).moveDown(currentPage,currentBatch);
} 

//LOGSTATUS


google.script.run.withSuccessHandler(setStatus).getStatus();


$('#LOGstatus').on('click',function(){
var attr=$('#LOGstatusID').val();
google.script.run.withSuccessHandler(setStatus).setStatusinDB(attr);
});

function setStatus(resp){
if(resp){
$('#LOGstatus').html('Log On');
$('#LOGstatusID').val('On');
}else{
console.log('here');
$('#LOGstatus').html('Log Off');
$('#LOGstatusID').val('Off');
}

}

function datesearch(){


   google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);

}

$('#startSearch').change(function(){

   google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);
})
$('#endSearch').change(function(){

   google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);
})

var EDIT_RECIPE_CONST=false;
$('#editRecipeButton').on('click',function(){
   EDIT_RECIPE_CONST=true;
   $('.newRecipeBody').hide();
   $('.editRecipeBody').show();
  $("#delete_edit_recipe").show();
  google.script.run.withSuccessHandler(set_colors_helper_dropdown).get_colors_helper_dropdown();
 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editRecipeButton');
});



$('#newRecipeButton').on('click',function(){
$('.newRecipeBody').show();
$('.editRecipeBody').hide();
  $("#delete_edit_recipe").hide();

   EDIT_RECIPE_CONST=false;
  google.script.run.withSuccessHandler(set_colors_helper_dropdown).get_colors_helper_dropdown(); 
 
})

function set_colors_helper_dropdown(data){
var html="<option value=''></option>";
for(var i=0;i<data.length;i++){
html+='<option value="'+data[i].sku+'">'+data[i].name+'</option>';

}
if(EDIT_RECIPE_CONST){
$('#ecolorSelect').html(html);
}else{

$('#colorSelect').html(html);
}
}

var EDIT_PACKAGING_CONST=false;
$('#editPackageButton').on('click',function(){
   EDIT_PACKAGING_CONST=true;
   $('.newPackagingBody').hide();
   $('.editPackagingBody').show();
  $("#delete_edit_packaging").show();
  //  google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();

 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editPackageButton');

});




var EDIT_BOX_CONST=false;
$('#editBoxButton').on('click',function(){
   EDIT_BOX_CONST=true;
   $('.newBoxBody').hide();
   $('.editBoxBody').show();
  $("#delete_edit_box").show();

 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editBoxButton');

});
$('#newBoxButton').on('click',function(){
$('.newBoxBody').show();
$('.editBoxBody').hide();
  $("#delete_edit_box").hide();

   EDIT_BOX_CONST=false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();
 
 
});



var EDIT_LABEL_CONST=false;
$('#editLabelButton').on('click',function(){
   EDIT_LABEL_CONST=true;
   $('.newLabelBody').hide();
   $('.editLabelBody').show();
  $("#delete_edit_Label").show();

 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editLabelButton');

});
$('#newLabelButton').on('click',function(){
$('.newLabelBody').show();
$('.editLabelBody').hide();
  $("#delete_edit_Label").hide();

   EDIT_LABEL_CONST=false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();
 
 
});


var EDIT_COLOR_CONST=false;
$('#editColorButton').on('click',function(){
   EDIT_COLOR_CONST=true;
   $('.newColorBody').hide();
   $('.editColorBody').show();
  $("#delete_edit_Color").show();

 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editColorButton');

});
$('#newColorButton').on('click',function(){
$('.newColorBody').show();
$('.editColorBody').hide();
  $("#delete_edit_Color").hide();

   EDIT_COLOR_CONST=false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();
 
 
});




    //GLOBAL DROPDOWN SUGGESTER
 var ACTIVEARRAYS=[];
 function set_active_dropdown_arrays(data){
console.log('data',data);
 ACTIVEARRAYS=[];
 data.map(function (item){
 ACTIVEARRAYS.push(item);
 })
 

 createSUGGESTER();
 }
 
 var SUGGESTARR=[];
 var INPUTARR=[];
 var SELECTARR=[];
 function createSUGGESTER(){
 INPUTARR=[];
 SUGGESTARR=[];
 SELECTARR=[];
 for(var i=0;i<ACTIVEARRAYS.length;i++){
 // INPUT , DIV OVER SELECT , SELECT  , ARRAY, PAGE
 SUGGESTARR.push([document.getElementById(ACTIVEARRAYS[i][0]),ACTIVEARRAYS[i][1],document.getElementById(ACTIVEARRAYS[i][2]),ACTIVEARRAYS[i][3] ,ACTIVEARRAYS[i][4]]);
 INPUTARR.push(ACTIVEARRAYS[i][0]);
 SELECTARR.push(ACTIVEARRAYS[i][2]);
 }
 

 }
  
    
//<input type="text" onkeyup="showGLOBAL(this)">  <select onclick='helperSETVAL(this)'
function helperSETVAL(event){
var id=$(event).attr('id');
var index=SELECTARR.indexOf(id);
var drop=SUGGESTARR[index][1];
var inp=SUGGESTARR[index][0];
var page=SUGGESTARR[index][4];
setValGLOBAL(event,drop,inp,page);

}


RegExp.escape = function (s) {

s=s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replace("\\{", "\\$&").replace("\\}", "\\$&");

    return s;
};
function showGLOBAL(event) {


var id=$(event).attr('id');
console.log(id);
var index=INPUTARR.indexOf(id);
console.log(index);
var inp=SUGGESTARR[index][0];
var drop=SUGGESTARR[index][1];
var opt=SUGGESTARR[index][2];
var arr=SUGGESTARR[index][3];
console.log(drop);
//document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById(drop);
    dropdown.style.display = 'none';
    //$("#"+drop).html('');
    opt.options.length = 0;

    if (inp.value) {
        dropdown.style.display = 'block';
        opt.size = 3;
        var textCountry = inp.value;

        for (var i = 0; i < arr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            
            if(typeof arr[i] ==='array'){
            var searchin= RegExp.escape(arr[i].toString());
            }else if(typeof arr[i] ==='object'){
            var searchin= RegExp.escape(JSON.stringify(arr[i]));
            }else{
            var searchin= RegExp.escape(arr[i].toString());
            }
            console.log('arr[i]',searchin,'text',testableRegExp);
            
            if (searchin.match(testableRegExp)) {
                addValueGLOBAL(arr[i],opt,id);

            }
        }
        
        var size = dropdown.children[0].children;
        if (size.length > 0)
        {
           var defaultSize = 16;
           if (size.length < 10)
           {
              defaultSize *= size.length;
           }
           else
           {
              defaultSize *= 10;
           }
           dropdown.children[0].style.height = defaultSize + "px";
        }
        
    }
}

function addValueGLOBAL(ARR,option, id) {
    var createOptions = document.createElement('option');
    var text,value;
    option.appendChild(createOptions);
    switch (id){
    case 'erecipeCODE':
    text = ARR[1];
    value = ARR[1];
    createOptions.setAttribute('key',ARR[1]);
    
    break;
    case 'erecipeName':
    text = ARR[0];
    value = ARR[0];
    createOptions.setAttribute('key',ARR[1]);
    
    break;
    case 'epackagingName':
    text = ARR.name;
    value = ARR.name;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'epackagingSKU':
    text = ARR.sku;
    value = ARR.sku;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eboxName':
    text = ARR.name;
    value = ARR.name;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eboxSKU':
    text = ARR.sku;
    value = ARR.sku;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eLabelName':
    text = ARR.name;
    value = ARR.name;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eLabelSKU':
    text = ARR.sku;
    value = ARR.sku;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eColorName':
    text = ARR.name;
    value = ARR.name;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eColorSKU':
    text = ARR.sku;
    value = ARR.sku;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    
    case 'eflavourmixName':
    text = ARR.name;
    value = ARR.name;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    case 'eflavourmixSKU':
    text = ARR.sku;
    value = ARR.sku;
    createOptions.setAttribute('key',ARR.sku);
    
    break;
    default:
    text='';
    value='';
    }
    
    createOptions.text = text;
    createOptions.value = value;

  //  createOptions.setAttribute('id',sku);
}

//Settin the value in the box by firing the click event
function setValGLOBAL(selectedVal,dropdown,inp,page) {

    inp.value = selectedVal.value;
    document.getElementById(dropdown).style.display = 'none';
    
    var key= $('option:selected', selectedVal).attr('key');
    console.log('key',key);
    console.log('page',page);
    google.script.run.withSuccessHandler(set_remaining_data).get_remaining_data(page,key);

}


var OLDITEM={};
function set_remaining_data(data){
 var item=data[0];
 var page=data[1];
  OLDITEM=item;
 switch (page){
 case 'Recipes':
 $('#erecipeCODE').val(item.id);
 $('#erecipeName').val(item.name);
 $('#erecipeVG').val(item.VGrec);
 $('#erecipePG').val(item.PGrec);
 $('#erecipeCBD').val(item.cbdrec);
 $('#erecipeMCT').val(item.MCTrecipe);
 $('#erecipeAG').val(item.AGrec);
 
 $('#erecipevgval').val(item.vg);
 $('#erecipepgval').val(item.pg);
 $('#erecipestrength').val(item.strength);
 
 $('#erecipeNicotine').val(item.Nicorec);
 $('#erecipeNicotineSalts').val(item.Nicorecsalts);
 $('#erecipeFlavour').val(item.Flavrec);
 $('#ecolorSelect').val(item.Color.sku);
 $('#ecolorpercentage').val(item.Color.val);
 break;
 
 case 'Packages':
 $('#epackagingSKU').val(item.sku);
 $('#epackagingName').val(item.name);
 $('#ebotperPack').val(item.botperPack);
 $('#eink').val(item.ink);
// $("select[name='etubelabel']").find("option[value='"+item.tubelabel.sku+"']").attr("selected",true);
 break;
 
 case 'Boxes':
 $('#eboxSKU').val(item.sku);
 $('#eboxName').val(item.name);
 $('#edivTubesForBox').val(item.divTubesForBox);

 break;
  case 'Labels':
 $('#eLabelSKU').val(item.sku);
 $('#eLabelName').val(item.name);


 break;
   case 'Color':
 $('#eColorSKU').val(item.sku);
 $('#eColorName').val(item.name);


 break;
 case 'FlavourMixes':
$(".editflavourmixBody #eflavourmixName").val(item.name);
$(".editflavourmixBody #eflavourmixSKU").val(item.sku);
createDropdownsForItem(item);
 
 break;
 default:
 break;
 }
 
 
 
}




$("#delete_edit_recipe").on('click',function(){
if(confirm('Are you sure you want to delete this recipe?')){
var key=   $('#erecipeCODE').val();
     google.script.run.withSuccessHandler(alert_deletion).remove_recipe(key);
       $('#erecipeCODE').val('');
       $('#erecipeName').val('');
       $('#erecipeVG').val('');
       $('#erecipePG').val('');
       $('#erecipeCBD').val('');
       
       $('erecipevgval').val('');
       $('erecipepgval').val('');
       $('erecipestrength').val('');
       
       $('#erecipeNicotine').val('');
        $('#erecipeNicotineSalts').val('');
       $('#erecipeFlavour').val('');
        $('#ecolorSelect').html('');
       $('#ecolorpercentage').val('');
       $('#newRecipe').modal('toggle');

}
});

$("#delete_edit_packaging").on('click',function(){
if(confirm('Are you sure you want to delete this packaging?')){
var key=   $('#epackagingSKU').val();
google.script.run.withSuccessHandler(alert_deletion).remove_packaging(key);
$('#epackagingSKU').val('');
$('#epackagingName').val('');
$('#ebotperPack').val('');
$('#eink').val('');
//$("select[name='etubelabel']").find("option[value='']").attr("selected",true);
$('#newPackaging').modal('toggle');

}
});

$("#delete_edit_box").on('click',function(){
if(confirm('Are you sure you want to delete this box?')){
var key=   $('#eboxSKU').val();
google.script.run.withSuccessHandler(alert_deletion).remove_box(key);
$('#eboxSKU').val('');
$('#eboxName').val('');
$('#edivTubesForBox').val('');
$('#newBox').modal('toggle');
}
});

$("#delete_edit_Label").on('click',function(){
if(confirm('Are you sure you want to delete this box?')){
var key=   $('#eLabelSKU').val();
google.script.run.withSuccessHandler(alert_deletion).remove_Label(key);
$('#eLabelSKU').val('');
$('#eLabelName').val('');

$('#newLabel').modal('toggle');
}
});

$("#delete_edit_Color").on('click',function(){
if(confirm('Are you sure you want to delete this box?')){
var key=   $('#eColorSKU').val();
google.script.run.withSuccessHandler(alert_deletion).remove_item(key,'Color');
$('#eColorSKU').val('');
$('#eColorName').val('');

$('#newColor').modal('toggle');
}
});

$("#newflavourmixButton").on('click',function(){
flavournum=0;
EDIT_FLAVMIX_CONST=false;
$(".newflavourmixBody #flavourDropdowns").html('');
$(".newflavourmixBody #flavourmixName").val('');
$(".newflavourmixBody #flavourmixSKU").val('');
$(".newflavourmixBody #flavourmixPlusButton").show();
$(".newflavourmixBody #flavourmixMinusButton").show();
$(".newflavourmixBody").show();

$(".editflavourmixBody").hide();
$("#deleteflavourmixButton").hide();
renderBottle();
google.script.run.withSuccessHandler(createFlavourDropdown).getFlavourDropdown();
});

$("#editflavourmixButton").on('click',function(){
EDIT_FLAVMIX_CONST=true;
$(".editflavourmixBody #flavourDropdowns").html('');
$(".editflavourmixBody #flavourmixName").val('');
$(".editflavourmixBody #flavourmixSKU").val('');
$(".editflavourmixBody #flavourmixPlusButton").show();
$(".editflavourmixBody #flavourmixMinusButton").show();
$(".editflavourmixBody").show();

$(".newflavourmixBody").hide();
$("#deleteflavourmixButton").show();
renderBottle();
google.script.run.withSuccessHandler(createFlavourDropdown).getFlavourDropdown();

 google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editflavourmixButton');

});
$("#deleteflavourmixButton").on('click',function(){
var key=$('#eflavourmixSKU').val();
google.script.run.withSuccessHandler(alert_deletion).remove_flavourmix(key);
$('#eflavourmixSKU').val('');
$('#eflavourmixName').val('');
$(".editflavourmixBody #flavourDropdowns").html('');
$('#newflavourmix').modal('toggle');

});
var EDIT_FLAVMIX_CONST=false;
var FLAVOURDROPDOWN='';
var flavournum=0;
function createFlavourDropdown(data){

FLAVOURDROPDOWN='';
var html='';
for (var i = 0; i < data.length; i++) {
html += '<option value="' + data[i].sku + '" id="' + data[i].sku + '">' + data[i].name + '<option>';
}
FLAVOURDROPDOWN =html;

}

$(".newflavourmixBody #flavourmixPlusButton").on('click',function(){
flavournum++;
var spec='';
var spec2='';
NEWFLAVOURSINFLAVOURMIX=[];
if(EDIT_FLAVMIX_CONST){
spec='e';
}else{
spec2='<option value="New Flavour" >New Flavour<option>';
}
var colorsARR=['black','#FF0000','#00FF00','#0000FF','#FFFF00','#00FFFF','#FF00FF','#800000','#808000','#008000','#008080',];
var selector='<div class="flavourBlock" id="'+spec+'flavourBlockID'+flavournum+'"><input type="text" class="form-control"  style="width:150px;display:inline-block; border:2px solid '+colorsARR[flavournum]+'; " id="'+spec+'flavourAmount'+flavournum+'" oninput="renderBottle()" placeholder="2"/>';
selector+='<select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="'+spec+'flavourSelect'+flavournum+'" onchange="checkifNewFlavourFlavourMixer(this)"   spec="'+spec+'"  flavournum="'+flavournum+'"  >' + FLAVOURDROPDOWN +spec2+ '</select>';
selector+='<input  class="form-control"   style="display:none; width: 200px;" id="'+spec+'flavourSelectSKU'+flavournum+'" placeholder="SKU" /><input  class="form-control"   style="display:none; width: 200px;" id="'+spec+'flavourSelectNAME'+flavournum+'"  placeholder="Name" /></div>';

console.log('flavournum', flavournum)
$(".newflavourmixBody #"+spec+"flavourDropdowns").prepend(selector);
});
var NEWFLAVOURSINFLAVOURMIX=[];
function checkifNewFlavourFlavourMixer(event){
var value = $(event).val();
if(value=='New Flavour'){
var spec=$(event).attr('spec');
var flavournum=$(event).attr('flavournum');
$(event).hide();
$('#'+spec+'flavourSelectSKU'+flavournum).show().css('display','inline-block');
$('#'+spec+'flavourSelectNAME'+flavournum).show().css('display','inline-block');
NEWFLAVOURSINFLAVOURMIX.push(flavournum);
console.log(NEWFLAVOURSINFLAVOURMIX);
}
}
$(".newflavourmixBody #flavourmixMinusButton").on('click',function(){
var spec='';
if(EDIT_FLAVMIX_CONST){
spec='e';
}
$(".newflavourmixBody #flavourDropdowns #"+spec+"flavourBlockID"+flavournum).remove();
if(flavournum!=0){
flavournum--;
}
console.log('flavournum', flavournum)
});

function renderBottle(){
console.log('rendering');

var colorsARR=['black','#FF0000','#00FF00','#0000FF','#FFFF00','#00FFFF','#FF00FF','#800000','#808000','#008000','#008080',];
var total=0;
   var special='';
   var special2='';
   if(EDIT_FLAVMIX_CONST){
   special2='.editflavourmixBody #';
   special='.editflavourmixBody #e';
   }else{
   special='.newflavourmixBody #';
   special2='.newflavourmixBody #';
   }
    for(var i=1;i<=10;i++){
$(special2+"bottleBlock"+i).css('background-color','white');
}
var vals=[];    
for(var i=1;i<=flavournum;i++){
var val=parseInt($(special+'flavourAmount'+i).val(),10);
vals.push(val);
  for(var j=total+1;j<=val+total;j++){
  console.log('setting color for',j);
    $(special2+"bottleBlock"+j).css('background-color',colorsARR[i]);
  }
  total+=val;
  if(total>10){
  alert('Warning! Mix will exceed the 10ml limit.');
  }
}
var html='';
var totalHTML='';
if(total==10){
totalHTML='<span style="color:green;">'+total+'</span>';
}else{
totalHTML='<span style="color:red;">'+total+'</span>';
}
for(var i=0;i<vals.length;i++){
if(i<vals.length-1){
html+='<span style="color:'+colorsARR[i+1]+';">'+vals[i]+'</span>+';
}else{
html+='<span style="color:'+colorsARR[i+1]+';">'+vals[i]+'</span>='+totalHTML;
}
}
$(special2+'totalsDiv').html(html);

}

function createDropdownsForItem(item){
$(".editflavourmixBody #flavourDropdowns").html('');
var flavours=JSONtoARR(item.flavours);
console.log(flavours);
flavournum=1;
for(var i=0;i<flavours.length;i++){
var spec='';
if(EDIT_FLAVMIX_CONST){
spec='e';
}
var colorsARR=['black','#FF0000','#00FF00','#0000FF','#FFFF00','#00FFFF','#FF00FF','#800000','#808000','#008000','#008080',];

var selector='<div class="flavourBlock" id="'+spec+'flavourBlockID'+flavournum+'"><input type="text" class="form-control" oninput="renderBottle()"  style="width:150px;  display:inline-block; border:2px solid '+colorsARR[flavournum]+';" id="'+spec+'flavourAmount'+flavournum+'" placeholder="20"/><select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="'+spec+'flavourSelect'+flavournum+'">' + FLAVOURDROPDOWN + '</select></div>';
$(".editflavourmixBody #flavourDropdowns").prepend(selector);
$("#"+spec+"flavourAmount"+flavournum).val(flavours[i].val);
$("#"+spec+"flavourSelect"+flavournum).val(flavours[i].sku)
flavournum++;
  }
flavournum=flavours.length;
renderBottle();
}



function alert_deletion(msg){
alert(msg);
}

function JSONtoARR(data) {
    if (data) {
    var result = Object.keys(data).map(function(key) {
      return data[key];
    });
    
    return result;
  } else {
        return [];
    }

}

$("#priorityButton").on('click',function(){
$("#priorityDropdowns").html('');
    google.script.run.withSuccessHandler(populateOrderIDsPriority).getOrderIDs('priority');
      $("#updating").css("display", "block");
});





var PRIORITYDROPDOWN='';
var prioritynum=0;
function populateOrderIDsPriority(data){
prioritynum=0;
PRIORITYDROPDOWN='';
var html='<option value="null" />';
for (var i = 0; i < data.length; i++) {
html += '<option value="' + data[i][2] + '" orderID="' + data[i][1] + '" >' + data[i][1] + '<option>';
}
PRIORITYDROPDOWN =html;
  $("#updating").css("display", "none");
  $("#priorityPlusButton").click();
}

$("#priorityPlusButton").on('click',function(){
prioritynum++;

var selector='<div class="priorityBlock" id="priorityBlockID'+prioritynum+'"><select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="prioritySelect'+prioritynum+'"   onchange="checkifPriority(this)"  prioritynum="'+prioritynum+'"  >' + PRIORITYDROPDOWN + '</select>';
selector+='<input type="text" class="form-control"  style="width:150px;display:inline-block; " id="priorityAmount'+prioritynum+'" /></div>';

$("#priorityDropdowns").append(selector);
});
var NEWFLAVOURSINFLAVOURMIX=[];
function checkifPriority(event){
var value = $(event).val();
var prioritynum=$(event).attr('prioritynum');
if(value=='null'){
$("#priorityAmount"+prioritynum).val('');
}else{
$("#priorityAmount"+prioritynum).val(value);
}
}
$("#priorityMinusButton").on('click',function(){
$("#priorityDropdowns #priorityBlockID"+prioritynum).remove();
if(prioritynum!=0){
prioritynum--;
}

});
 $('#savepriorityButton').on('click', function(e) {
    var special='';
    var newPRIORITIES=[];
  
    for(var i=1;i<=prioritynum;i++){
    var priority=$("#priorityAmount"+i).val();
    var oldpriority=$("#prioritySelect"+i).val();
    if(priority=='null'){
    continue;
    }
    var orderID=$("#prioritySelect"+i+" option:selected").attr('orderID');
    if(orderID){
    if(priority !=oldpriority){
    newPRIORITIES.push([priority,oldpriority,true,orderID]);
    }
    }
    }
    console.log(newPRIORITIES);
      $("#updating").css("display", "block"); 
google.script.run.withSuccessHandler(successPriorityEdit).setPriorityARR(newPRIORITIES);

    });


function successPriorityEdit(e){
alert(e);
  filterpage('xx',true);
 // google.script.run.withSuccessHandler(populateOrderIDsPriority).getOrderIDs('priority');
   $("#updating").css("display", "none");
}


// DELETE AND REVERSE

function deleteandreverseSelected(){

var ms="WARNING! You are about to delete all the selected orders.All their stock allocations will be reversed. \n Do you wish to proceed?";
var r = confirm(ms);
if (r == true) {
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo(SELECTED,'deleteandreverse');

}

}

function deleteandreverseSingle(event){

var ms="WARNING! You are about to delete the selected order. All the stock allocations will be reversed. \n Do you wish to proceed?";
var r = confirm(ms);
if (r == true) {
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo([$(event).attr('batch')],'deleteandreverse');

}
return false;
}
function reverseSelected(){

var ms="WARNING! You are about to reverse all the selected orders.All their stock allocations will be reversed. \n Do you wish to proceed?";
var r = confirm(ms);
if (r == true) {
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo(SELECTED,'reverse');

}

}

function reverseSingle(event){

var ms="WARNING! You are about to reverse the selected order. All the stock allocations will be reversed. \n Do you wish to proceed?";
var r = confirm(ms);
if (r == true) {
    $("#updating").css("display", "block");
 google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo([$(event).attr('batch')],'reverse');

}
return false;
}

var htmlModalType;
//var modalclosed=true;
var loopTimeout=0;
function buildhtmlmodal(rett){
$('.htmlMSGmodalbody').html('');
try{
loopTimeout=0;
var data=rett[0];
var type=rett[1];
htmlModalType=type;
var built='';
console.log('rett',rett);
switch (type){
    case 'backupAndRestore':
    built= buildbackupAndRestore(data);
    break;
    case 'deleteandreverse':
    built= buildDeleteAndReverse(data);
    break;
    case 'reverse':
    built= buildReverse(data);
    break;
    case 'statuscheck':
    built= buildCheckStock(data);
    break;
    case 'generatePUB':
    built= buildgeneratePUB(data);
    break;
    case 'createAutoPUB':
    built= buildAutoPUB(data);
    break;
    case 'Machines':
    built= buildMachinesModal(data);
    break;
    case 'SchedulePrompt':
    built= buildSchedulePrompt();
    break;
    case 'FillLevels':
    built= buildFillTimeManagement(data);
    break;
    case 'ScheduleManage':
    built= buildScheduleManagement(data);
    break;
    case 'PackagePrint':
    built= buildPackagePrint(data);
    break;
    case 'Roundups':
    built= buildRoundups(data);
    break;
    case 'globalFilter':
    built= buildglobalFilter(data);
    break;
  default:

  break;
}
$('.htmlMSGmodalbody').html(built);
//modalclosed=false;
$('#htmlMSGmodal').modal('show');
 
//$('#htmlMSGmodal').show();



}catch(e){

alert(rett);
}
$("#updating").css("display", "none");
}


var DELandREVData=[];
function buildDeleteAndReverse(list){
DELandREVData=list;
console.log(list);
var html='';
html+='<h2>Status of orders</h2>';
html+='<table class="table"><thead><tr><th>Batch</th><th>Orders</th><th>Mixing</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Delete Status</th></tr></thead>';
html+='<tbody>';
for(var i=0;i<list.length;i++){
html+='<tr>';

for(var j=0;j<list[i].length;j++){
if(j==0){
html+='<td>'+list[i][j]+'</td>';
}else{

  if(list[i][j][0]=='Completed'){
  html+='<td bgcolor="#1BEF5B">';
  }else if(list[i][j][0]=='Busy'){
   html+='<td bgcolor="#1BCFEF">';
  }else{
   html+='<td>';
  }

html+=list[i][j][0]+'</td>';
}
}
html+='<td><input class="deletereversecheckbox" type="checkbox" value="'+list[i][0]+'" checked></td>';
html+='</tr>';
}
html+='</tbody></table>';
html+='<br />';
html+='<br />';
html+='<button class="btn btn-success" style="margin:20px;" onclick="deleteandreverseTHESE()">Delete Checked</button></div>';

return html;
}
var REVData=[];
function buildReverse(list){
REVData=list;
console.log(list);
var html='';
html+='<h2>Status of orders</h2>';
html+='<table class="table"><thead><tr><th>Batch</th><th>Orders</th><th>Mixing</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Reverse Status</th></tr></thead>';
html+='<tbody>';
for(var i=0;i<list.length;i++){
html+='<tr>';

for(var j=0;j<list[i].length;j++){
if(j==0){
html+='<td>'+list[i][j]+'</td>';
}else{

  if(list[i][j][0]=='Completed'){
  html+='<td bgcolor="#1BEF5B">';
  }else if(list[i][j][0]=='Busy' ){
   html+='<td bgcolor="#1BCFEF">';
  }else{
   html+='<td>';
  }

html+=list[i][j][0]+'</td>';
}
}
html+='<td><input class="reversecheckbox" type="checkbox" value="'+list[i][0]+'" checked></td>';
html+='</tr>';
}
html+='</tbody></table>';
html+='<br />';
html+='<br />';
html+='<button class="btn btn-success" style="margin:20px;" onclick="reverseTHESE()">Reverse Checked</button></div>';

return html;
}
function buildCheckStock(list){
DELandREVData=list;
console.log(list);
var html='';
html+='<h2>Status of orders</h2>';
html+='<table class="table"><thead><tr><th>Batch</th><th>Order ID</th><th>Start Time</th><th>Customer</th><th>Orders</th><th>Mixing</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Date Shipped</th><th>Shipping Code</th></tr></thead>';
html+='<tbody>';
for(var i=0;i<list.length;i++){
html+='<tr>';
var skipRows=[0,1,2,3,4,5];
for(var j=0;j<list[i].length;j++){
if(j==4||j==5){
continue;
}
if(j==0||j==1||j==2||j==3||j==4||j==5){
html+='<td>'+list[i][j]+'</td>';
}else{
  if(list[i][j][0]=='Completed'){
  html+='<td bgcolor="#1BEF5B">';
  }else if(list[i][j][0]=='Busy' ){
   html+='<td bgcolor="#1BCFEF">';
  }else{
   html+='<td>';
  }

html+=list[i][j][0]+'</td>';
}
}
html+='<td>'+list[i][4]+'</td>';
html+='<td>'+list[i][5]+'</td>';
html+='</tr>';
}
html+='</tbody></table>';
html+='<br />';
html+='<br />';
html+='</div>';

return html;
}

function buildgeneratePUB(data){

var html='';
html+='<h2>Status of orders</h2>';
html+='<p>'+data+'</p>';

return html;
}
function deleteandreverseTHESE(){
var ms='Are you sure you want to proceed?'
var r = confirm(ms);
if (r == true) {
$("#updating").css("display", "block");
var arr = [];
$('input.deletereversecheckbox:checkbox:checked').each(function () {
arr.push($(this).val());
});
var final=[];

for(var j=0; j<DELandREVData.length;j++){
for(var i =0;i<arr.length;i++){
if(arr[i]==DELandREVData[j][0]){
  final.push(DELandREVData[j])
  }
}
}
console.log(final);


google.script.run.withSuccessHandler(deleteandreverseSuccess).deleteAndReverse(final,'delete');
$('#htmlMSGmodal').modal('hide');

}
}
function reverseTHESE(){
console.log('REVData',REVData);
var ms='Are you sure you want to proceed?'
var r = confirm(ms);
if (r == true) {
$("#updating").css("display", "block");
var arr = [];
$('input.reversecheckbox:checkbox:checked').each(function () {
arr.push($(this).val());
});
var final=[];

for(var j=0; j<REVData.length;j++){
for(var i =0;i<arr.length;i++){
if(arr[i]==REVData[j][0]){
  final.push(REVData[j])
  }
}
}
console.log(final);


google.script.run.withSuccessHandler(deleteandreverseSuccess).deleteAndReverse(final,'reverse');
$('#htmlMSGmodal').modal('hide');

}
}
function deleteandreverseSuccess(msg){

filterpage('xx',true);
alert(msg);
$("#updating").css("display", "none");
}



$("#generatePUB").on('click',function(){
$("#updating").css("display", "block");
 google.script.run.withSuccessHandler(buildhtmlmodal).generatePremixBrandUnbrand();

})
var tempPUB;
function createReferenceItems(){
var id=$('#mysheet13').val();
$('#htmlMSGmodal').modal('hide');
$("#updating").css("display", "block");
 google.script.run.withSuccessHandler(checkProccessStatus).updateGeneratedData(tempPUB,id);

}
function createReferenceSuccess(msg){
$("#updating").css("display", "none");
alert(msg);
}

function buildAutoPUB(data){
tempPUB=data;
var html='<div>';
html+='<h2>Generated Items</h2>';


html+='<table class="table"><thead><tr><th>Row</th><th>Premix</th><th>Colored Premix</th><th>Unbranded</th><th>Branded</th></tr></thead>';
html+='<tbody>';
if(data[4]){
for(var i=0;i<data[0].length;i++){
html+='<tr>';
html+='<td>'+(i+2)+'</td>';
if(data[0][i][0]){
html+='<td>'+data[0][i][0]+' - '+data[0][i][1]+'</td>';
}else{
html+='<td>-/-</td>';
}
if(data[1][i][0]){
html+='<td>'+data[1][i][0]+' - '+data[1][i][1]+'</td>';
}else{
html+='<td>-/-</td>';
}
if(data[2][i][0]){
html+='<td>'+data[2][i][0]+' - '+data[2][i][1]+'</td>';
}else{
html+='<td>-/-</td>';
}
if(data[3][i][0]){
html+='<td>'+data[3][i][0]+'</td>';
}else{
html+='<td>-/-</td>';
}
html+='</tr>';
}
}
html+='<tr><td></td><td></td><td></td><td></td><td><button class="btn btn-success" onclick="createReferenceItems()" id="createReferenceItems">Save</button></td></tr>';

html+='</tbody></table>';
if(data[5][0]){
html+='<h4>Failed Items</h4> <p> These Items have failed because the listed flavour and/or recipe wasnt found in the database.</p> <br>';
html+='<table class="table"><thead><tr><th>Product Code</th><th>Recipe ID</th><th>Flavour ID</th></tr></thead>\
<tbody>';
for(var i=0;i<data[5].length;i++){
html+='<tr>\
<td>'+data[5][i][0]+'</td>\
<td>'+data[5][i][1]+'</td>\
<td>'+data[5][i][2]+'</td>\
</tr>';
}

html+='</tbody></table>';
}
html+='</div>';
return html;
}


function checkProccessStatus(resp){
console.log(resp);
console.log('looped',loopTimeout);
if(loopTimeout==360){
loopTimeout=0;
resp[1]=='FAILED'
}else{
loopTimeout+=20;
}
switch (resp[1]){
  case 'importBlankPCPC2':
  if(resp[0]){
    loopTimeout=0;
  buildhtmlmodal(resp[2]);
  }else{

  google.script.run.withSuccessHandler(checkProccessStatus).importBlankPCPC2Ping($('#mysheet13').val());
  }
  break;
  case 'updateGeneratedData':
  if(resp[0]){
    loopTimeout=0;
  createReferenceSuccess(resp[2]);
  }else{
  
  google.script.run.withSuccessHandler(checkProccessStatus).updateGeneratedDataPing();
  }
  break;
  case 'restorePoint':
  if(resp[0]){
  loopTimeout=0;
  createRestoreSuccess(resp[2]);
  }else{
  
  google.script.run.withSuccessHandler(checkProccessStatus).restorePointPing();
  }
  break;
  default:
  alert('FAILED');
  $("#updating").css("display", "none");
  return;
}


}


//SCHEDULING CODE

$("#saveSchedule").on('click',function(){

      buildhtmlmodal(['','SchedulePrompt']);


});

function buildSchedulePrompt(){
var html='';
html+='<div class="schedulePrompt">'; 
html+='<p>Please enter a name and select how the schedule will be saved.</p>'; 
html+='<div>';
html+='<div class="form-group">';
html+='<label for="scheduleName">Name</label>';
html+='<input type="text" class="form-control" id="scheduleName"  placeholder="Name">';
html+='</div>';
html+='<div class="form-group">';
html+='<label for="exampleInputPassword1">Save Type:</label>';
html+='<select class="form-control" id="scheduleSaveType"  onchange="checkSaveTypeScheduler(this)"><option value="automatic">Automatic</option  selected><option value="manual">Manual</option></select>';
html+='</div>';
html+='<div class="form-group" style="display:none" id="manualTime">';
html+='<select   class="form-control" id="scheduleInsert" title="Auto allocate schedule from the selected date, or Insert the schedule and move any others down." style="display:inline-block;" ><option value="auto">Auto</option><option value="insert">Insert</option></select>';
html+='<input type="date" class="form-control" style="display:inline-block;" id="scheduleDate" onchange="checkSaveDateScheduler(this)"/><select   class="form-control" id="scheduleTime" style="display:inline-block;" ></select><p id="invaliddate" style="color:red;display:none;">Invalid date.</p>'
html+='</div>';
html+='<button type="button" class="btn btn-success" id="saveScheduleButton" onclick="saveSchedulefunction()">Save</button>';
html+='</div>';
html+='<div style="margin-top:50px;">\
  <div"><table class="table"><thead><tr><th>Select Date to Preview:</th><th><input type="date" class="form-control" style="display:inline-block;" onchange="loadSchedulePreview(this)"/></th></tr></thead></table></div>\
   <div id="schedulePreview"></div>\
  </div>';
html+='</div>';


return html;
}
function loadSchedulePreview(event){
var date = new Date($(event).val());
console.log('date.getTime()',date.getTime());
 google.script.run.withSuccessHandler(renderSchedule).GetSchedulePreview(date.getTime());

}
function renderSchedule(schedule){
console.log('schedule',schedule);
if(schedule.length==0){
$('#schedulePreview').html('');
return;
}
var html='<table class="table"><thead><tr>';
for(var i=0;i<schedule[0].length;i++){
html+='<th>'+schedule[0][i]+'</th>';
}
html+='</tr></thead>\
<tbody>';

for(var i=1;i<schedule.length;i++){
var found=false;
  for(var j=1;j<schedule[i].length;j++){
    if(schedule[i][j] && schedule[i][j] != " "){
    found=true;
      break;
    }
  }
  if(!found){continue;}
html+='<tr>';
  for(var j=0;j<schedule[i].length;j++){
    if(schedule[i][j]){
      html+='<td style="border-top: 1px solid #e9ecef;" >'+schedule[i][j]+'</td>';
    }else{
      html+='<td style="border-top: 1px solid #e9ecef;" bgcolor="#afafaf"></td>';
    }
  }
html+='</tr>';
}
html+='</tbody></table>';

$('#schedulePreview').html(html);
}
function checkSaveTypeScheduler(event) {
    var html = '';
    if ($(event).val() == 'manual') {
        $('#manualTime').show();
    } else {
        $('#manualTime').hide();
    }
}

function checkSaveDateScheduler(event) {
    var date = new Date($(event).val());
    var now = new Date();
    if (date.getTime() <= now.getTime() - 1000 * 60 * 60 * 24) {
        $("#invaliddate").show();
    } else {
        $('#invaliddate').hide();
        google.script.run.withSuccessHandler(getTimesOptions).getEmptySchedule(date.getTime());

        function getTimesOptions(data) {
            var html = '';
            var now = new Date();
            now.setUTCHours(0, 0, 0, 0);
            for (var i = 0; i < 288; i++) {
                if (data.indexOf(i * 5)>=0) {
                    html += "<option value=" + i * 5 + " >" + formatAMPM4(now) + "</option>";
                }
                now = new Date(now.getTime() + 5 * 60 * 1000);
            }
            $("#scheduleTime").html(html);
        }
    }
}

function formatAMPM(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0' + minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

function formatAMPM4(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
//    var ampm = hours >= 12 ? 'pm' : 'am';
//    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0' + minutes : minutes;
    var strTime = hours + ':' + minutes;
    return strTime;
}

function saveSchedulefunction() {
    var name = $("#scheduleName").val();
    if (!name) {
        alert('Please enter a name!');
        return 0;
    }
    if ($("#scheduleSaveType").val() == 'manual' && !(new Date($("#scheduleDate").val()).getTime())) {
        alert('Please enter a date!');
        return 0;
    }
    var obj = {
        name: name,
        type: $("#scheduleSaveType").val(),
        entryDate: (new Date()).getTime(),
    }
    if (obj.type == 'manual') {
        obj.date = new Date($("#scheduleDate").val());
        obj.date = new Date(obj.date).setUTCHours(0,0,0,0);
      
        obj.time = $("#scheduleTime").val();
    }
    $("#updating").css("display", "block");
    
   var saveType= $("#scheduleInsert").val();
   if(saveType=='auto'){
    google.script.run.withSuccessHandler(schedulesaveSuccess).saveSchedule(splitPAGES, obj);
    }else{
    google.script.run.withSuccessHandler(schedulesaveSuccess).insertNewSchedule(splitPAGES, obj);
    }
}

function schedulesaveSuccess(msg){

alert(msg);
$("#updating").css("display", "none");
}


function refreshMachines(msg){
$("#machineopssku").val('');
$("#machineopsname").val('');
$("#machineopsfillLevels").val('');
$("#machineopsactive").prop('checked',false);
$("#MachineOps").hide();

alert(msg);
google.script.run.withSuccessHandler(buildhtmlmodal).getMachines();
}

$("#machineManage").on('click',function(){
google.script.run.withSuccessHandler(buildhtmlmodal).getMachines();

});
function buildMachinesModal(data){
var html='';
var dropdown='<option></option>';
for(var i=0;i<data.length;i++){
dropdown+='<option sku="'+data[i].id+'" value="'+data[i].id+'">'+data[i].name+'</option>';
}
html+='<div>';
html+='<p>Please make sure the Machine fill levels follow the format: 10,20,32,35, etc... If a machine is active, but has no fill levels, then it will not be used in scheduling.</p>';
html+='<table class="table"><head>';
html+='<tr><th>Machines</th><th>Status</th><th>Fill Levels</th><th></th><th></th></tr></head>';
html+='<body>';
for(var i=0;i<data.length;i++){
var selectedDropdown=dropdown;
if(data[i].follow){
selectedDropdown=selectedDropdown.replace('sku="'+data[i].follow+'"','sku="'+data[i].follow+'" selected');

}
html+='<tr><td>'+data[i].name+'</td>';
var status = data[i].status ? "ON" : "OFF";
html+='<td>'+status+'</td>';
html+='<td>'+data[i].fillLevels+'</td>';
html+='<td><button   type="button" class="btn btn-primary" fillLevels="'+data[i].fillLevels+'" status="'+data[i].status+'"  sku="'+data[i].id+'" name="'+data[i].name+'" onclick="editMachine(this)">Edit</button></td><td><button  type="button" class="btn btn-danger" sku="'+data[i].id+'"   status="'+data[i].status+'"  name="'+data[i].name+'"  onclick="deleteMachine(this)">Delete</button></td></tr>'

}
html+='<tr><td></td><td></td><td></td><td></td><td><button class="btn btn-success" onclick="newMachine()">New Machine</button></td></tr>';
html+='</body></table>';

html+='<div id="MachineOps" style="display:none">';
html+='<table class="table"><thead><tr><th>SKU</th><th>Status</th><th>Fill Levels</th><th>Name</th><th></th></tr></thead><tbody>';
html+='<tr><td><input type="text" id="machineopssku" class="form-control" disabled></td>';
html+='<td><input class="form-control" type="checkbox"  id="machineopsactive" /></td>';
html+='<td><input class="form-control" type="text"  id="machineopsfillLevels" /></td>';
html+='<td><input type="text" id="machineopsname" class="form-control" /></td></tr>';
html+='<tr><td><button type="button" class="btn btn-success"  onclick="saveMachine()">Save Machine</button></td><td></td></tr>';
html+='</tbody></table></div>';
html+='</div>';
return html;

}

function changeMachineLogic(event){
var machine1=$(event).attr('sku');
var machine2=$(event).val();
google.script.run.withSuccessHandler(schedulesaveSuccess).changeMachineLogic(machine1,machine2);
}
function newMachine(event){

$("#machineopssku").prop('disabled', false);
$("#MachineOps").show();
}
function editMachine(event){
$("#machineopssku").prop('disabled', true);
$("#machineopssku").val($(event).attr('sku'));
$("#machineopsactive").prop('checked', $(event).attr('status'));
$("#machineopsname").val($(event).attr('name'));
$("#machineopsfillLevels").val($(event).attr('fillLevels'));
$("#MachineOps").show();

}
function deleteMachine(event){

var sku=$(event).attr('sku');
if(confirm("Are you sure you want to delete this Machine?")){
google.script.run.withSuccessHandler(refreshMachines).remove_item(sku,'Machines');
}
}

function saveMachine(){
var obj={
id:$("#machineopssku").val(),
name:$("#machineopsname").val(),
status:$("#machineopsactive").prop('checked'),
fillLevels:$("#machineopsfillLevels").val(),
}
if(!obj.id){
alert('No SKU!');
return false;
}
console.log('obj',obj);
google.script.run.withSuccessHandler(refreshMachines).newBasicItem(obj, 'Machines');
}


$("#FillTimeManage").on('click',function(){
google.script.run.withSuccessHandler(buildhtmlmodal).getFillLevels();

});

function refreshFillTimes(msg){

alert(msg);
google.script.run.withSuccessHandler(buildhtmlmodal).getFillLevels();
}

function buildFillTimeManagement(data){

var html='';

html+='<div>';
html+='<p>Please write in the ammount of time in <b>minutes.</b> Ex. 30ml: 1.5 </p>';
html+='<table class="table"><head>';
html+='<tr><th>Fill</th><th>Time</th><th></th></tr></head>';
html+='<body>';
for(var i=0;i<data.length;i++){

html+='<tr><td>'+data[i].name+'ml</td><td><input class="form-control" id="fillTime'+data[i].sku+'" sku="'+data[i].sku+'" oninput="showSaveChange(this)" value="'+data[i].time+'"></td><td><button  type="button" class="btn btn-success" id="saveChange'+data[i].sku+'" sku="'+data[i].sku+'"  name="'+data[i].name+'"  style="display:none;" onclick="saveChange(this)">Save</button></td><td><button  type="button" class="btn btn-danger" sku="'+data[i].sku+'"  name="'+data[i].name+'"  onclick="deleteFill(this)">Delete</button></td></tr>'

}
html+='<tr><td></td><td></td><td></td><td><button class="btn btn-success" onclick="newFill()">New Fill</button></td></tr>';
html+='</body></table>';

html+='<div id="FillOps" style="display:none">';
html+='<table class="table"><thead><tr><th>Fill</th></tr></thead><tbody>';
html+='<tr><td><input type="text" id="fillamount" class="form-control" ></td></tr>';
html+='<tr><td><button type="button" class="btn btn-success"  onclick="saveFill()">Save Fill</button></td></tr>';
html+='</tbody></table></div>';
html+='</div>';
return html;
}
function newFill(event){

$("#machineopssku").prop('disabled', false);
$("#FillOps").show();
}
function showSaveChange(event){
$("#saveChange"+$(event).attr('sku')).show();
}

function deleteFill(event){

var sku=$(event).attr('sku');
if(confirm("Are you sure you want to delete this Fill?")){
google.script.run.withSuccessHandler(refreshFillTimes).remove_item(sku,'FillLevels');
}
}
function saveChange(event){

var sku=$(event).attr('sku');
var time=$("#fillTime"+$(event).attr('sku')).val();
var obj={
sku:sku,
time:parseFloat(time),

}
google.script.run.withSuccessHandler(schedulesaveSuccess).changeFillLevelTime(obj);

}
function saveFill(){
var obj={
sku:$("#fillamount").val(),
name:$("#fillamount").val(),
time:1,
}
if(!obj.sku){
alert('No SKU!');
return false;
}
$('#htmlMSGmodal').modal('hide');
google.script.run.withSuccessHandler(refreshFillTimes).newBasicItem(obj, 'FillLevels');
}

function setScheduleDropdown(data){
var html='';
if(data){
for(var i=0;i<data.length;i++){
html+='<option value="'+data[i][0]+'">'+data[i][1]+'</option>';

}
}
$('#scheduleSelect').html(html);
$("#updating").css("display", "block");
console.log('selPage setScheduleDropdown',selPage);
google.script.run.withSuccessHandler(filterResult).getScheduleDataNearest(selPage);

}
$('#getSelectedScheduleButton').on('click',function(){
var selectedID=$('#scheduleSelect').val();

$("#updating").css("display", "block");
google.script.run.withSuccessHandler(filterResult).getScheduleData(selectedID,selPage);
});

$('#scheduleManage').on('click',function(){
refreshScheduleView();

});
function refreshScheduleView(){

google.script.run.withSuccessHandler(buildhtmlmodal).getScheduleView();

}

var ScheduleData=[];
function buildScheduleManagement(rett){
var days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
console.log(rett);
var data=rett[0];
ScheduleData=rett[0];
var Breaks=rett[1];
var scheduleSelector='';
 var html='<div >';
html+= getNavBarSchedule();
html+='<div id="BreaksView" class="scheduleDivs" style="display:none;"><br><br><h2>Breaks</h2>\
        <p>Please write in shifts and breaks in the format: HH:MM - HH:MM, HH:MM - HH:MM   <br> Example: 12:30 - 13:00, 17:00 - 17:30 </p>\
      <table class="table">\
 <thead><tr><th>Day</th><th>Active</th><th>Shifts</th><th>Breaks</th></tr></thead>\
 <tbody>';
for(var i=0;i<days.length;i++){
html+='<tr>';
html+='<td>'+days[i]+'</td>';
html+='<td><input class="form-control" type="checkbox"  id="active'+days[i]+'"';
if(Breaks[days[i]]){
html+='checked >'
}else{
html+=' >'
}
html+='</td>';

if(Breaks[days[i]]){
html+='<td><input class="form-control" type="text"  id="shifts'+days[i]+'" value="'+Breaks[days[i]].shiftTimes+'"></td>';
}else{
html+='<td><input class="form-control" type="text"  id="shifts'+days[i]+'"></td>';
}

if(Breaks[days[i]]){
html+='<td><input class="form-control" type="text"  id="breaks'+days[i]+'" value="'+Breaks[days[i]].breakTimes+'"></td>';
}else{
html+='<td><input class="form-control" type="text"  id="breaks'+days[i]+'"></td>';
}
html+='</tr>';
}


html+='</tbody></table>\
<button type="button" class="btn btn-default" id="saveBreaks" onclick="saveBreaks(this)">Save Breaks</button>\
</div>';
html+='<div  id="schedulesView" class="scheduleDivs"><br><br><h2>Schedules</h2><table class="table">';
        html+='<thead><tr><th>Entry Date</th><th>Scheduled For</th><th>Name</th><th>Type</th><th>View</th></tr></thead>';
       html+='<tbody>';
         for(var i=0;i<data.length;i++){
         html+='<tr>';
         for(var j=1;j<data[i].length-1;j++){
         if(j==1){
         html+='<td>'+formatDateDisplay2(data[i][j])+'</td>';
         }else if(j==2){
         html+='<td>'+formatDateDisplay(data[i][j])+'</td>';
         }else{
      
         html+='<td>'+data[i][j]+'</td>';
         }
         }
         html+='<td><button type="button" class="btn btn-default" id="'+i+'" onclick="PreviewSchedule(this)">View</button></td>';
         html+='</tr>';
            scheduleSelector+='<option value="'+data[i][1]+'">'+data[i][3]+'</option>';
         }
        
        html+='</tbody></table>\
        <p><br></p></div>\
        <div id="EditScheduleView" class="scheduleDivs" style="display:none;"></div>\
        <div id="PrintScheduleView" class="scheduleDivs" style="display:none;">\
          <select class="form-control" id="SchedulePrintType" onchange="SchedulePrintTypeChange()" ><option value="Today">Today</option><option value="FromTo">From - To</option><option value="scheduleSelect">Schedule</option></select>\
          <div id="PrintToday" class="printInnerDiv"><p>Only Todays Schedule Will Be Printed</p></div>\
          <div id="PrintFromTo" style="display:none;" class="printInnerDiv">\
          <p>Select Dates "From" and "To" to print schedules.</p>\
          <br>\
           <input type="date" class="form-control" id="fromSchedulePrint"\>\
           <input type="date" class="form-control" id="toSchedulePrint"\>\
            <br>\
          </div>\
          <div id="PrintscheduleSelect" style="display:none;" class="printInnerDiv">\
            <p>Select one or multiple Schedules to print.</p>\
            <br>\
            <select class="form-control" id="scheduleSelector" multiple>'+scheduleSelector+'</select>\
             <br>\
          </div>\
          <button type="button" class ="btn btn-success" onclick="printSchedule()">Print</button>\
          </br>\
          <span id="schedulePrintResult"></span>\
        </div>\
        </div>';
return html;
}
function SchedulePrintTypeChange(){
var printType=$("#SchedulePrintType").val();
$(".printInnerDiv").hide();
$("#Print"+printType).show();

}

function printSchedule(){
var type=$("#SchedulePrintType").val();
var opt={};
if(type=='Today'){
}else if(type=='FromTo'){
opt.from=new Date($("#fromSchedulePrint").val()).setUTCHours(0,0,0,0);
opt.to=new Date($("#toSchedulePrint").val()).setUTCHours(0,0,0,0);
}else{
var items = [];
$('#scheduleSelector option:selected').each(function(){ items.push($(this).val()); });
opt.selected=items;
}
$("#updating").css("display", "block");
google.script.run.withSuccessHandler(schedulePrintSuccess).printSchedules(opt,type);

}

function schedulePrintSuccess(item){
$("#updating").css("display", "none");
var html="";
if(!item.error){
html+="<p>Recently Printed Schedule:</p>";
html+='<br>'
html+='<a  target="_blank" href="'+item.url+'">'+item.name+'</a>'
}else{
html+='<h5>'+item.error+'</h5>'
}
$("#schedulePrintResult").html(html);

}

var ScheduleBeingEdited=[];
function PreviewSchedule(event){
var id=$(event).attr('id');
ScheduleBeingEdited=ScheduleData[id][0];
var existingTimes='';
 var now = new Date();
 now.setUTCHours(0, 0, 0, 0);
 for (var i = 0; i < 288; i++) {

 existingTimes += "<option value=" + i * 5 + " >" + formatAMPM4(now) + "</option>";

 now = new Date(now.getTime() + 5 * 60 * 1000);
 }
var html='<p>All Edited Schedules will have their TYPE changed to "manual" if anything other than their Name is changed..</p>';
html+='<table class="table"><thead>\
<tr><th>Entry Date:</th><th>'+formatDateDisplay2(ScheduleData[id][0].entryDate)+'</th></tr>\
<tr><th>Type:</th><th><input  class="form-control" id="scheduleType" value="'+ScheduleData[id][0].type+'" disabled /></th></tr>\
<tr><th>Name:</th><th><input  class="form-control" id="scheduleName" value="'+ScheduleData[id][0].name+'"/></th></tr>\
<tr><th>Date Scheduled For:</th><th><input  class="form-control" type="date" id="scheduledDate" value="'+formatDateInput(ScheduleData[id][2])+'"/></th></tr>';

var selectedDropdown=existingTimes;

if(ScheduleData[id][0].time){
selectedDropdown=selectedDropdown.replace('value="'+ScheduleData[id][0].time+'"','value="'+ScheduleData[id][0].time+'" selected');
html+='<tr><th>Time Scheduled For:</th><th><select  class="form-control" type="date" id="scheduledTime">'+selectedDropdown+'</select></th></tr>';
}else{
html+='<tr><th>Time Scheduled For:</th><th><select  class="form-control" type="date" id="scheduledTime">'+selectedDropdown+'</select></th></tr>';
}
html+='</thead></table>';
 html+='<p>'+ScheduleData[id][ScheduleData[id].length-1]+'</p>';
 
 html+='<button type="button" class="btn btn-success"  onclick="SaveScheduleEdit(this)">Save</button><button type="button" class="btn btn-danger" style="margin-left:25px;"  onclick="deleteSchedule(this)">Delete</button>';
$("#EditScheduleView").html(html);
$("#EditScheduleView").html(html);
$("#EditScheduleViewButton").click();
}
function SaveScheduleEdit(){
var today=new Date().getTime();
var obj={
type:'manual',

date:$("#scheduledDate").val(),
time:$("#scheduledTime").val(),
name:$("#scheduleName").val(),
}
var selectedDate=new Date(obj.date).getTime();
if(selectedDate<today){
alert('Invalid Date. Item Can not be scheduled in the Past.');
return;
}
obj.date = new Date(obj.date);
obj.date = obj.date.setUTCHours(0,0,0,0);
google.script.run.withSuccessHandler(refreshScheduleView).editSchedule(obj,ScheduleBeingEdited);

}
function deleteSchedule(){
var text='Are you sure you want to delete this schedule?';
if(confirm(text)){
$("#updating").css("display", "block");
google.script.run.withSuccessHandler(refreshScheduleView).DeleteSchedule(ScheduleBeingEdited);
}
}
function saveBreaks(){
var days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];


var options='{';
for(var i=0;i<days.length;i++){
var status=$("#active"+days[i]).is( ":checked" );

var obj={
shiftTimes:$("#shifts"+days[i]).val(),
breakTimes:$("#breaks"+days[i]).val(),
status:status,
day:days[i],
}
if(status){
options += '"' + days[i] + '":' + JSON.stringify(obj) + ',';
}


}
options += '}';
console.log('options',options);
google.script.run.withSuccessHandler(refreshScheduleView).saveBreaks(options);
}

function getNavBarSchedule(){
var html='';

html+='<nav class="navbar navbar-expand-lg navbar-light">\
  <div class="collapse navbar-collapse" id="navbarSupportedContent">\
    <ul class="navbar-nav mr-auto">\
      <li class="nav-item active">\
        <button type="button" class="btn btn-primary navButton" name="schedulesView"  onclick="navBarEvent(this)">Schedules</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="PrintScheduleView"  onclick="navBarEvent(this)" >Print Schedule</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="BreaksView"  onclick="navBarEvent(this)" >Shifts/Breaks</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="EditScheduleView" id="EditScheduleViewButton" onclick="navBarEvent(this)" >Edit Schedule</button>\
      </li>\
  </div>\
</nav>';

return html;
}

function navBarEvent(event){
var name=$(event).attr('name');
$('.scheduleDivs').hide();
$('#'+name).show();


}

function closemainmodal(){
console.log('here');
//modalclosed = true;
$('#htmlMSGmodal').modal('toggle');
//$('.modal-backdrop').removeClass( "show" );
}


function buildPackagePrint(msg){
var html='<div>\
<h3>Packaging:</h3>\
<p>'+msg+'</p>\
<br/>';

html+='<button type="button" class="btn btn-primary" onclick="printSelectedAdmin()" >Continue</button>';


html+='</div>';
return html;
}

function printSelectedAdmin(){
closemainmodal();
  google.script.run.withSuccessHandler(buildhtmlmodal).printPackagingBatches(SELECTED,true);

}
//END SHCEDULING CODE


function backupAndRestore(){
var password = prompt("Please enter your password:", "");
 google.script.run.withSuccessHandler(verifyUserResult).verifyUser(password,'backupAndRestore');
}

function verifyUserResult(result){
  if(result[0]){
  switch (result[1]){
  case 'backupAndRestore':
   google.script.run.withSuccessHandler(buildhtmlmodal).getFileList();
  break;
  default:
  alert('Success');
  }

  }else{
    alert('Wrong Password');
  }
}


function buildbackupAndRestore(arr){
var html = '';
html+='\
<div id="restoreBody"><h2>Backup and Restore</h2><div><p id="restoreStatus"></p></div><ul id="restoreList" class="list-group">';
for(var i =0;i<arr.length;i++){

html+='<li class="list-group-item" value = "'+arr[i]+'">\
<div class="radio">\
  <label><input style="margin: 0 20px;" type="radio" value="'+arr[i]+'" name="restoreradio">'+formatDateDisplay2(parseInt(arr[i].replace('.gz',''),10))+'</label>\
</div>\
</li>';

}
html+='</ul>\
<button type="button" class="btn btn-primary sarButton" onclick="restoreSelected()" >Restore</button>\
<button type="button" class="btn btn-danger sarButton" onclick="deleteSelected()" >Delete</button>\
<button type="button" class="btn btn-success sarButton" onclick="saveCurrentPoint()" >Save Current</button>\
</div>';
return html;
}


function restoreSelected(){
var name = $('input[name=restoreradio]:checked').val();
console.log('restorename',name);


if (confirm('Restoring to the selected will reset all changes from that point forwards.')) {
$("#updating").css("display", "block");
google.script.run.withSuccessHandler(checkProccessStatus).restorePoint(name);

} 
}


function deleteSelected(){
var name = $('input[name=restoreradio]:checked').val();
console.log('restorename',name);
if (confirm('Are you sure you want to delete this save?')) {
$("#updating").css("display", "block");
google.script.run.withSuccessHandler(saveandrestoremsg).deleteBackup(name);

}

}



function saveCurrentPoint(){
$("#updating").css("display", "block");
alert('Saving');
 google.script.run.withSuccessHandler(saveandrestoremsg).createBackup();
}

function createRestoreSuccess(msg){
$('#restoreStatus').html(msg);
$("#updating").css("display", "none");
}

function saveandrestoremsg(msg){

alert(msg);

google.script.run.withSuccessHandler(buildFileList).getFileList();
}

function buildFileList(rett){
var arr = rett[0];
var html ='';
for(var i =0;i<arr.length;i++){

html+='<li class="list-group-item" value = "'+arr[i]+'">\
<div class="radio">\
  <label><input style="margin: 0 20px;" type="radio" value="'+arr[i]+'" name="restoreradio">'+formatDateDisplay2(parseInt(arr[i].replace('.gz',''),10))+'</label>\
</div>\
</li>';

}
$("#updating").css("display", "none");
$('#restoreList').html(html);

}

function refreshOrders(){
$("#updating").css("display", "block");
google.script.run.withSuccessHandler(refreshOrdersMSG).refreshOrderPC();
}
function refreshOrdersMSG(msg){
alert(msg);
$("#updating").css("display", "none");
}

function getRoundups(){
google.script.run.withSuccessHandler(buildhtmlmodal).getRoundups();

};

function buildRoundups(data){
var html = '';
html+='\
<div style="margin:0 auto; width:500px;"><h2>Round Up Amounts</h2>';
html+='<div  ><p> Regular: <input  class="form-control" id="roundupnic" value="'+data.nic+'"/></p>';
html+='<p> CBD: <input  class="form-control" id="roundupcbd" value="'+data.cbd+'"/></p><div>';
html+='<hr></div>\
<div>\
<button type="button" class="btn btn-success sarButton" onclick="saveRoundups()">Save Current</button>';
return html;
}

function saveRoundups(){
var obj ={
nic:parseInt($("#roundupnic").val(),10),
cbd:parseInt($("#roundupcbd").val(),10),

}
google.script.run.withSuccessHandler(refreshOrdersMSG).updateRoundups(obj);

}

function getglobalFilter(){
google.script.run.withSuccessHandler(buildhtmlmodal).getglobalFilter();

};

function buildglobalFilter(data){
var selectedDropdown  = '';
for(var i = 0; i <7; i++){

selectedDropdown+='<option value="'+i+'"' +(data.months == i ? 'selected' : '' ) + '>';
if(i == 0){
selectedDropdown+='All';
}else if(i==1){
selectedDropdown+='1 Month';
}else{
selectedDropdown+=i+' Months';
}
 
selectedDropdown+='</option>';

}
 
var html = '';
html+='\
<div style="margin:0 auto; width:500px;"><h2>Global Date Filter</h2>';
html+='<div  ><p><select  class="form-control" type="date" id="globalFilterMonths">'+selectedDropdown+'</select></p>';
html+='<hr></div>\
<div>\
<button type="button" class="btn btn-success sarButton" onclick="saveglobalFilter()">Save Current</button>';
return html;
}

function saveglobalFilter(){
var obj ={
months:parseInt($("#globalFilterMonths").val(),10),
 
}
google.script.run.withSuccessHandler(refreshOrdersMSG).updateglobalFilter(obj);

}
</script>